"use strict";Object.defineProperty(exports,"__esModule",{value:true});function _interopDefault(e){return e&&typeof e==="object"&&"default"in e?e["default"]:e}var e=require("react");var t=_interopDefault(e);var r=_interopDefault(require("create-react-context"));var n=_interopDefault(require("warning"));var i=_interopDefault(require("hoist-non-react-statics"));var a=_interopDefault(require("react-fast-compare"));function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){if(t)_defineProperties(e.prototype,t);if(r)_defineProperties(e,r);return e}function _defineProperty(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};var n=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))}n.forEach(function(t){_defineProperty(e,t,r[t])})}return e}function _inherits(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});if(t)_setPrototypeOf(e,t)}function _getPrototypeOf(e){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)};return _getPrototypeOf(e)}function _setPrototypeOf(e,t){_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){e.__proto__=t;return e};return _setPrototypeOf(e,t)}function _objectWithoutPropertiesLoose(e,t){if(e==null)return{};var r={};var n=Object.keys(e);var i,a;for(a=0;a<n.length;a++){i=n[a];if(t.indexOf(i)>=0)continue;r[i]=e[i]}return r}function _objectWithoutProperties(e,t){if(e==null)return{};var r=_objectWithoutPropertiesLoose(e,t);var n,i;if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++){n=a[i];if(t.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(e,n))continue;r[n]=e[n]}}return r}function _assertThisInitialized(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function _possibleConstructorReturn(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}return _assertThisInitialized(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if(Symbol.iterator in Object(e)||Object.prototype.toString.call(e)==="[object Arguments]")return Array.from(e)}function _iterableToArrayLimit(e,t){var r=[];var n=true;var i=false;var a=undefined;try{for(var o=e[Symbol.iterator](),u;!(n=(u=o.next()).done);n=true){r.push(u.value);if(t&&r.length===t)break}}catch(e){i=true;a=e}finally{try{if(!n&&o["return"]!=null)o["return"]()}finally{if(i)throw a}}return r}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var o=r({});var u=Object.getPrototypeOf({});var s=/\s*(?:\]\s*\.|\]\s*\[|\.|\[|\])\s*/g;var l=isUndefined(window)?global:window;function isUndefined(e){return typeof e==="undefined"}function isFunction(e){return typeof e==="function"}function isEmpty(e){return isUndefined(e)||e===null||e+""===""}function isPromise(e){return!!e&&isFunction(e.then)}function isObject(e){return Object.prototype.toString.call(e)==="[object Object]"}function isPlainObj(e){if(!isObject(e))return false;if(null===Object.getPrototypeOf(e))return true;if(!isFunction(e.constructor))return false;return e.constructor.prototype===u}function deepClone(e){if(e&&typeof e==="object"){if(Array.isArray(e)){var t=[];for(var r=0,n=e.length;r<n;r++){t[r]=deepClone(e[r])}return t}else if(isPlainObj(e)){var i={};for(var a in e){i[a]=deepClone(e[a])}return i}}return e}var c=function runCallback(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++){r[n-1]=arguments[n]}if(isFunction(e)){e.apply(void 0,r)}return r[0]};function createHOC(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(isFunction(r[0])){return e.apply(void 0,r)}return function(t){return e(t,r[0])}}}var $=["minlength","maxlength","max","min","required","pattern","step"];function isValidProp(e){return $.indexOf(e.toLowerCase())>-1}var f=function executeWord(e){try{var t=new Function("origin","global","return typeof ".concat(e," === 'number' || (typeof ").concat(e," !== 'undefined' && !(origin in global)) ? ").concat(e," : origin"));return t(e,l)}catch(t){return e}};var d=function parsePath(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}var i=t[0],a=t[1],o=t[2];n(typeof a==="string","The second parameter(".concat(JSON.stringify(a),") of parsePath() must be a string."));var u=(a.match(s)||[]).map(function(e){return e.replace(/\s/g,"")});var l=a.split(s).map(function(e){return e.trim()}).filter(function(e){return e!==""});var c=i;try{if(t.length<3){for(var $=0,d=l.length;$<d;$++){var p=f(l[$]);if($+1===d){return c[p]}if(isUndefined(c[p])){break}c=c[p]}}else{for(var h=0,v=l.length;h<v;h++){var m=f(l[h]);var g=l[h+1];var y=u[h];if(isUndefined(g)){c[m]=o;break}switch(y){case"].":case".":c=isUndefined(c[m])?c[m]={}:c[m];break;case"][":case"[":var F=f(g);c=isUndefined(c[m])?c[m]=typeof F==="number"&&F>=0?[]:{}:c[m];break;default:c[m]=o;break}}}}catch(e){n(false,"The name '%s' of Field seems is not a legal expression.",a)}if(t.length>2){return i}};var p=function arrayFind(e,t){for(var r=0,n=e.length;r<n;r++){if(t(e[r])===true){return e[r]}}};var h=function objectMap(e,t){return Object.keys(e).reduce(function(r,n){r[n]=t(e[n],n,e);return r},{})};var v=function objectEach(e,t){return Object.keys(e).forEach(function(r){return t(e[r],r,e)})};var m=function toObject(e,t){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return e.reduce(function(){t.apply(void 0,arguments);return arguments.length<=0?undefined:arguments[0]},r)};var g=undefined;var y=function CLEAR(e,t,r){v(e,function(t,r){if(t===g){delete e[r]}else if(t&&typeof t==="object"){CLEAR(t,r,e)}});if(r&&Object.keys(e).every(function(t){return e[t]===g})){r[t]=g;CLEAR(r)}};var F=function objectClear(e,t){if(!isUndefined(d(e,t))){d(e,t,g);y(e)}};var b="FORM_VALIDATE_RESULT";var C,_;if(typeof requestAnimationFrame==="function"){C=requestAnimationFrame;_=cancelAnimationFrame}else{C=setTimeout;_=clearTimeout}var E=function(r){_inherits(Form,r);function Form(e){var t;_classCallCheck(this,Form);t=_possibleConstructorReturn(this,_getPrototypeOf(Form).call(this,e));t.$$formPending=void 0;t.$$formValidatePromise=void 0;t.$$registers={};t.$$deepRegisters={};t.$$regDuplications={};t.$$duplicateTimer=void 0;t.$$checkDuplication=function(){var e=_assertThisInitialized(t),r=e.$$regDuplications;var i;v(r,function(e,t){var a=_slicedToArray(e,2),o=a[0],u=a[1];n(o.$$reserved,"The Field with a name '".concat(t,"' has been registered!"));u.$$reset(o.$getState());i=delete r[t]});if(i){t.$render()}};t.$$register=function(e,r,n){t.$$unregister(n,r);if(e){var i=t.$$getRegister(e);if(i){_(t.$$duplicateTimer);t.$$regDuplications[e]=[i,r];t.$$duplicateTimer=C(t.$$checkDuplication)}else{t.$$fieldChangedQueue.push({name:e,$newValue:r.$getState().$value});F(t.$$defaultValues,e)}t.$$registers[r.$name=e]=r;t.createDeepRegisters();t.$render()}};t.$$unregister=function(e,r,n){if(e){if(e in t.$$regDuplications){var i=_slicedToArray(t.$$regDuplications[e],2),a=i[0],o=i[1];t.$$fieldChangedQueue.push({name:e,$newValue:o.$getState().$value,$prevValue:a.$getState().$value});delete t.$$regDuplications[e]}else if(t.$$registers[e]===r){if(n){r.$$reserved=true}else{delete t.$$registers[e];t.$$fieldChangedQueue.push({name:e,$prevValue:r.$getState().$value});F(t.$$defaultValues,e)}}t.createDeepRegisters();t.$render()}};t.$$defaultInitialize=function(){var e=t.props,r=e.$defaultValues,n=e.$defaultStates;t.$$defaultValues=t.$$deepParseObject(deepClone(isFunction(r)?r(t.props)||{}:r));t.$$defaultStates=t.$$deepParseObject(deepClone(isFunction(n)?n(t.props)||{}:n))};t.$$getDefault=function(){return{$$defaultStates:t.$$defaultStates,$$defaultValues:t.$$defaultValues}};t.$$triggerChangeTimer=void 0;t.$$fieldChangedQueue=[];t.$$triggerFormChange=function(){if(t.$$fieldChangedQueue.length){var e=_toConsumableArray(t.$$fieldChangedQueue);t.$$fieldChangedQueue.length=0;var r={};var n={};var i=t.$$registers;var a=false;e.forEach(function(e){if(!(e.name in i)){delete e.$newValue}if(e.$newValue!==e.$prevValue){if("$newValue"in e&&"$prevValue"in e){var o=t.$$getRegister(e.name);if(o){o.$$triggerChange(e)}}"$newValue"in e&&d(r,e.name,e.$newValue);"$prevValue"in e&&d(n,e.name,e.$prevValue);a=true}});if(a){if(isFunction(t.props.$validator)){t.$$formValidate()}if(isFunction(t.props.$onFormChange)){t.props.$onFormChange(t.$formutil,r,n)}}}};t.createDeepRegisters=function(){return t.$$deepRegisters=t.$$deepParseObject(t.$$registers)};t.$$getRegister=function(e){if(e){var r=t.$$registers[e]||d(t.$$deepRegisters,e);if(r){return r}}};t.$$formValidate=function(e){return t.$$formValidatePromise=new Promise(function(r){var n=t.props.$validator;var i;var a;var o;var u;var s=n(t.$formutil.$params,t.formtutil);var l=function execCallback(t){return r(c(e,c(o,t)))};if(isPromise(s)){if(!t.$$formPending){t.$$formPending=true;t.$render()}a=function $shouldCancelPrevAsyncValidate(e){return i=e(l)};u=s.then(function(){return void 0},function(e){return e}).then(function(e){if(i){return i}t.$shouldCancelPrevAsyncValidate=null;t.$$formPending=false;return t.$$setFormErrors(e,l)})}else{if(t.$$formPending){t.$$formPending=false}u=t.$$setFormErrors(s,l)}if(t.$shouldCancelPrevAsyncValidate){t.$shouldCancelPrevAsyncValidate(function(e){o=e;return u})}t.$shouldCancelPrevAsyncValidate=a})};t.$$setFormErrors=function(e,r){if(e&&(e instanceof Error||typeof e!=="object")){n(false,"The result of $validator in <Form /> should always return None(null,undefined) or an object contains error message of Field.");return t.$render(r)}return t.$$setStates(e||{},function(e,t){var r=t.$getState(),n=r.$error,i=n===void 0?{}:n;if(e){return{$error:_objectSpread({},i,_defineProperty({},b,e))}}if(i[b]){delete i[b];return{$error:i}}return},r,true)};t.$getField=function(e){var r=t.$$getRegister(e);n(!e||r,"$getField('".concat(e,"') fail to find the matched Field. Maybe it has been unmounted."));n(e,"You should pass a name of the mounted Field to $getField().");if(r){return r.$new()}};t.$$onChange=function(e,r,n){return t.$setStates(_defineProperty({},e,r),n)};t.$$setStates=function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var r=arguments.length>1?arguments[1]:undefined;var n=arguments.length>2?arguments[2]:undefined;var i=arguments.length>3?arguments[3]:undefined;var a=t.$$deepParseObject(e);var o=false;v(t.$$registers,function(n,u){var s=u in e?e[u]:d(a,u);if(!isUndefined(s)||i){var l=r(s,n);if(l){var c=t.$formutil.$weakParams[u];var $=n.$$merge(l),f=$.$value;n.$$detectChange(l);if("$value"in l||"$viewValue"in l){var h=p(t.$$fieldChangedQueue,function(e){return e.name===u});if(h){if(!("$prevValue"in h)){h.$prevValue=h.$newValue}h.$newValue=f}else{t.$$fieldChangedQueue.push({name:u,$newValue:f,$prevValue:c})}}o=true}}});if(o){return t.$render(n)}return Promise.resolve(c(n,t.$formutil))};t.$render=function(e){return new Promise(function(r){return t.forceUpdate(function(){return r(c(e,t.$formutil))})})};t.$validates=function(){var e;for(var r=arguments.length,n=new Array(r),i=0;i<r;i++){n[i]=arguments[i]}if(isFunction(n[n.length-1])){e=n.pop()}if(n.length){var a=function flatter(e){e.forEach(function(e){if(Array.isArray(e)){flatter(e)}else{var r=t.$getField(e);if(r){r.$validate()}}})};a(n)}else{v(t.$$registers,function(e){return e.$validate()});if(isFunction(t.props.$validator)){t.$$formValidate()}}return t.$onValidates(e)};t.$onValidates=function(e){var r=Object.keys(t.$$registers).map(function(e){return t.$$registers[e].$onValidate()});r.push(t.$$formValidatePromise);return Promise.all(r).then(function(){return c(e,t.$formutil)})};t.$validate=function(e,r){var n=t.$getField(e);if(n){return n.$validate(r)}return c(r)};t.$reset=function(e,r){t.$$defaultInitialize();if(isFunction(e)){r=e;e={}}return t.$$setStates(e,function(e,t){return t.$$reset(e)},r,true)};t.$setStates=function(e,r){return t.$$setStates(e,function(e){return e},r)};t.$setValues=function(e,r){t.$$deepParseObject(deepClone(e),t.$$defaultValues);return t.$$setStates(e,function(e){return{$value:e}},r)};t.$setFocuses=function(e,r){return t.$$setStates(e,function(e){return{$focused:e}},r)};t.$setDirts=function(e,r){return t.$$setStates(e,function(e){return{$dirty:e}},r)};t.$setTouches=function(e,r){return t.$$setStates(e,function(e){return{$touched:e}},r)};t.$setPendings=function(e,r){return t.$$setStates(e,function(e){return{$pending:e}},r)};t.$setErrors=function(e,r){return t.$$setStates(e,function(e){return{$error:e}},r)};t.$batchState=function(e,r){return t.$setStates(h(t.$$registers,function(){return e}),r)};t.$batchDirty=function(e,r){return t.$batchState({$dirty:e},r)};t.$batchTouched=function(e,r){return t.$batchState({$touched:e},r)};t.$batchFocused=function(e,r){return t.$batchState({$focused:e},r)};t.$batchPending=function(e,r){return t.$batchState({$pending:e},r)};t.$batchError=function(e,r){return t.$batchState({$error:e},r)};t.$$defaultInitialize();return t}_createClass(Form,[{key:"getFormContext",value:function getFormContext(){return{$$registers:this.$$registers,$$register:this.$$register,$$unregister:this.$$unregister,$$onChange:this.$$onChange,$$getDefault:this.$$getDefault,$formutil:this.$formutil}}},{key:"$$deepParseObject",value:function $$deepParseObject(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};v(e,function(e,r){return d(t,r,e)});return t}},{key:"componentDidUpdate",value:function componentDidUpdate(){var e=this;_(this.$$triggerChangeTimer);this.$$triggerChangeTimer=C(function(){e.$$triggerFormChange()})}},{key:"_render",value:function _render(){var t=this.$formutil;var r=this.props,n=r.children,i=r.render,a=r.component;if(a){return e.createElement(a,{$formutil:t})}if(isFunction(i)){return i(t)}if(isFunction(n)){return n(t)}return e.Children.map(n,function(r){return r&&isFunction(r.type)?e.cloneElement(r,{$formutil:t}):r})}},{key:"render",value:function render(){var e=this;var r=this.props.$processer;var n=Object.keys(this.$$registers).map(function(t){return{path:t,$state:e.$$registers[t].$getState()}});var i=m(n,function(e,t){var n=t.path,i=t.$state;if(r){r(i,n)}if("$value"in i&&(i.$dirty||!isUndefined(i.$value))){e[n]=i.$value}});var a=m(n,function(e,t){var r=t.path,n=t.$state;return r in i&&d(e,r,i[r])});var u=n.some(function(e){var t=e.$state;return t.$invalid});var s=n.some(function(e){var t=e.$state;return t.$dirty});var l=n.some(function(e){var t=e.$state;return t.$touched});var c=n.some(function(e){var t=e.$state;return t.$focused});var $=this.$$formPending||n.some(function(e){var t=e.$state;return t.$pending});var f=this.$formutil={$$registers:_objectSpread({},this.$$registers),$$deepRegisters:this.$$deepRegisters,$states:m(n,function(e,t){var r=t.path,n=t.$state;return d(e,r,n)}),$params:_objectSpread({},this.$$defaultValues,a),$errors:m(n,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){d(e,r,n.$error)}}),$dirts:m(n,function(e,t){var r=t.path,n=t.$state;return d(e,r,n.$dirty)}),$touches:m(n,function(e,t){var r=t.path,n=t.$state;return d(e,r,n.$touched)}),$focuses:m(n,function(e,t){var r=t.path,n=t.$state;return d(e,r,n.$focused)}),$pendings:m(n,function(e,t){var r=t.path,n=t.$state;return d(e,r,n.$pending)}),$weakStates:m(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n}),$weakParams:i,$weakErrors:m(n,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){e[r]=n.$error}}),$weakDirts:m(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$dirty}),$weakTouches:m(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$touched}),$weakFocuses:m(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$focused}),$weakPendings:m(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$pending}),$getFirstError:function $getFirstError(e){if(e){var t=f.$getField(e);return t&&t.$getFirstError()}for(var r in f.$weakErrors){var n=f.$weakErrors[r];for(var i in n){return n[i]instanceof Error?n[i].message:n[i]}}},$render:this.$render,$getField:this.$getField,$onValidates:this.$onValidates,$new:function $new(){return e.$formutil},$setStates:this.$setStates,$setValues:this.$setValues,$setErrors:this.$setErrors,$setTouches:this.$setTouches,$setDirts:this.$setDirts,$setFocuses:this.$setFocuses,$batchState:this.$batchState,$batchTouched:this.$batchTouched,$batchDirty:this.$batchDirty,$batchFocused:this.$batchFocused,$reset:this.$reset,$validates:this.$validates,$validate:this.$validate,$valid:!u,$invalid:u,$dirty:s,$pristine:!s,$touched:l,$untouched:!l,$focused:c,$pending:$};return t.createElement(o.Provider,{value:this.getFormContext()},this._render())}}]);return Form}(e.Component);E.displayName="React.Formutil.Form";E.defaultProps={$defaultValues:{},$defaultStates:{}};function withForm(r){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=function(e){_inherits(FormEnhanced,e);function FormEnhanced(){_classCallCheck(this,FormEnhanced);return _possibleConstructorReturn(this,_getPrototypeOf(FormEnhanced).apply(this,arguments))}_createClass(FormEnhanced,[{key:"render",value:function render(){var e=Object.assign({},this.props);var i=this.props,a=i.component,o=_objectWithoutProperties(i,["component"]);["$defaultStates","$defaultValues","$onFormChange","$validator","$processer"].forEach(function(t){if(t in e){if(t==="$defaultStates"||t==="$defaultValues"){o[t]=_objectSpread({},n[t],e[t])}delete e[t]}});return t.createElement(E,Object.assign({},n,o,{render:function render(n){return t.createElement(r,Object.assign({},e,{$formutil:n}))}}))}}]);return FormEnhanced}(e.Component);a.displayName="React.Formutil.withForm."+(r.displayName||r.name||"Anonymous");return i(a,r)}var P=createHOC(withForm);var V=0;var O={$valid:true,$invalid:false,$dirty:false,$pristine:true,$touched:false,$untouched:true,$focused:false,$pending:false,$error:{}};function isError(e){return e!==true}function warningValidatorReturn(e,t,r){n(!isUndefined(e),"You should return a string or Error when the validation('".concat(r&&r+": ").concat(t,"') failed, otherwise return true."))}var w="React.Formutil.Field";function GET_FIELD_UUID(){return V++}function renderField(t,r){var n=r.children,i=r.render,a=r.component;if(a){return e.createElement(a,{$fieldutil:t})}if(isFunction(i)){return i(t)}if(isFunction(n)){return n(t)}return e.Children.map(n,function(r){return r&&isFunction(r.type)?e.cloneElement(r,{$fieldutil:t}):r})}function createHandler(e,t){var r={$$FIELD_UUID:e.$$FIELD_UUID,$$reset:$$reset,$$merge:$$merge,$$detectChange:$$detectChange,$$triggerChange:$$triggerChange,$onValidate:$onValidate,$new:function $new(){return e.$fieldutil},$picker:$getState,$getState:$getState,$getComponent:function $getComponent(){return t},$reset:function $reset(t,r){return e.$setState($$reset(t),r)},$getFirstError:$getFirstError,$validate:$validate,$setState:e.$setState,$render:$render,$setValue:$setValue,$setTouched:$setTouched,$setDirty:$setDirty,$setFocused:$setFocused,$setValidity:$setValidity,$setError:$setError,$setPending:$setPending};var n;function $$detectChange(e){if("$value"in e||"$viewValue"in e){$validate()}}function $$triggerChange(t){var r=t.$newValue,n=t.$prevValue;var i=e.props.$onFieldChange;if(isFunction(i)){i(r,n,e.$formContext.$formutil)}}function $onValidate(e){n.then(e);return n}function $$reset(t){var r;var n=e.props,i=e.$formContext;if(i.$$getDefault){var a=n.name;var o=i.$$getDefault(),u=o.$$defaultStates,s=o.$$defaultValues;if(a&&s){var l=d(s,a);r=d(u,a)||{};if(!isUndefined(l)){r.$value=l}}}var c=n.$defaultValue,$=n.$defaultState;return $$merge(_objectSpread({},O,isFunction($)?$(n):$,{$value:isFunction(c)?c(n):"$defaultValue"in n?c:""},r,t))}function $getState(){return _objectSpread({},e.$state)}function $validate(t){return n=new Promise(function(r){var n=e.props,i=e.$formContext;var a=_objectSpread({},n.$validators,n.$asyncValidators);var o=e.$state,u=o.$value,s=o.$pending,l=Object.assign({},o.$error);var $=i.$formutil;var f={};var d=false;var p;var h;var v;var m;delete l[b];var g=Object.keys(a).reduce(function(t,r){delete l[r];if(!d&&n[r]!=null){var i=a[r](u,n[r],_objectSpread({},n,{$formutil:$,$fieldutil:e.$fieldutil,$validError:f}));if(isPromise(i)){t.push(i.catch(function(e){if(!p){$setValidity(r,e||r)}}))}else if(isError(i)){f[r]=i||r;warningValidatorReturn(i,r,n.name);if(n.$validateLazy){d=true}}}return t},[]);var y=function execCallback(e){return r(c(t,c(v,e)))};if(g.length){if(!s){$setPending(true)}h=function $shouldCancelPrevAsyncValidate(e){return p=e(y)};g.push($setError(_objectSpread({},l,f)));m=Promise.all(g).then(function(){if(p){return p}e.$shouldCancelPrevAsyncValidate=null;return $setPending(false,y)})}else{if(s){$setPending(false)}m=$setError(_objectSpread({},l,f),y)}if(e.$shouldCancelPrevAsyncValidate){e.$shouldCancelPrevAsyncValidate(function(e){v=e;return m})}e.$shouldCancelPrevAsyncValidate=h})}function $render(t,r){return e.$setState({$viewValue:t,$dirty:true},r)}function $setValue(t,r){return e.$setState({$value:t},r)}function $setTouched(t,r){return e.$setState({$touched:t},r)}function $setDirty(t,r){return e.$setState({$dirty:t},r)}function $setFocused(t,r){return e.$setState({$focused:t},r)}function $setError(t,r){return e.$setState({$error:t},r)}function $setValidity(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var n=arguments.length>2?arguments[2]:undefined;var i=Object.assign({},e.$state.$error);if(isError(r)){i[t]=r||t;warningValidatorReturn(r,t,e.props.name)}else{delete i[t]}return $setError(i,n)}function $setPending(t,r){return e.$setState({$pending:t},r)}function $getFirstError(){var t=e.$state.$error,r=t===void 0?{}:t;for(var n in r){return r[n]instanceof Error?r[n].message:r[n]}}function $$merge(t){var r=Object.assign({},t);if("$error"in r){if(!r.$error){r.$error={}}r.$valid=Object.keys(r.$error).length===0}var n=e.props,i=n.$parser,a=n.$formatter;if("$viewValue"in r&&!("$value"in r)){var o=function $setViewValue(e){return r.$viewValue=e};r.$value=i?i(r.$viewValue,o):r.$viewValue}else if("$value"in r&&!("$viewValue"in r)){var u=function $setModelValue(e){return r.$value=e};r.$viewValue=a?a(r.$value,u):r.$value}if("$valid"in r){r.$invalid=!r.$valid}else if("$invalid"in r){r.$dirty=!r.$invalid}if("$dirty"in r){r.$pristine=!r.$dirty}else if("$pristine"in r){r.$dirty=!r.$pristine}if("$touched"in r){r.$untouched=!r.$touched}else if("$untouched"in r){r.$touched=!r.$untouched}e.$state=_objectSpread({},e.$state,r);return $getState()}return r}var k=function(e){_inherits(Field,e);function Field(){var e;var t;_classCallCheck(this,Field);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++){n[i]=arguments[i]}t=_possibleConstructorReturn(this,(e=_getPrototypeOf(Field)).call.apply(e,[this].concat(n)));t.$$FIELD_UUID=GET_FIELD_UUID();t.$formContext=void 0;t.$state=void 0;t.$setState=function(e,r){return new Promise(function(n){var i=function execute(){return n(c(r,t.$fieldutil))};if(t.isMounting){var a=t.props.name;if(a in(t.$formContext.$$registers||{})){t.$formContext.$$onChange(a,e,i)}else{t.$registered.$$merge(e);t.$registered.$$detectChange(e);t.forceUpdate(i)}}else{t.$registered.$$merge(e);i()}})};return t}_createClass(Field,[{key:"componentDidMount",value:function componentDidMount(){this.isMounting=true;var e=this.props.name,t=this.$formContext;n(!e||t.$formutil,"You should enusre that the <Field /> with the name '".concat(e,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));n(e,"You should assign a name to <Field />, otherwise it will be isolated!");if(t.$$register){t.$$register(e,this.$fieldHandler)}this.$prevValue=this.$state.$value}},{key:"componentWillUnmount",value:function componentWillUnmount(){if(this.$formContext.$$unregister){this.$formContext.$$unregister(this.props.name,this.$fieldHandler,this.props.$reserveOnUnmount)}this.isMounting=false}},{key:"componentDidUpdate",value:function componentDidUpdate(e){var t=this.props.name;if(t!==e.name){if(this.$formContext.$$register){this.$formContext.$$register(t,this.$fieldHandler,e.name)}}if(this.$state.$value!==this.$prevValue){if(!(t in(this.$formContext.$$registers||{}))){this.$registered.$$triggerChange({$newValue:this.$state.$value,$prevValue:this.$prevValue})}this.$prevValue=this.$state.$value}}},{key:"_render",value:function _render(){var e=this.$fieldutil=_objectSpread({$name:this.props.name},this.$registered.$getState(),this.$registered,{$$formutil:this.$formContext.$formutil});return renderField(e,this.props)}},{key:"render",value:function render(){var e=this;var r=!this.$formContext;return t.createElement(o.Consumer,null,function(t){e.$formContext=t;if(!e.$fieldHandler){e.$fieldHandler=createHandler(e,e)}e.$registered=(t.$$registers||{})[e.$fieldHandler.$name]||e.$fieldHandler;if(r){e.$fieldHandler.$$reset();e.$fieldHandler.$validate()}return e._render()})}}]);return Field}(e.Component);k.displayName=w;function withField(r){var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=function(e){_inherits(FieldEnhanced,e);function FieldEnhanced(){_classCallCheck(this,FieldEnhanced);return _possibleConstructorReturn(this,_getPrototypeOf(FieldEnhanced).apply(this,arguments))}_createClass(FieldEnhanced,[{key:"render",value:function render(){var e=Object.assign({},this.props);var i=this.props,a=i.component,o=_objectWithoutProperties(i,["component"]);["$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$defaultValue","$defaultState","$onFieldChange","$parser","$formatter","name"].concat(Object.keys(_objectSpread({},n.$validators,n.$asyncValidators,e.$validators,e.$asyncValidators))).forEach(function(t){if(t in e){if(t==="$validators"||t==="$asyncValidators"||t==="$defaultState"){o[t]=_objectSpread({},n[t],e[t])}delete e[t]}});return t.createElement(k,Object.assign({},n,o,{render:function render(n){return t.createElement(r,Object.assign({},e,{$fieldutil:n}))}}))}}]);return FieldEnhanced}(e.Component);a.displayName="React.Formutil.withField."+(r.displayName||r.name||"Anonymous");return i(a,r)}var S=createHOC(withField);var j=function(e){_inherits(EasyFieldNative,e);function EasyFieldNative(){_classCallCheck(this,EasyFieldNative);return _possibleConstructorReturn(this,_getPrototypeOf(EasyFieldNative).apply(this,arguments))}_createClass(EasyFieldNative,[{key:"render",value:function render(){var e=this;var r=this.props,n=r.$fieldutil,i=r.value,a=r.onChange,o=r.onFocus,u=r.onBlur,s=r.checked,l=r.unchecked,c=_objectWithoutProperties(r,["$fieldutil","value","onChange","onFocus","onBlur","checked","unchecked"]);var $=this.props.type;var f={value:"compositionValue"in this?this.compositionValue:i,onCompositionEnd:function onCompositionEnd(t){e.composition=false;delete e.compositionValue;f.onChange(t)},onCompositionStart:function onCompositionStart(){return e.composition=true},onChange:function onChange(t){var r=t.target.value;if(e.composition){e.compositionValue=r;e.forceUpdate()}else{a(r,t)}},onFocus:o,onBlur:u};var d="input";switch($){case"select":d=$;f.onChange=function(e){var t=e.target;var r=t.multiple?[].slice.call(t.options).filter(function(e){return e.selected}).map(function(e){return e.value}):t.value;a(r,e)};delete c.type;break;case"textarea":d=$;delete c.type;break;case"checkbox":case"radio":f={checked:i===s,onChange:function onChange(e){a(e.target.checked?s:l,e)},onFocus:o,onBlur:u};break;default:break}return t.createElement(d,Object.assign({},c,f))}}]);return EasyFieldNative}(e.Component);j.displayName="React.Formutil.EasyField.Native";j.defaultProps={value:"",type:"text",checked:true,unchecked:false};var D=r({}),x=D.Provider,A=D.Consumer;var U=function(r){_inherits(EasyFieldGroup,r);function EasyFieldGroup(){_classCallCheck(this,EasyFieldGroup);return _possibleConstructorReturn(this,_getPrototypeOf(EasyFieldGroup).apply(this,arguments))}_createClass(EasyFieldGroup,[{key:"getGroupContext",value:function getGroupContext(){return this.props}},{key:"_render",value:function _render(){var r=this.props,n=r.className,i=r.groupNode,a=r.children;var o={GroupOption:T,Field:R};var u=isFunction(a)?a(o):e.Children.map(a,function(t){return e.cloneElement(t,o)});if(i===null){return u}return t.createElement(i,{className:n},u)}},{key:"render",value:function render(){return t.createElement(x,{value:this.getGroupContext()},this._render())}}]);return EasyFieldGroup}(e.Component);U.displayName="React.Formutil.EasyField.Group";U.defaultProps={type:"checkbox",groupNode:"div"};var T=function(e){_inherits(EasyFieldGroupOption,e);function EasyFieldGroupOption(){_classCallCheck(this,EasyFieldGroupOption);return _possibleConstructorReturn(this,_getPrototypeOf(EasyFieldGroupOption).apply(this,arguments))}_createClass(EasyFieldGroupOption,[{key:"componentDidMount",value:function componentDidMount(){n("$value"in this.props,"You should pass a $value to <GroupOption />.")}},{key:"render",value:function render(){var e=this.props,r=e.$value,n=e.onChange,i=e.onFocus,a=e.onBlur,o=_objectWithoutProperties(e,["$value","onChange","onFocus","onBlur"]);return t.createElement(A,null,function(e){var u=e.type,s=e.name;var l=u==="radio"?{checked:e.value===r,onChange:function onChange(t){e.onChange(r,t);n&&n(t)}}:u==="checkbox"?{checked:e.value.indexOf(r)>-1,onChange:function onChange(t){e.onChange(t.target.checked?e.value.concat(r):e.value.filter(function(e){return e!==r}),t);n&&n(t)}}:{value:e.value,onChange:function onChange(t){e.onChange(t);n&&n(t)}};return t.createElement("input",Object.assign({name:s},o,l,{type:u,onFocus:function onFocus(t){e.onFocus(t);i&&i(t)},onBlur:function onBlur(t){e.onBlur(t);a&&a(t)}}))})}}]);return EasyFieldGroupOption}(e.Component);T.displayName="React.Formutil.EasyField.Group.Option";var R=function(e){_inherits(DeprecatedEasyFieldGroupOption,e);function DeprecatedEasyFieldGroupOption(){_classCallCheck(this,DeprecatedEasyFieldGroupOption);return _possibleConstructorReturn(this,_getPrototypeOf(DeprecatedEasyFieldGroupOption).apply(this,arguments))}_createClass(DeprecatedEasyFieldGroupOption,[{key:"componentDidMount",value:function componentDidMount(){n(false,'The "Field" property in EasyField\'s children-props has been deprecated. Please use "GroupOption" instead.')}},{key:"render",value:function render(){return t.createElement(T,this.props)}}]);return DeprecatedEasyFieldGroupOption}(e.Component);R.displayName="React.Formutil.EasyField.Group.Option.Deprecated";var N=t.Frament||"div";var I=function(e){_inherits(EasyFieldList,e);function EasyFieldList(e){var t;_classCallCheck(this,EasyFieldList);t=_possibleConstructorReturn(this,_getPrototypeOf(EasyFieldList).call(this,e));t.id=0;t.latestValue=t.props.value;t.$formutil=void 0;t.FieldValidators={required:function required(e){return e!==null}};t.$onFormChange=function(e){e.$onValidates(function(e){var r=e.$invalid,n=e.$params;if(r){if(t.props.value.length){t.props.onChange(t.latestValue=[])}}else if(!a(t.props.value,n.list)){t.props.onChange(t.latestValue=n.list)}})};t.swap=function(e,r,n){return t.$setState(function(t){var n=t.items;var i=[n[e],n[r]];n[r]=i[0];n[e]=i[1];return n},n)};t.insert=function(){var e,r,n;for(var i=arguments.length,a=new Array(i),o=0;o<i;o++){a[o]=arguments[o]}a.forEach(function(t){if(isFunction(t)){n=t}else if(typeof t==="number"){e=t}else if(typeof t==="object"){r=t}});return t.$setState(function(n){var i=n.items;if(isUndefined(e)){i.push(t.getId(r))}else{i.splice(e,0,t.getId(r))}return{items:i}},n)};t.remove=function(){var e,r;for(var n=arguments.length,i=new Array(n),a=0;a<n;a++){i[a]=arguments[a]}i.forEach(function(t){if(isFunction(t)){r=t}else if(typeof t==="number"){e=t}});return t.$setState(function(r){var n=r.items;if(isUndefined(e)){n.pop()}else{n.splice(e,1)}if(!n.length){n=[t.getId()]}return{items:n}},r)};t.$setState=function(e,r){return new Promise(function(n){return t.setState(e,function(){return t.$formutil.$onValidates(function(e){return n(c(r,e))})})})};t.state={items:e.value.length?e.value.map(function(){return t.getId()}):[t.getId()],formKey:0};return t}_createClass(EasyFieldList,[{key:"componentDidUpdate",value:function componentDidUpdate(e){var t=this;if(this.props.value!==this.latestValue){this.setState({items:this.props.value.length?this.props.value.map(function(){return t.getId()}):[this.getId()],formKey:this.state.formKey+1});this.latestValue=this.props.value}}},{key:"getId",value:function getId(e){return{id:this.id++,values:e}}},{key:"render",value:function render(){var e=this;var r=this.props,n=r.children,i=r.onFocus,o=r.onBlur,u=r.value;if(!isFunction(n)){return null}var s={$length:this.state.items.length,$insert:this.insert,$remove:this.remove,$swap:this.swap,$push:function $push(t,r){return e.insert(t,r)},$pop:function $pop(t){return e.remove(t)},$shift:function $shift(t){return e.remove(0,t)},$unshift:function $unshift(t,r){return e.insert(0,t,r)},onFocus:i,onBlur:o};return t.createElement(E,{key:this.state.formKey,$defaultValues:{list:u},$onFormChange:this.$onFormChange,children:function children(r){e.$formutil=r;return t.createElement(N,null,e.state.items.map(function(i,o){var u=i.id,l=i.values;return t.createElement(k,{key:u,required:true,$defaultValue:l||null,$validators:e.FieldValidators,name:"list[".concat(o,"]"),children:function children(i){return t.createElement(E,{$defaultValues:i.$value||{},$onFormChange:function $onFormChange(e){return e.$onValidates(function(e){var t=e.$invalid,r=e.$params;if(t){if(i.$viewValue!==null){i.$render(null)}}else if(!a(i.$viewValue,r)){i.$render(r)}})},children:function children(t){return n(_objectSpread({},s,t,{$index:o,$isLast:function $isLast(){return o===e.state.items.length-1},$isFirst:function $isFirst(){return o===0}}),r)}})}})}))}})}}]);return EasyFieldList}(e.Component);I.displayName="React.Formutil.EasyField.List";var H="__TYPE__";var L=[["required",function(e,t,r){var n=r.__TYPE__,i=r.checked,a=i===void 0?true:i;return n==="checked"?e===a:!isEmpty(e)}],["maxLength",function(e,t){return isEmpty(e)||e.length<=t}],["minLength",function(e,t){return isEmpty(e)||e.length>=t}],["max",function(e,t){return isEmpty(e)||e*1<=t}],["min",function(e,t){return isEmpty(e)||e*1>=t}],["pattern",function(e,t){return isEmpty(e)||t.test(e)}],["enum",function(e,t){return isEmpty(e)||t.indexOf(e)>-1}],["checker",function(e,t,r){return t(e,r)}]].reduce(function(e,t){var r=_slicedToArray(t,2),n=r[0],i=r[1];e[n]=function validator(e,t,r){var a=r.validMessage,o=a===void 0?{}:a;return i.apply(void 0,arguments)||o[n]||"Error input: ".concat(n)};return e},{});var G="React.Formutil.EasyField";var M={validMessage:{},valuePropName:"value",changePropName:"onChange",focusPropName:"onFocus",blurPropName:"onBlur",$parser:function $parser(e){return typeof e==="string"?e.trim():e}};function createHandler$1(e,t,r){var n;var i=t.valuePropName,a=t.changePropName,o=t.focusPropName,u=t.blurPropName,s=t.passUtil;var l=function fetchValueFromEvent(e){return e&&e.target?e.target[i]:e};var c=_objectSpread({},r,(n={},_defineProperty(n,i,e.$viewValue),_defineProperty(n,a,function(){for(var r=arguments.length,n=new Array(r),i=0;i<r;i++){n[i]=arguments[i]}var o=n[0];var u=n[n.length-1];if(!u||!u.target){u=n}else{u=[u]}var s=t[a];s&&s.apply(void 0,_toConsumableArray(u));var c=l(o);e.$render(c)}),_defineProperty(n,o,function(){var r=t[o];r&&r.apply(void 0,arguments);e.$setFocused(true)}),_defineProperty(n,u,function(){var r=t[u];r&&r.apply(void 0,arguments);if(e.$untouched){e.$setTouched(true)}e.$setFocused(false)}),n));if(s){c[s===true?"$fieldutil":s]=e}return c}function parseProps(e){var t=e.children,r=e.component,n=e.render,i=_objectWithoutProperties(e,["children","component","render"]);var a=i.name,o=i.type,u=i.defaultValue,s=i.valuePropName,l=i.changePropName,c=i.focusPropName,$=i.blurPropName,f=i.validMessage,d=i.__TYPE__,p=i.passUtil,h=i.$defaultValue,v=i.$defaultState,m=i.$onFieldChange,g=i.$validators,y=i.$asyncValidators,F=i.$validateLazy,b=i.$reserveOnUnmount,C=i.$parser,_=i.$formatter,E=_objectWithoutProperties(i,["name","type","defaultValue","valuePropName","changePropName","focusPropName","blurPropName","validMessage","__TYPE__","passUtil","$defaultValue","$defaultState","$onFieldChange","$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$parser","$formatter"]);var P={children:t,component:r,render:n};var V=!isUndefined(o)||isUndefined(t)&&isUndefined(r)&&isUndefined(n);Object.keys(_objectSpread({},i.$validators=_objectSpread({},L,i.$validators),i.$asyncValidators)).forEach(function(e){if(e in E){if(!V||!isValidProp(e)){delete E[e]}}});if(V){var O=(o||"").split("."),w=_slicedToArray(O,2),k=w[0],S=k===void 0?"text":k,D=w[1];P.component=S==="group"?U:S==="list"?I:j;if(a){E.name=a}if(o){E.type=S}if(t){E.children=t}switch(S){case"select":case"textarea":if(e.multiple){i[H]="array"}break;case"group":if(D==="checkbox"){i[H]="array"}E.type=D;break;case"checkbox":case"radio":i[H]="checked";break;case"list":i[H]="array";break;default:break}}if(!("$defaultValue"in i)&&"defaultValue"in e){i.$defaultValue=u}if(!("$defaultValue"in i)&&H in i){var x;switch(i[H]){case"checked":var A=i.unchecked,T=A===void 0?false:A;x=T;break;case"array":x=[];break;case"object":x={};break;case"number":x=0;break;case"empty":default:break}i.$defaultValue=x}return{fieldProps:i,childProps:E,renderProps:P}}function renderField$1(t,r){var n=r.component,i=r.render,a=r.children;if(n){return e.createElement(n,t)}if(isFunction(i)){return i(t)}if(isFunction(a)){return a(t)}return e.Children.map(a,function(r){return e.cloneElement(r,t)})}var W=function(e){_inherits(EasyField,e);function EasyField(){_classCallCheck(this,EasyField);return _possibleConstructorReturn(this,_getPrototypeOf(EasyField).apply(this,arguments))}_createClass(EasyField,[{key:"render",value:function render(){var e=parseProps(this.props),r=e.fieldProps,n=e.childProps,i=e.renderProps;return t.createElement(k,Object.assign({},r,{children:function children(e){return renderField$1(createHandler$1(e,r,n),i)}}))}}]);return EasyField}(e.Component);W.displayName=G;W.defaultProps=M;function connect(r){var n=function(e){_inherits(Connect,e);function Connect(){_classCallCheck(this,Connect);return _possibleConstructorReturn(this,_getPrototypeOf(Connect).apply(this,arguments))}_createClass(Connect,[{key:"render",value:function render(){var e=this;return t.createElement(o.Consumer,null,function(n){return t.createElement(r,Object.assign({},e.props,{$formutil:n.$formutil}))})}}]);return Connect}(e.Component);n.displayName="React.Formutil.connect."+(r.displayName||r.name||"Anonymous");return i(n,r)}function useFormContext(){if(!t.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var e=t.useContext;var r=e(o);return r}function useField(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!t.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var i=t.useState,a=t.useLayoutEffect,o=t.useRef;var u;if(e){if(typeof e==="string"){u=e;r.name=u}else{r=e;u=r.name}}var s=useFormContext();var l=o({}).current;var $=o([]);var f;l.$formContext=s;l.props=r;l.$setState=$setState;var d=i(function(){l.$$FIELD_UUID=GET_FIELD_UUID();l.$fieldHandler=f=createHandler(l);var e=l.$fieldHandler.$$reset();l.$fieldHandler.$validate();return e}),p=_slicedToArray(d,2),h=p[1];if(!f){f=(s.$$registers||{})[l.$fieldHandler.$name]||l.$fieldHandler}a(function(){var e=l.$state;if(l.isMounting){if(!(u in(s.$$registers||{}))){var t=l.$prevValue;f.$$triggerChange({$newValue:e.$value,$prevValue:t})}}l.$prevValue=e.$value},[l.$state.$value]);a(function(){l.isMounting=true;n(!u||s.$formutil,"You should enusre that the useField() with the name '".concat(u,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));n(u,"You should pass a name argument to useField(), otherwise it will be isolated!");return function(){if(s.$$unregister){s.$$unregister(u,l.$fieldHandler,r.$reserveOnUnmount)}l.isMounting=false}},[]);a(function(){if(s.$$register){s.$$register(u,l.$fieldHandler,l.$prevName)}l.$prevName=u},[u]);a(function(){if($.current.length>0){var e=_toConsumableArray($.current);$.current.length=0;while(e.length){e.pop()(l.$fieldutil)}}});function $setState(e,t){return new Promise(function(r){var n=function execute(){return r(c(t,l.$fieldutil))};if(l.isMounting){if(u in(s.$$registers||{})){s.$$onChange(u,e,n)}else{h(f.$$merge(e));f.$$detectChange(e);$.current.push(n)}}else{f.$$merge(e);n()}})}return l.$fieldutil=_objectSpread({$name:u},f.$getState(),f,{$$formutil:s.$formutil})}function useForm(){var e=useFormContext(),t=e.$formutil;return t}function useHandler(e){e=_objectSpread({},M,e,{children:null});var t=parseProps(e),r=t.fieldProps,n=t.childProps;var i=useField(r);return createHandler$1(i,r,n)}exports.EasyField=W;exports.Field=k;exports.Form=E;exports.connect=connect;exports.useField=useField;exports.useForm=useForm;exports.useHandler=useHandler;exports.withField=S;exports.withForm=P;
