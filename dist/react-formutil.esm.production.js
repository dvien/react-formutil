import e from"@babel/runtime/helpers/esm/defineProperty";import t from"@babel/runtime/helpers/esm/objectSpread2";import r from"@babel/runtime/helpers/esm/toConsumableArray";import n from"@babel/runtime/helpers/esm/slicedToArray";import i from"@babel/runtime/helpers/esm/classCallCheck";import a from"@babel/runtime/helpers/esm/createClass";import u from"@babel/runtime/helpers/esm/possibleConstructorReturn";import o from"@babel/runtime/helpers/esm/getPrototypeOf";import s from"@babel/runtime/helpers/esm/assertThisInitialized";import $ from"@babel/runtime/helpers/esm/inherits";import l,{createContext as f,createElement as c,Children as d,cloneElement as v,Component as h,forwardRef as p}from"react";import{isValidElementType as m}from"react-is";import g from"warning";import y from"@babel/runtime/helpers/esm/objectWithoutProperties";import b from"hoist-non-react-statics";import"prop-types";import V from"react-fast-compare";var F=f({});var C=Object.getPrototypeOf({});var k=/\s*(?:\]\s*\.|\]\s*\[|\.|\[|\])\s*/g;var w=P(window)?global:window;function P(e){return typeof e==="undefined"}function E(e){return typeof e==="function"}function S(e){return P(e)||e===null||e+""===""}function O(e){return!!e&&E(e.then)}function j(e){return Object.prototype.toString.call(e)==="[object Object]"}function x(e){if(!j(e))return false;if(null===Object.getPrototypeOf(e))return true;if(!E(e.constructor))return false;return e.constructor.prototype===C}function D(e){return m(e)&&typeof e!=="string"}function N(e){if(Array.isArray(e)){var t=[];for(var r=0,n=e.length;r<n;r++){t[r]=N(e[r])}return t}else if(x(e)){var i={};for(var a in e){if(e.hasOwnProperty(a))i[a]=N(e[a])}return i}return e}var A=function e(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++){n[i-1]=arguments[i]}if(E(t)){t.apply(void 0,n)}return n[0]};function T(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(D(r[0])){return e.apply(void 0,r)}return function(t){return e(t,r[0])}}}var _=["minlength","maxlength","max","min","required","pattern","step"];function R(e){return _.indexOf(e.toLowerCase())>-1}var U=function e(t){try{var r=new Function("origin","global","return typeof ".concat(t," === 'number' || (typeof ").concat(t," !== 'undefined' && !(origin in global)) ? ").concat(t," : origin"));return r(t,w)}catch(e){return t}};function I(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}var n=t[0],i=t[1],a=t[2];g(typeof i==="string","The second parameter(".concat(JSON.stringify(i),") of parsePath() must be a string."));var u=(i.match(k)||[]).map(function(e){return e.replace(/\s/g,"")});var o=i.split(k).map(function(e){return e.trim()}).filter(function(e){return e!==""});var s=n;try{if(t.length<3){for(var $=0,l=o.length;$<l;$++){var f=U(o[$]);if($+1===l){return s[f]}if(P(s[f])){break}s=s[f]}}else{for(var c=0,d=o.length;c<d;c++){var v=U(o[c]);var h=o[c+1];var p=u[c];if(P(h)){s[v]=a;break}switch(p){case"].":case".":s=P(s[v])?s[v]={}:s[v];break;case"][":case"[":var m=U(h);s=P(s[v])?s[v]=typeof m==="number"&&m>=0?[]:{}:s[v];break;default:s[v]=a;break}}}}catch(e){g(false,"The name '%s' of Field seems is not a legal expression.",i)}if(t.length>2){return n}}function H(e,t){var r=t.split(k).map(function(e){return e.trim()}).filter(function(e){return e!==""});for(var n=0,i=r.length;n<i;n++){var a=U(r[n]);if(!(a in e)){break}if(n+1===i){return{data:e[a]}}e=e[a]}}function M(e,t){if(e){if(E(e)){e(t)}else if("current"in e){e.current=t}}}var L=function e(t,r){for(var n=0,i=t.length;n<i;n++){if(r(t[n])===true){return t[n]}}};var B=function e(t,r){return Object.keys(t).reduce(function(e,n){e[n]=r(t[n],n,t);return e},{})};var Y=function e(t,r){return Object.keys(t).forEach(function(e){return r(t[e],e,t)})};var Q=function e(t,r){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return t.reduce(function(){r.apply(void 0,arguments);return arguments.length<=0?undefined:arguments[0]},n)};var z=undefined;function G(e,t,r){Y(e,function(t,r){if(t===z){delete e[r]}else if(x(t)||Array.isArray(t)){G(t,r,e)}});if(r&&Object.keys(e).every(function(t){return e[t]===z})){r[t]=z;G(r)}}var q=function e(t,r){if(!P(I(t,r))){I(t,r,z);G(t)}};var K="FORM_VALIDATE_RESULT";var W,J;if(typeof requestAnimationFrame==="function"){W=requestAnimationFrame;J=cancelAnimationFrame}else{W=setTimeout;J=clearTimeout}var X=function(f){$(h,f);function h(a){var $;i(this,h);$=u(this,o(h).call(this,a));$.$$formPending=void 0;$.$$formValidatePromise=void 0;$.$$registers={};$.$$deepRegisters={};$.$$regDuplications={};$.$$duplicateTimer=void 0;$.$$checkDuplication=function(){var e=s($),t=e.$$regDuplications;var r;Y(t,function(e,i){var a=n(e,2),u=a[0],o=a[1];g(u.$$reserved,"The Field with a name '".concat(i,"' has been registered!"));o.$$reset(u.$getState());r=delete t[i]});if(r){$.$render()}};$.$$register=function(e,t,r){$.$$unregister(r,t);if(e){var n=$.$$getRegister(e);if(n){J($.$$duplicateTimer);$.$$regDuplications[e]=[n,t];$.$$duplicateTimer=W($.$$checkDuplication)}else{$.$$fieldChangedQueue.push({name:e,$newValue:t.$getState().$value});q($.$$defaultValues,e)}$.$$registers[t.$name=e]=t;$.createDeepRegisters();$.$render()}};$.$$unregister=function(e,t,r){if(e){if(e in $.$$regDuplications){var i=n($.$$regDuplications[e],2),a=i[0],u=i[1];$.$$fieldChangedQueue.push({name:e,$newValue:u.$getState().$value,$prevValue:a.$getState().$value});delete $.$$regDuplications[e]}else if($.$$registers[e]===t){if(r){t.$$reserved=true}else{delete $.$$registers[e];$.$$fieldChangedQueue.push({name:e,$prevValue:t.$getState().$value});q($.$$defaultValues,e)}}$.createDeepRegisters();$.$render()}};$.$$defaultInitialize=function(){var e=$.props,t=e.$defaultValues,r=e.$defaultStates;$.$$defaultValues=$.$$deepParseObject(N(E(t)?t($.props)||{}:t));$.$$defaultStates=$.$$deepParseObject(N(E(r)?r($.props)||{}:r))};$.$$getDefault=function(){return{$$defaultStates:$.$$defaultStates,$$defaultValues:$.$$defaultValues}};$.$$triggerChangeTimer=void 0;$.$$fieldChangedQueue=[];$.$$triggerFormChange=function(){if($.$$fieldChangedQueue.length){var e=r($.$$fieldChangedQueue);$.$$fieldChangedQueue.length=0;var t={};var n={};var i=$.$$registers;var a=false;e.forEach(function(e){if(!(e.name in i)){delete e.$newValue}if(e.$newValue!==e.$prevValue){if("$newValue"in e&&"$prevValue"in e){var r=$.$$getRegister(e.name);if(r){r.$$triggerChange(e)}}"$newValue"in e&&I(t,e.name,e.$newValue);"$prevValue"in e&&I(n,e.name,e.$prevValue);a=true}});if(a){if(E($.props.$validator)){$.$$formValidate()}if(E($.props.$onFormChange)){$.props.$onFormChange($.$formutil,t,n)}}}};$.createDeepRegisters=function(){return $.$$deepRegisters=$.$$deepParseObject($.$$registers)};$.$$getRegister=function(e){if(e){var t=$.$$registers[e]||I($.$$deepRegisters,e);if(t){return t}}};$.$$formValidate=function(e){return $.$$formValidatePromise=new Promise(function(t){var r=$.props.$validator;var n;var i;var a;var u;var o=r($.$formutil.$params,$.formtutil);var s=function r(n){return t(A(e,A(a,n)))};if(O(o)){if(!$.$$formPending){$.$$formPending=true;$.$render()}i=function e(t){return n=t(s)};u=o.then(function(){return void 0},function(e){return e}).then(function(e){if(n){return n}$.$shouldCancelPrevAsyncValidate=null;$.$$formPending=false;return $.$$setFormErrors(e,s)})}else{if($.$$formPending){$.$$formPending=false}u=$.$$setFormErrors(o,s)}if($.$shouldCancelPrevAsyncValidate){$.$shouldCancelPrevAsyncValidate(function(e){a=e;return u})}$.$shouldCancelPrevAsyncValidate=i})};$.$$setFormErrors=function(r,n){if(r&&(r instanceof Error||typeof r!=="object")){g(false,"The result of $validator in <Form /> should always return None(null,undefined) or an object contains error message of Field.");return $.$render(n)}return $.$$setStates(r||{},function(r,n){var i=n.$getState(),a=i.$error,u=a===void 0?{}:a;if(r){return{$error:t({},u,e({},K,r))}}if(u[K]){delete u[K];return{$error:u}}return},n,true)};$.$getField=function(e){var t=$.$$getRegister(e);g(!e||t,"$getField('".concat(e,"') fail to find the matched Field. Maybe it has been unmounted."));g(e,"You should pass a name of the mounted Field to $getField().");if(t){return t.$new()}};$.$$onChange=function(t,r,n){return $.$setStates(e({},t,r),n)};$.$$setStates=function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var t=arguments.length>1?arguments[1]:undefined;var r=arguments.length>2?arguments[2]:undefined;var n=arguments.length>3?arguments[3]:undefined;var i=$.$$deepParseObject(e);Y($.$$registers,function(e,r){var a;if(n||(a=H(i,r))){var u=t(a&&a.data,e);if(u){var o=$.$formutil.$weakParams[r];var s=e.$$merge(u),l=s.$value;e.$$detectChange(u);if("$value"in u||"$viewValue"in u){var f=L($.$$fieldChangedQueue,function(e){return e.name===r});if(f){if(!("$prevValue"in f)){f.$prevValue=f.$newValue}f.$newValue=l}else{$.$$fieldChangedQueue.push({name:r,$newValue:l,$prevValue:o})}}}}});return $.$render(r)};$.$render=function(e){return new Promise(function(t){return $.forceUpdate(function(){return t(A(e,$.$formutil))})})};$.$validates=function(){var e;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(E(r[r.length-1])){e=r.pop()}if(r.length){var i=function e(t){t.forEach(function(t){if(Array.isArray(t)){e(t)}else{var r=$.$getField(t);if(r){r.$validate()}}})};i(r)}else{Y($.$$registers,function(e){return e.$validate()});if(E($.props.$validator)){$.$$formValidate()}}return $.$onValidates(e)};$.$onValidates=function(e){var t=Object.keys($.$$registers).map(function(e){return $.$$registers[e].$onValidate()});t.push($.$$formValidatePromise);return Promise.all(t).then(function(){return A(e,$.$formutil)})};$.$validate=function(e,t){var r=$.$getField(e);if(r){return r.$validate(t)}return A(t)};$.$reset=function(e,t){$.$$defaultInitialize();if(E(e)){t=e;e={}}return $.$$setStates(e,function(e,t){return t.$$reset(e)},t,true)};$.$setStates=function(e,t){return $.$$setStates(e,function(e){return e},t)};$.$setValues=function(e,t){$.$$deepParseObject(N(e),$.$$defaultValues);G($.$$defaultValues);return $.$$setStates(e,function(e){return{$value:e}},t)};$.$setFocuses=function(e,t){return $.$$setStates(e,function(e){return{$focused:e}},t)};$.$setDirts=function(e,t){return $.$$setStates(e,function(e){return{$dirty:e}},t)};$.$setTouches=function(e,t){return $.$$setStates(e,function(e){return{$touched:e}},t)};$.$setPendings=function(e,t){return $.$$setStates(e,function(e){return{$pending:e}},t)};$.$setErrors=function(e,t){return $.$$setStates(e,function(e){return{$error:e}},t)};$.$batchState=function(e,t){return $.$setStates(B($.$$registers,function(){return e}),t)};$.$batchDirty=function(e,t){return $.$batchState({$dirty:e},t)};$.$batchTouched=function(e,t){return $.$batchState({$touched:e},t)};$.$batchFocused=function(e,t){return $.$batchState({$focused:e},t)};$.$batchPending=function(e,t){return $.$batchState({$pending:e},t)};$.$batchError=function(e,t){return $.$batchState({$error:e},t)};$.$$defaultInitialize();return $}a(h,[{key:"getFormContext",value:function e(){return{$$registers:this.$$registers,$$register:this.$$register,$$unregister:this.$$unregister,$$onChange:this.$$onChange,$$getDefault:this.$$getDefault,$formutil:this.$formutil}}},{key:"$$deepParseObject",value:function e(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};Y(t,function(e,t){return I(r,t,e)});return r}},{key:"componentDidMount",value:function e(){M(this.props.$ref,this.$formutil)}},{key:"componentDidUpdate",value:function e(t){var r=this;M(this.props.$ref,this.$formutil);J(this.$$triggerChangeTimer);this.$$triggerChangeTimer=W(function(){r.$$triggerFormChange()})}},{key:"componentWillUnmount",value:function e(){M(this.props.$ref,null)}},{key:"_render",value:function e(){var t=this.$formutil;var r=this.props,n=r.children,i=r.render,a=r.component;if(a){return c(a,{$formutil:t})}if(E(i)){return i(t)}if(E(n)){return n(t)}return d.map(n,function(e){return e&&D(e.type)?v(e,{$formutil:t}):e})}},{key:"render",value:function e(){var r=this;var n=this.props.$processer;var i=Object.keys(this.$$registers).map(function(e){return{path:e,$state:r.$$registers[e].$getState()}});var a=Q(i,function(e,t){var r=t.path,i=t.$state;if(n){n(i,r)}if("$value"in i&&(i.$dirty||!P(i.$value))){e[r]=i.$value}});var u=Q(i,function(e,t){var r=t.path,n=t.$state;return r in a&&I(e,r,a[r])});var o=i.some(function(e){var t=e.$state;return t.$invalid});var s=i.some(function(e){var t=e.$state;return t.$dirty});var $=i.some(function(e){var t=e.$state;return t.$touched});var f=i.some(function(e){var t=e.$state;return t.$focused});var c=this.$$formPending||i.some(function(e){var t=e.$state;return t.$pending});var d=this.$formutil={$$registers:t({},this.$$registers),$$deepRegisters:this.$$deepRegisters,$states:Q(i,function(e,t){var r=t.path,n=t.$state;return I(e,r,n)}),$params:t({},this.$$defaultValues,{},u),$errors:Q(i,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){I(e,r,n.$error)}}),$dirts:Q(i,function(e,t){var r=t.path,n=t.$state;return I(e,r,n.$dirty)}),$touches:Q(i,function(e,t){var r=t.path,n=t.$state;return I(e,r,n.$touched)}),$focuses:Q(i,function(e,t){var r=t.path,n=t.$state;return I(e,r,n.$focused)}),$pendings:Q(i,function(e,t){var r=t.path,n=t.$state;return I(e,r,n.$pending)}),$weakStates:Q(i,function(e,t){var r=t.path,n=t.$state;return e[r]=n}),$weakParams:a,$weakErrors:Q(i,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){e[r]=n.$error}}),$weakDirts:Q(i,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$dirty}),$weakTouches:Q(i,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$touched}),$weakFocuses:Q(i,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$focused}),$weakPendings:Q(i,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$pending}),$getFirstError:function e(t){if(t){var r=d.$getField(t);return r&&r.$getFirstError()}for(var n in d.$weakErrors){if(d.$weakErrors.hasOwnProperty(n)){var i=d.$weakErrors[n];for(var a in i){if(i.hasOwnProperty(a)){return i[a]instanceof Error?i[a].message:i[a]}}}}},$render:this.$render,$getField:this.$getField,$onValidates:this.$onValidates,$new:function e(){return r.$formutil},$setStates:this.$setStates,$setValues:this.$setValues,$setErrors:this.$setErrors,$setTouches:this.$setTouches,$setDirts:this.$setDirts,$setFocuses:this.$setFocuses,$batchState:this.$batchState,$batchTouched:this.$batchTouched,$batchDirty:this.$batchDirty,$batchFocused:this.$batchFocused,$reset:this.$reset,$validates:this.$validates,$validate:this.$validate,$valid:!o,$invalid:o,$dirty:s,$pristine:!s,$touched:$,$untouched:!$,$focused:f,$pending:c};return l.createElement(F.Provider,{value:this.getFormContext()},this._render())}}]);return h}(h);X.displayName="React.Formutil.Form";X.defaultProps={$defaultValues:{},$defaultStates:{}};function Z(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=p(function(n,i){var a=Object.assign({},n);var u=n.component,o=y(n,["component"]);["$defaultStates","$defaultValues","$onFormChange","$validator","$processer","$ref"].forEach(function(e){if(e in a){if(e==="$defaultStates"||e==="$defaultValues"){o[e]=t({},r[e],{},a[e])}delete a[e]}});return l.createElement(X,Object.assign({},r,o,{render:function t(r){return l.createElement(e,Object.assign({},a,{$formutil:r,ref:i}))}}))});n.displayName="React.Formutil.withForm."+(e.displayName||e.name||"Anonymous");return b(n,e)}var ee=T(Z);var te=0;var re={$valid:true,$invalid:false,$dirty:false,$pristine:true,$touched:false,$untouched:true,$focused:false,$pending:false,$error:{}};function ne(e){return e!==true}function ie(e,t,r){g(!P(e),"You should return a string or Error when the validation('".concat(r&&r+": ").concat(t,"') failed, otherwise return true."))}var ae="React.Formutil.Field";function ue(){return te++}function oe(e,t){var r=t.children,n=t.render,i=t.component;if(i){return c(i,{$fieldutil:e})}if(E(n)){return n(e)}if(E(r)){return r(e)}return d.map(r,function(t){return t&&D(t.type)?v(t,{$fieldutil:e}):t})}function se(e,r){var n={$$FIELD_UUID:e.$$FIELD_UUID,$$reset:s,$$merge:b,$$detectChange:a,$$triggerChange:u,$onValidate:o,$new:function t(){return e.$fieldutil},$picker:$,$getState:$,$getComponent:function e(){return r},$reset:function t(r,n){return e.$setState(s(r),n)},$getFirstError:y,$validate:l,$setState:e.$setState,$render:f,$setValue:c,$setTouched:d,$setDirty:v,$setFocused:h,$setValidity:m,$setError:p,$setPending:g};var i;function a(e){if("$value"in e||"$viewValue"in e){l()}}function u(t){var r=t.$newValue,n=t.$prevValue;var i=e.props.$onFieldChange;if(E(i)){i(r,n,e.$formContext.$formutil)}}function o(e){i.then(e);return i}function s(r){var n;var i=e.props,a=e.$formContext;if(a.$$getDefault){var u=i.name;var o=a.$$getDefault(),s=o.$$defaultStates,$=o.$$defaultValues;if(u&&$){var l=I($,u);n=I(s,u)||{};if(!P(l)){n.$value=l}}}var f=i.$defaultValue,c=i.$defaultState;return b(t({},re,{},E(c)?c(i):c,{$value:E(f)?f(i):"$defaultValue"in i?f:""},n,{},r))}function $(){return t({},e.$state)}function l(r){return i=new Promise(function(n){var i=e.props,a=e.$formContext;var u=t({},i.$validators,{},i.$asyncValidators);var o=e.$state,s=o.$value,$=o.$pending,l=Object.assign({},o.$error);var f=a.$formutil;var c={};var d=false;var v;var h;var y;var b;delete l[K];var V=Object.keys(u).reduce(function(r,n){delete l[n];if(!d&&i[n]!=null){var a=u[n](s,i[n],t({},i,{$formutil:f,$fieldutil:e.$fieldutil,$validError:c}));if(O(a)){r.push(a["catch"](function(e){if(!v){m(n,e||n)}}))}else if(ne(a)){c[n]=a||n;ie(a,n,i.name);if(i.$validateLazy){d=true}}}return r},[]);var F=function e(t){return n(A(r,A(y,t)))};if(V.length){if(!$){g(true)}h=function e(t){return v=t(F)};V.push(p(t({},l,{},c)));b=Promise.all(V).then(function(){if(v){return v}e.$shouldCancelPrevAsyncValidate=null;return g(false,F)})}else{if($){g(false)}b=p(t({},l,{},c),F)}if(e.$shouldCancelPrevAsyncValidate){e.$shouldCancelPrevAsyncValidate(function(e){y=e;return b})}e.$shouldCancelPrevAsyncValidate=h})}function f(t,r){return e.$setState({$viewValue:t,$dirty:true},r)}function c(t,r){return e.$setState({$value:t},r)}function d(t,r){return e.$setState({$touched:t},r)}function v(t,r){return e.$setState({$dirty:t},r)}function h(t,r){return e.$setState({$focused:t},r)}function p(t,r){return e.$setState({$error:t},r)}function m(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var n=arguments.length>2?arguments[2]:undefined;var i=Object.assign({},e.$state.$error);if(ne(r)){i[t]=r||t;ie(r,t,e.props.name)}else{delete i[t]}return p(i,n)}function g(t,r){return e.$setState({$pending:t},r)}function y(){var t=e.$state.$error,r=t===void 0?{}:t;for(var n in r){if(r.hasOwnProperty(n)){return r[n]instanceof Error?r[n].message:r[n]}}}function b(r){var n=Object.assign({},r);if("$error"in n){if(!n.$error){n.$error={}}n.$valid=Object.keys(n.$error).length===0}var i=e.props,a=i.$parser,u=i.$formatter;if("$viewValue"in n&&!("$value"in n)){var o=function e(t){return n.$viewValue=t};n.$value=a?a(n.$viewValue,o):n.$viewValue}else if("$value"in n&&!("$viewValue"in n)){var s=function e(t){return n.$value=t};n.$viewValue=u?u(n.$value,s):n.$value}if("$valid"in n){n.$invalid=!n.$valid}else if("$invalid"in n){n.$dirty=!n.$invalid}if("$dirty"in n){n.$pristine=!n.$dirty}else if("$pristine"in n){n.$dirty=!n.$pristine}if("$touched"in n){n.$untouched=!n.$touched}else if("$untouched"in n){n.$touched=!n.$untouched}e.$state=t({},e.$state,{},n);return $()}return n}var $e=function(e){$(r,e);function r(){var e;var t;i(this,r);for(var n=arguments.length,a=new Array(n),s=0;s<n;s++){a[s]=arguments[s]}t=u(this,(e=o(r)).call.apply(e,[this].concat(a)));t.$$FIELD_UUID=ue();t.$formContext=void 0;t.$state=void 0;t.$setState=function(e,r){return new Promise(function(n){var i=function e(){return n(A(r,t.$fieldutil))};if(t.isMounting){var a=t.props.name;if(a in(t.$formContext.$$registers||{})){t.$formContext.$$onChange(a,e,i)}else{t.$registered.$$merge(e);t.$registered.$$detectChange(e);t.forceUpdate(i)}}else{t.$registered.$$merge(e);i()}})};return t}a(r,[{key:"componentDidMount",value:function e(){this.isMounting=true;var t=this.props.name,r=this.$formContext;g(!t||r.$formutil,"You should enusre that the <Field /> with the name '".concat(t,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));g(t,"You should assign a name to <Field />, otherwise it will be isolated!");if(r.$$register){r.$$register(t,this.$fieldHandler)}this.$prevValue=this.$state.$value;M(this.props.$ref,this.$fieldutil)}},{key:"componentWillUnmount",value:function e(){if(this.$formContext.$$unregister){this.$formContext.$$unregister(this.props.name,this.$fieldHandler,this.props.$reserveOnUnmount)}this.isMounting=false;M(this.props.$ref,null)}},{key:"componentDidUpdate",value:function e(t){var r=this.props.name;if(r!==t.name){if(this.$formContext.$$register){this.$formContext.$$register(r,this.$fieldHandler,t.name)}}M(this.props.$ref,this.$fieldutil);if(this.$state.$value!==this.$prevValue){if(!(r in(this.$formContext.$$registers||{}))){this.$registered.$$triggerChange({$newValue:this.$state.$value,$prevValue:this.$prevValue})}this.$prevValue=this.$state.$value}}},{key:"_render",value:function e(){var r=this.$fieldutil=t({$name:this.props.name},this.$registered.$getState(),{},this.$registered,{$$formutil:this.$formContext.$formutil});return oe(r,this.props)}},{key:"render",value:function e(){var t=this;return l.createElement(F.Consumer,null,function(e){var r=!t.$formContext;t.$formContext=e;if(!t.$fieldHandler){t.$fieldHandler=se(t,t)}t.$registered=(e.$$registers||{})[t.$fieldHandler.$name]||t.$fieldHandler;if(r){t.$fieldHandler.$$reset();t.$fieldHandler.$validate()}return t._render()})}}]);return r}(h);$e.displayName=ae;function le(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=p(function(n,i){var a=Object.assign({},n);var u=n.component,o=y(n,["component"]);["$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$defaultValue","$defaultState","$onFieldChange","$parser","$formatter","$ref","name"].concat(Object.keys(t({},r.$validators,{},r.$asyncValidators,{},a.$validators,{},a.$asyncValidators))).forEach(function(e){if(e in a){if(e==="$validators"||e==="$asyncValidators"||e==="$defaultState"){o[e]=t({},r[e],{},a[e])}delete a[e]}});return l.createElement($e,Object.assign({},r,o,{render:function t(r){return l.createElement(e,Object.assign({},a,{$fieldutil:r,ref:i}))}}))});n.displayName="React.Formutil.withField."+(e.displayName||e.name||"Anonymous");return b(n,e)}var fe=T(le);var ce=function(e){$(t,e);function t(){i(this,t);return u(this,o(t).apply(this,arguments))}a(t,[{key:"render",value:function e(){var t=this;var r=this.props,n=r.$fieldutil,i=r.value,a=r.onChange,u=r.onFocus,o=r.onBlur,s=r.checked,$=r.unchecked,f=y(r,["$fieldutil","value","onChange","onFocus","onBlur","checked","unchecked"]);var c=this.props.type;var d={value:"compositionValue"in this?this.compositionValue:i,onCompositionEnd:function e(r){t.composition=false;delete t.compositionValue;d.onChange(r)},onCompositionStart:function e(){return t.composition=true},onChange:function e(r){var n=r.target.value;if(t.composition){t.compositionValue=n;t.forceUpdate()}else{a(n,r)}},onFocus:u,onBlur:o};var v="input";switch(c){case"select":v=c;d.onChange=function(e){var t=e.target;var r=t.multiple?[].slice.call(t.options).filter(function(e){return e.selected}).map(function(e){return e.value}):t.value;a(r,e)};delete f.type;break;case"textarea":v=c;delete f.type;break;case"checkbox":case"radio":d={checked:i===s,onChange:function e(t){a(t.target.checked?s:$,t)},onFocus:u,onBlur:o};break}return l.createElement(v,Object.assign({},f,d))}}]);return t}(h);ce.displayName="React.Formutil.EasyField.Native";ce.defaultProps={value:"",type:"text",checked:true,unchecked:false};var de=f({}),ve=de.Provider,he=de.Consumer;var pe=function(e){$(t,e);function t(){i(this,t);return u(this,o(t).apply(this,arguments))}a(t,[{key:"getGroupContext",value:function e(){return this.props}},{key:"_render",value:function e(){var t=this.props,r=t.className,n=t.groupNode,i=t.children;var a={GroupOption:me,Field:ge};var u=E(i)?i(a):d.map(i,function(e){return v(e,a)});if(n===null){return u}return l.createElement(n,{className:r},u)}},{key:"render",value:function e(){return l.createElement(ve,{value:this.getGroupContext()},this._render())}}]);return t}(h);pe.displayName="React.Formutil.EasyField.Group";pe.defaultProps={type:"checkbox",groupNode:"div"};var me=function(e){$(t,e);function t(){i(this,t);return u(this,o(t).apply(this,arguments))}a(t,[{key:"componentDidMount",value:function e(){g("$value"in this.props,"You should pass a $value to <GroupOption />.")}},{key:"render",value:function e(){var t=this.props,r=t.$value,n=t.onChange,i=t.onFocus,a=t.onBlur,u=y(t,["$value","onChange","onFocus","onBlur"]);return l.createElement(he,null,function(e){var t=e.type,o=e.name;var s=t==="radio"?{checked:e.value===r,onChange:function t(i){e.onChange(r,i);n&&n(i)}}:t==="checkbox"?{checked:e.value.indexOf(r)>-1,onChange:function t(i){e.onChange(i.target.checked?e.value.concat(r):e.value.filter(function(e){return e!==r}),i);n&&n(i)}}:{value:e.value,onChange:function t(r){e.onChange(r);n&&n(r)}};return l.createElement("input",Object.assign({name:o},u,s,{type:t,onFocus:function t(r){e.onFocus(r);i&&i(r)},onBlur:function t(r){e.onBlur(r);a&&a(r)}}))})}}]);return t}(h);me.displayName="React.Formutil.EasyField.Group.Option";var ge=function(e){$(t,e);function t(){i(this,t);return u(this,o(t).apply(this,arguments))}a(t,[{key:"componentDidMount",value:function e(){g(false,'The "Field" property in EasyField\'s children-props has been deprecated. Please use "GroupOption" instead.')}},{key:"render",value:function e(){return l.createElement(me,this.props)}}]);return t}(h);ge.displayName="React.Formutil.EasyField.Group.Option.Deprecated";var ye=l.Frament||"div";var be=function(e){$(r,e);function r(e){var t;i(this,r);t=u(this,o(r).call(this,e));t.id=0;t.latestValue=t.props.value;t.$formutil=void 0;t.FieldValidators={required:function e(t){return t!==null}};t.$onFormChange=function(e){e.$onValidates(function(e){var r=e.$invalid,n=e.$params;if(r){if(t.props.value.length){t.props.onChange(t.latestValue=[])}}else if(!V(t.props.value,n.list)){t.props.onChange(t.latestValue=n.list)}})};t.swap=function(e,r,n){return t.$setState(function(t){var n=t.items;var i=[n[e],n[r]];n[r]=i[0];n[e]=i[1];return n},n)};t.insert=function(){var e,r,n;for(var i=arguments.length,a=new Array(i),u=0;u<i;u++){a[u]=arguments[u]}a.forEach(function(t){if(E(t)){n=t}else if(typeof t==="number"){e=t}else if(typeof t==="object"){r=t}});return t.$setState(function(n){var i=n.items;if(P(e)){i.push(t.getId(r))}else{i.splice(e,0,t.getId(r))}return{items:i}},n)};t.remove=function(){var e,r;for(var n=arguments.length,i=new Array(n),a=0;a<n;a++){i[a]=arguments[a]}i.forEach(function(t){if(E(t)){r=t}else if(typeof t==="number"){e=t}});return t.$setState(function(r){var n=r.items;if(P(e)){n.pop()}else{n.splice(e,1)}if(!n.length){n=[t.getId()]}return{items:n}},r)};t.$setState=function(e,r){return new Promise(function(n){return t.setState(e,function(){return t.$formutil.$onValidates(function(e){return n(A(r,e))})})})};t.state={items:e.value.length?e.value.map(function(){return t.getId()}):[t.getId()],formKey:0};return t}a(r,[{key:"componentDidUpdate",value:function e(t){var r=this;if(this.props.value!==this.latestValue){this.setState({items:this.props.value.length?this.props.value.map(function(){return r.getId()}):[this.getId()],formKey:this.state.formKey+1});this.latestValue=this.props.value}}},{key:"getId",value:function e(t){return{id:this.id++,values:t}}},{key:"render",value:function e(){var r=this;var n=this.props,i=n.children,a=n.onFocus,u=n.onBlur,o=n.value;var s=this;if(!E(i)){return null}var $={$insert:this.insert,$remove:this.remove,$swap:this.swap,$push:function e(t,n){return r.insert(t,n)},$pop:function e(t){return r.remove(t)},$shift:function e(t){return r.remove(0,t)},$unshift:function e(t,n){return r.insert(0,t,n)},onFocus:a,onBlur:u};return l.createElement(X,{key:this.state.formKey,$defaultValues:{list:o},$onFormChange:this.$onFormChange,children:function e(n){r.$formutil=n;return l.createElement(ye,null,r.state.items.map(function(e,a){var u=e.id,o=e.values;return l.createElement($e,{key:u,required:true,$defaultValue:o||null,$validators:r.FieldValidators,name:"list[".concat(a,"]"),children:function e(u){return l.createElement(X,{$defaultValues:u.$value||{},$onFormChange:function e(t){return t.$onValidates(function(e){var t=e.$invalid,r=e.$params;if(t){if(u.$viewValue!==null){u.$render(null)}}else if(!V(u.$viewValue,r)){u.$render(r)}})},children:function e(u){return i(t({get $length(){return s.state.items.length},$index:a,$isLast:function e(){return a===r.state.items.length-1},$isFirst:function e(){return a===0}},$,{},u),n)}})}})}))}})}}]);return r}(h);be.displayName="React.Formutil.EasyField.List";var Ve="__TYPE__";var Fe=[["required",function(e,t,r){var n=r.__TYPE__,i=r.checked,a=i===void 0?true:i;return n==="checked"?e===a:!S(e)}],["maxLength",function(e,t){return S(e)||e.length<=t}],["minLength",function(e,t){return S(e)||e.length>=t}],["max",function(e,t){return S(e)||e*1<=t}],["min",function(e,t){return S(e)||e*1>=t}],["pattern",function(e,t){return S(e)||t.test(e)}],["enum",function(e,t){return S(e)||t.indexOf(e)>-1}],["checker",function(e,t,r){return t(e,r)}]].reduce(function(e,t){var r=n(t,2),i=r[0],a=r[1];e[i]=function e(t,r,n){var u=n.validMessage,o=u===void 0?{}:u;return a.apply(void 0,arguments)||o[i]||"Error input: ".concat(i)};return e},{});var Ce="React.Formutil.EasyField";var ke={validMessage:{},valuePropName:"value",changePropName:"onChange",focusPropName:"onFocus",blurPropName:"onBlur",$parser:function e(t){return typeof t==="string"?t.trim():t}};function we(r,n,i){var a;var u=n.valuePropName,o=n.changePropName,s=n.focusPropName,$=n.blurPropName,l=n.getValueFromEvent,f=n.passUtil;var c=function e(t){return t&&t.target?t.target[u]:t};var d=t({},i,(a={},e(a,u,r.$viewValue),e(a,o,function(e){var t;for(var i=arguments.length,a=new Array(i>1?i-1:0),u=1;u<i;u++){a[u-1]=arguments[u]}if(((t=a[0])===null||t===void 0?void 0:t.nativeEvent)instanceof Event){a.push(e)}else{a.unshift(e)}var s=n[o];s&&s.apply(void 0,a);var $=l?l.apply(void 0,a):c(e);r.$render($)}),e(a,s,function(){var e=n[s];e&&e.apply(void 0,arguments);r.$setFocused(true)}),e(a,$,function(){var e=n[$];e&&e.apply(void 0,arguments);if(r.$untouched){r.$setTouched(true)}r.$setFocused(false)}),a));if(f){d[f===true?"$fieldutil":String(f)]=r}return d}function Pe(e){var r=e.children,i=e.component,a=e.render,u=y(e,["children","component","render"]);var o=u.name,s=u.type,$=u.defaultValue,l=u.valuePropName,f=u.changePropName,c=u.focusPropName,d=u.blurPropName,v=u.getValueFromEvent,h=u.validMessage,p=u.checked,m=u.unchecked,g=u.__TYPE__,b=u.passUtil,V=u.$defaultValue,F=u.$defaultState,C=u.$onFieldChange,k=u.$validators,w=u.$asyncValidators,E=u.$validateLazy,S=u.$reserveOnUnmount,O=u.$parser,j=u.$formatter,x=u.$ref,D=y(u,["name","type","defaultValue","valuePropName","changePropName","focusPropName","blurPropName","getValueFromEvent","validMessage","checked","unchecked","__TYPE__","passUtil","$defaultValue","$defaultState","$onFieldChange","$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$parser","$formatter","$ref"]);var N={children:r,component:i,render:a};var A=!P(s)||P(r)&&P(i)&&P(a);Object.keys(t({},u.$validators=t({},Fe,{},u.$validators),{},u.$asyncValidators)).forEach(function(e){if(e in D){if(!A||!R(e)){delete D[e]}}});if(A){var T=(s||"").split("."),_=n(T,2),U=_[0],I=U===void 0?"text":U,H=_[1];N.component=I==="group"?pe:I==="list"?be:ce;if(o){D.name=o}if(s){D.type=I}if(r){D.children=r}D.checked=p;D.unchecked=m;switch(I){case"select":case"textarea":if(e.multiple){u[Ve]="array"}break;case"group":if(H==="checkbox"){u[Ve]="array"}D.type=H;break;case"checkbox":case"radio":u[Ve]="checked";break;case"list":u[Ve]="array";break}}if(!("$defaultValue"in u)&&"defaultValue"in e){u.$defaultValue=$}if(!("$defaultValue"in u)&&Ve in u){var M;switch(u[Ve]){case"checked":var L=u.unchecked,B=L===void 0?false:L;M=B;break;case"array":M=[];break;case"object":M={};break;case"number":M=0;break}u.$defaultValue=M}return{fieldProps:u,childProps:D,renderProps:N}}function Ee(e,t){var r=t.component,n=t.render,i=t.children;if(r){return c(r,e)}if(E(n)){return n(e)}if(E(i)){return i(e)}return d.map(i,function(t){return v(t,e)})}var Se=function(e){$(t,e);function t(){i(this,t);return u(this,o(t).apply(this,arguments))}a(t,[{key:"render",value:function e(){var t=Pe(this.props),r=t.fieldProps,n=t.childProps,i=t.renderProps;return l.createElement($e,Object.assign({},r,{children:function e(t){return Ee(we(t,r,n),i)}}))}}]);return t}(h);Se.displayName=Ce;Se.defaultProps=ke;function Oe(e){var t=p(function(t,r){return l.createElement(F.Consumer,null,function(n){return l.createElement(e,Object.assign({},t,{$formutil:n.$formutil,ref:r}))})});t.displayName="React.Formutil.connect."+(e.displayName||e.name||"Anonymous");return b(t,e)}function je(){if(!l.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var e=l.useContext;var t=e(F);return t}function xe(e){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!l.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var a=l.useState,u=l.useLayoutEffect,o=l.useRef;var s;if(e){if(typeof e==="string"){s=e;i.name=s}else{i=e;s=i.name}}var $=je();var f=o({}).current;var c=o([]);var d;f.$formContext=$;f.props=i;f.$setState=m;var v=a(function(){f.$$FIELD_UUID=ue();f.$fieldHandler=d=se(f);var e=f.$fieldHandler.$$reset();f.$fieldHandler.$validate();return e}),h=n(v,2),p=h[1];if(!d){d=($.$$registers||{})[f.$fieldHandler.$name]||f.$fieldHandler}u(function(){var e=f.$state;if(f.isMounting){if(!(s in($.$$registers||{}))){var t=f.$prevValue;d.$$triggerChange({$newValue:e.$value,$prevValue:t})}}f.$prevValue=e.$value},[f.$state.$value]);u(function(){f.isMounting=true;g(!s||$.$formutil,"You should enusre that the useField() with the name '".concat(s,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));g(s,"You should pass a name argument to useField(), otherwise it will be isolated!");return function(){f.isMounting=false;M(i.$ref,null)}},[]);u(function(){if($.$$register){$.$$register(s,f.$fieldHandler)}return function(){if($.$$unregister){$.$$unregister(s,f.$fieldHandler,!f.isMounting&&i.$reserveOnUnmount)}}},[s]);u(function(){M(i.$ref,f.$fieldutil)});u(function(){if(c.current.length>0){var e=r(c.current);c.current.length=0;while(e.length){e.pop()(f.$fieldutil)}}});function m(e,t){return new Promise(function(r){var n=function e(){return r(A(t,f.$fieldutil))};if(f.isMounting){if(s in($.$$registers||{})){$.$$onChange(s,e,n)}else{p(d.$$merge(e));d.$$detectChange(e);c.current.push(n)}}else{d.$$merge(e);n()}})}return f.$fieldutil=t({$name:s},d.$getState(),{},d,{$$formutil:$.$formutil})}function De(){var e=je(),t=e.$formutil;return t}function Ne(e){e=t({},ke,{},e,{children:null});var r=Pe(e),n=r.fieldProps,i=r.childProps;var a=xe(n);return we(a,n,i)}export{Se as EasyField,$e as Field,X as Form,Oe as connect,F as formContext,xe as useField,De as useForm,Ne as useHandler,fe as withField,ee as withForm};
