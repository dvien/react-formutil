import e,{createElement as t,Children as r,cloneElement as n,Component as a}from"react";import i from"create-react-context";import u from"warning";import o from"hoist-non-react-statics";import s from"react-fast-compare";function l(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function $(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function f(e,t,r){if(t)$(e.prototype,t);if(r)$(e,r);return e}function c(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function d(e){for(var t=1;t<arguments.length;t++){var r=arguments[t]!=null?arguments[t]:{};var n=Object.keys(r);if(typeof Object.getOwnPropertySymbols==="function"){n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))}n.forEach(function(t){c(e,t,r[t])})}return e}function v(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});if(t)p(e,t)}function h(e){h=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return h(e)}function p(e,t){p=Object.setPrototypeOf||function e(t,r){t.__proto__=r;return t};return p(e,t)}function m(e,t){if(e==null)return{};var r={};var n=Object.keys(e);var a,i;for(i=0;i<n.length;i++){a=n[i];if(t.indexOf(a)>=0)continue;r[a]=e[a]}return r}function g(e,t){if(e==null)return{};var r=m(e,t);var n,a;if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++){n=i[a];if(t.indexOf(n)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(e,n))continue;r[n]=e[n]}}return r}function y(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function b(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}return y(e)}function V(e,t){return k(e)||P(e,t)||O()}function w(e){return F(e)||C(e)||S()}function F(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}function k(e){if(Array.isArray(e))return e}function C(e){if(Symbol.iterator in Object(e)||Object.prototype.toString.call(e)==="[object Arguments]")return Array.from(e)}function P(e,t){var r=[];var n=true;var a=false;var i=undefined;try{for(var u=e[Symbol.iterator](),o;!(n=(o=u.next()).done);n=true){r.push(o.value);if(t&&r.length===t)break}}catch(e){a=true;i=e}finally{try{if(!n&&u["return"]!=null)u["return"]()}finally{if(a)throw i}}return r}function S(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function O(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var E=i({});var j=Object.getPrototypeOf({});var x=/\s*(?:\]\s*\.|\]\s*\[|\.|\[|\])\s*/g;var D=N(window)?global:window;function N(e){return typeof e==="undefined"}function _(e){return typeof e==="function"}function A(e){return N(e)||e===null||e+""===""}function T(e){return!!e&&_(e.then)}function R(e){return Object.prototype.toString.call(e)==="[object Object]"}function U(e){if(!R(e))return false;if(null===Object.getPrototypeOf(e))return true;if(!_(e.constructor))return false;return e.constructor.prototype===j}function I(e){if(e&&typeof e==="object"){if(Array.isArray(e)){var t=[];for(var r=0,n=e.length;r<n;r++){t[r]=I(e[r])}return t}else if(U(e)){var a={};for(var i in e){a[i]=I(e[i])}return a}}return e}var H=function e(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}if(_(t)){t.apply(void 0,n)}return n[0]};function L(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(_(r[0])){return e.apply(void 0,r)}return function(t){return e(t,r[0])}}}var M=["minlength","maxlength","max","min","required","pattern","step"];function B(e){return M.indexOf(e.toLowerCase())>-1}var Y=function e(t){try{var r=new Function("origin","global","return typeof ".concat(t," === 'number' || (typeof ").concat(t," !== 'undefined' && !(origin in global)) ? ").concat(t," : origin"));return r(t,D)}catch(e){return t}};function Q(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}var n=t[0],a=t[1],i=t[2];u(typeof a==="string","The second parameter(".concat(JSON.stringify(a),") of parsePath() must be a string."));var o=(a.match(x)||[]).map(function(e){return e.replace(/\s/g,"")});var s=a.split(x).map(function(e){return e.trim()}).filter(function(e){return e!==""});var l=n;try{if(t.length<3){for(var $=0,f=s.length;$<f;$++){var c=Y(s[$]);if($+1===f){return l[c]}if(N(l[c])){break}l=l[c]}}else{for(var d=0,v=s.length;d<v;d++){var h=Y(s[d]);var p=s[d+1];var m=o[d];if(N(p)){l[h]=i;break}switch(m){case"].":case".":l=N(l[h])?l[h]={}:l[h];break;case"][":case"[":var g=Y(p);l=N(l[h])?l[h]=typeof g==="number"&&g>=0?[]:{}:l[h];break;default:l[h]=i;break}}}}catch(e){u(false,"The name '%s' of Field seems is not a legal expression.",a)}if(t.length>2){return n}}var G=function e(t,r){for(var n=0,a=t.length;n<a;n++){if(r(t[n])===true){return t[n]}}};var z=function e(t,r){return Object.keys(t).reduce(function(e,n){e[n]=r(t[n],n,t);return e},{})};var q=function e(t,r){return Object.keys(t).forEach(function(e){return r(t[e],e,t)})};var K=function e(t,r){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return t.reduce(function(){r.apply(void 0,arguments);return arguments.length<=0?undefined:arguments[0]},n)};var J=undefined;function W(e,t,r){q(e,function(t,r){if(t===J){delete e[r]}else if(t&&typeof t==="object"){W(t,r,e)}});if(r&&Object.keys(e).every(function(t){return e[t]===J})){r[t]=J;W(r)}}var X=function e(t,r){if(!N(Q(t,r))){Q(t,r,J);W(t)}};var Z="FORM_VALIDATE_RESULT";var ee,te;if(typeof requestAnimationFrame==="function"){ee=requestAnimationFrame;te=cancelAnimationFrame}else{ee=setTimeout;te=clearTimeout}var re=function(a){v(i,a);function i(e){var t;l(this,i);t=b(this,h(i).call(this,e));t.$$formPending=void 0;t.$$formValidatePromise=void 0;t.$$registers={};t.$$deepRegisters={};t.$$regDuplications={};t.$$duplicateTimer=void 0;t.$$checkDuplication=function(){var e=y(t),r=e.$$regDuplications;var n;q(r,function(e,t){var a=V(e,2),i=a[0],o=a[1];u(i.$$reserved,"The Field with a name '".concat(t,"' has been registered!"));o.$$reset(i.$getState());n=delete r[t]});if(n){t.$render()}};t.$$register=function(e,r,n){t.$$unregister(n,r);if(e){var a=t.$$getRegister(e);if(a){te(t.$$duplicateTimer);t.$$regDuplications[e]=[a,r];t.$$duplicateTimer=ee(t.$$checkDuplication)}else{t.$$fieldChangedQueue.push({name:e,$newValue:r.$getState().$value});X(t.$$defaultValues,e)}t.$$registers[r.$name=e]=r;t.createDeepRegisters();t.$render()}};t.$$unregister=function(e,r,n){if(e){if(e in t.$$regDuplications){var a=V(t.$$regDuplications[e],2),i=a[0],u=a[1];t.$$fieldChangedQueue.push({name:e,$newValue:u.$getState().$value,$prevValue:i.$getState().$value});delete t.$$regDuplications[e]}else if(t.$$registers[e]===r){if(n){r.$$reserved=true}else{delete t.$$registers[e];t.$$fieldChangedQueue.push({name:e,$prevValue:r.$getState().$value});X(t.$$defaultValues,e)}}t.createDeepRegisters();t.$render()}};t.$$defaultInitialize=function(){var e=t.props,r=e.$defaultValues,n=e.$defaultStates;t.$$defaultValues=t.$$deepParseObject(I(_(r)?r(t.props)||{}:r));t.$$defaultStates=t.$$deepParseObject(I(_(n)?n(t.props)||{}:n))};t.$$getDefault=function(){return{$$defaultStates:t.$$defaultStates,$$defaultValues:t.$$defaultValues}};t.$$triggerChangeTimer=void 0;t.$$fieldChangedQueue=[];t.$$triggerFormChange=function(){if(t.$$fieldChangedQueue.length){var e=w(t.$$fieldChangedQueue);t.$$fieldChangedQueue.length=0;var r={};var n={};var a=t.$$registers;var i=false;e.forEach(function(e){if(!(e.name in a)){delete e.$newValue}if(e.$newValue!==e.$prevValue){if("$newValue"in e&&"$prevValue"in e){var u=t.$$getRegister(e.name);if(u){u.$$triggerChange(e)}}"$newValue"in e&&Q(r,e.name,e.$newValue);"$prevValue"in e&&Q(n,e.name,e.$prevValue);i=true}});if(i){if(_(t.props.$validator)){t.$$formValidate()}if(_(t.props.$onFormChange)){t.props.$onFormChange(t.$formutil,r,n)}}}};t.createDeepRegisters=function(){return t.$$deepRegisters=t.$$deepParseObject(t.$$registers)};t.$$getRegister=function(e){if(e){var r=t.$$registers[e]||Q(t.$$deepRegisters,e);if(r){return r}}};t.$$formValidate=function(e){return t.$$formValidatePromise=new Promise(function(r){var n=t.props.$validator;var a;var i;var u;var o;var s=n(t.$formutil.$params,t.formtutil);var l=function t(n){return r(H(e,H(u,n)))};if(T(s)){if(!t.$$formPending){t.$$formPending=true;t.$render()}i=function e(t){return a=t(l)};o=s.then(function(){return void 0},function(e){return e}).then(function(e){if(a){return a}t.$shouldCancelPrevAsyncValidate=null;t.$$formPending=false;return t.$$setFormErrors(e,l)})}else{if(t.$$formPending){t.$$formPending=false}o=t.$$setFormErrors(s,l)}if(t.$shouldCancelPrevAsyncValidate){t.$shouldCancelPrevAsyncValidate(function(e){u=e;return o})}t.$shouldCancelPrevAsyncValidate=i})};t.$$setFormErrors=function(e,r){if(e&&(e instanceof Error||typeof e!=="object")){u(false,"The result of $validator in <Form /> should always return None(null,undefined) or an object contains error message of Field.");return t.$render(r)}return t.$$setStates(e||{},function(e,t){var r=t.$getState(),n=r.$error,a=n===void 0?{}:n;if(e){return{$error:d({},a,c({},Z,e))}}if(a[Z]){delete a[Z];return{$error:a}}return},r,true)};t.$getField=function(e){var r=t.$$getRegister(e);u(!e||r,"$getField('".concat(e,"') fail to find the matched Field. Maybe it has been unmounted."));u(e,"You should pass a name of the mounted Field to $getField().");if(r){return r.$new()}};t.$$onChange=function(e,r,n){return t.$setStates(c({},e,r),n)};t.$$setStates=function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var r=arguments.length>1?arguments[1]:undefined;var n=arguments.length>2?arguments[2]:undefined;var a=arguments.length>3?arguments[3]:undefined;var i=t.$$deepParseObject(e);var u=false;q(t.$$registers,function(n,o){var s=o in e?e[o]:Q(i,o);if(!N(s)||a){var l=r(s,n);if(l){var $=t.$formutil.$weakParams[o];var f=n.$$merge(l),c=f.$value;n.$$detectChange(l);if("$value"in l||"$viewValue"in l){var d=G(t.$$fieldChangedQueue,function(e){return e.name===o});if(d){if(!("$prevValue"in d)){d.$prevValue=d.$newValue}d.$newValue=c}else{t.$$fieldChangedQueue.push({name:o,$newValue:c,$prevValue:$})}}u=true}}});if(u){return t.$render(n)}return Promise.resolve(H(n,t.$formutil))};t.$render=function(e){return new Promise(function(r){return t.forceUpdate(function(){return r(H(e,t.$formutil))})})};t.$validates=function(){var e;for(var r=arguments.length,n=new Array(r),a=0;a<r;a++){n[a]=arguments[a]}if(_(n[n.length-1])){e=n.pop()}if(n.length){var i=function e(r){r.forEach(function(r){if(Array.isArray(r)){e(r)}else{var n=t.$getField(r);if(n){n.$validate()}}})};i(n)}else{q(t.$$registers,function(e){return e.$validate()});if(_(t.props.$validator)){t.$$formValidate()}}return t.$onValidates(e)};t.$onValidates=function(e){var r=Object.keys(t.$$registers).map(function(e){return t.$$registers[e].$onValidate()});r.push(t.$$formValidatePromise);return Promise.all(r).then(function(){return H(e,t.$formutil)})};t.$validate=function(e,r){var n=t.$getField(e);if(n){return n.$validate(r)}return H(r)};t.$reset=function(e,r){t.$$defaultInitialize();if(_(e)){r=e;e={}}return t.$$setStates(e,function(e,t){return t.$$reset(e)},r,true)};t.$setStates=function(e,r){return t.$$setStates(e,function(e){return e},r)};t.$setValues=function(e,r){t.$$deepParseObject(I(e),t.$$defaultValues);return t.$$setStates(e,function(e){return{$value:e}},r)};t.$setFocuses=function(e,r){return t.$$setStates(e,function(e){return{$focused:e}},r)};t.$setDirts=function(e,r){return t.$$setStates(e,function(e){return{$dirty:e}},r)};t.$setTouches=function(e,r){return t.$$setStates(e,function(e){return{$touched:e}},r)};t.$setPendings=function(e,r){return t.$$setStates(e,function(e){return{$pending:e}},r)};t.$setErrors=function(e,r){return t.$$setStates(e,function(e){return{$error:e}},r)};t.$batchState=function(e,r){return t.$setStates(z(t.$$registers,function(){return e}),r)};t.$batchDirty=function(e,r){return t.$batchState({$dirty:e},r)};t.$batchTouched=function(e,r){return t.$batchState({$touched:e},r)};t.$batchFocused=function(e,r){return t.$batchState({$focused:e},r)};t.$batchPending=function(e,r){return t.$batchState({$pending:e},r)};t.$batchError=function(e,r){return t.$batchState({$error:e},r)};t.$$defaultInitialize();return t}f(i,[{key:"getFormContext",value:function e(){return{$$registers:this.$$registers,$$register:this.$$register,$$unregister:this.$$unregister,$$onChange:this.$$onChange,$$getDefault:this.$$getDefault,$formutil:this.$formutil}}},{key:"$$deepParseObject",value:function e(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};q(t,function(e,t){return Q(r,t,e)});return r}},{key:"componentDidUpdate",value:function e(){var t=this;te(this.$$triggerChangeTimer);this.$$triggerChangeTimer=ee(function(){t.$$triggerFormChange()})}},{key:"_render",value:function e(){var a=this.$formutil;var i=this.props,u=i.children,o=i.render,s=i.component;if(s){return t(s,{$formutil:a})}if(_(o)){return o(a)}if(_(u)){return u(a)}return r.map(u,function(e){return e&&_(e.type)?n(e,{$formutil:a}):e})}},{key:"render",value:function t(){var r=this;var n=this.props.$processer;var a=Object.keys(this.$$registers).map(function(e){return{path:e,$state:r.$$registers[e].$getState()}});var i=K(a,function(e,t){var r=t.path,a=t.$state;if(n){n(a,r)}if("$value"in a&&(a.$dirty||!N(a.$value))){e[r]=a.$value}});var u=K(a,function(e,t){var r=t.path,n=t.$state;return r in i&&Q(e,r,i[r])});var o=a.some(function(e){var t=e.$state;return t.$invalid});var s=a.some(function(e){var t=e.$state;return t.$dirty});var l=a.some(function(e){var t=e.$state;return t.$touched});var $=a.some(function(e){var t=e.$state;return t.$focused});var f=this.$$formPending||a.some(function(e){var t=e.$state;return t.$pending});var c=this.$formutil={$$registers:d({},this.$$registers),$$deepRegisters:this.$$deepRegisters,$states:K(a,function(e,t){var r=t.path,n=t.$state;return Q(e,r,n)}),$params:d({},this.$$defaultValues,u),$errors:K(a,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){Q(e,r,n.$error)}}),$dirts:K(a,function(e,t){var r=t.path,n=t.$state;return Q(e,r,n.$dirty)}),$touches:K(a,function(e,t){var r=t.path,n=t.$state;return Q(e,r,n.$touched)}),$focuses:K(a,function(e,t){var r=t.path,n=t.$state;return Q(e,r,n.$focused)}),$pendings:K(a,function(e,t){var r=t.path,n=t.$state;return Q(e,r,n.$pending)}),$weakStates:K(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n}),$weakParams:i,$weakErrors:K(a,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){e[r]=n.$error}}),$weakDirts:K(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$dirty}),$weakTouches:K(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$touched}),$weakFocuses:K(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$focused}),$weakPendings:K(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$pending}),$getFirstError:function e(t){if(t){var r=c.$getField(t);return r&&r.$getFirstError()}for(var n in c.$weakErrors){var a=c.$weakErrors[n];for(var i in a){return a[i]instanceof Error?a[i].message:a[i]}}},$render:this.$render,$getField:this.$getField,$onValidates:this.$onValidates,$new:function e(){return r.$formutil},$setStates:this.$setStates,$setValues:this.$setValues,$setErrors:this.$setErrors,$setTouches:this.$setTouches,$setDirts:this.$setDirts,$setFocuses:this.$setFocuses,$batchState:this.$batchState,$batchTouched:this.$batchTouched,$batchDirty:this.$batchDirty,$batchFocused:this.$batchFocused,$reset:this.$reset,$validates:this.$validates,$validate:this.$validate,$valid:!o,$invalid:o,$dirty:s,$pristine:!s,$touched:l,$untouched:!l,$focused:$,$pending:f};return e.createElement(E.Provider,{value:this.getFormContext()},this._render())}}]);return i}(a);re.displayName="React.Formutil.Form";re.defaultProps={$defaultValues:{},$defaultStates:{}};function ne(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=function(n){v(a,n);function a(){l(this,a);return b(this,h(a).apply(this,arguments))}f(a,[{key:"render",value:function n(){var a=Object.assign({},this.props);var i=this.props,u=i.component,o=g(i,["component"]);["$defaultStates","$defaultValues","$onFormChange","$validator","$processer"].forEach(function(e){if(e in a){if(e==="$defaultStates"||e==="$defaultValues"){o[e]=d({},r[e],a[e])}delete a[e]}});return e.createElement(re,Object.assign({},r,o,{render:function r(n){return e.createElement(t,Object.assign({},a,{$formutil:n}))}}))}}]);return a}(a);n.displayName="React.Formutil.withForm."+(t.displayName||t.name||"Anonymous");return o(n,t)}var ae=L(ne);var ie=0;var ue={$valid:true,$invalid:false,$dirty:false,$pristine:true,$touched:false,$untouched:true,$focused:false,$pending:false,$error:{}};function oe(e){return e!==true}function se(e,t,r){u(!N(e),"You should return a string or Error when the validation('".concat(r&&r+": ").concat(t,"') failed, otherwise return true."))}var le="React.Formutil.Field";function $e(){return ie++}function fe(e,a){var i=a.children,u=a.render,o=a.component;if(o){return t(o,{$fieldutil:e})}if(_(u)){return u(e)}if(_(i)){return i(e)}return r.map(i,function(t){return t&&_(t.type)?n(t,{$fieldutil:e}):t})}function ce(e,t){var r={$$FIELD_UUID:e.$$FIELD_UUID,$$reset:o,$$merge:b,$$detectChange:a,$$triggerChange:i,$onValidate:u,$new:function t(){return e.$fieldutil},$picker:s,$getState:s,$getComponent:function e(){return t},$reset:function t(r,n){return e.$setState(o(r),n)},$getFirstError:y,$validate:l,$setState:e.$setState,$render:$,$setValue:f,$setTouched:c,$setDirty:v,$setFocused:h,$setValidity:m,$setError:p,$setPending:g};var n;function a(e){if("$value"in e||"$viewValue"in e){l()}}function i(t){var r=t.$newValue,n=t.$prevValue;var a=e.props.$onFieldChange;if(_(a)){a(r,n,e.$formContext.$formutil)}}function u(e){n.then(e);return n}function o(t){var r;var n=e.props,a=e.$formContext;if(a.$$getDefault){var i=n.name;var u=a.$$getDefault(),o=u.$$defaultStates,s=u.$$defaultValues;if(i&&s){var l=Q(s,i);r=Q(o,i)||{};if(!N(l)){r.$value=l}}}var $=n.$defaultValue,f=n.$defaultState;return b(d({},ue,_(f)?f(n):f,{$value:_($)?$(n):"$defaultValue"in n?$:""},r,t))}function s(){return d({},e.$state)}function l(t){return n=new Promise(function(r){var n=e.props,a=e.$formContext;var i=d({},n.$validators,n.$asyncValidators);var u=e.$state,o=u.$value,s=u.$pending,l=Object.assign({},u.$error);var $=a.$formutil;var f={};var c=false;var v;var h;var y;var b;delete l[Z];var V=Object.keys(i).reduce(function(t,r){delete l[r];if(!c&&n[r]!=null){var a=i[r](o,n[r],d({},n,{$formutil:$,$fieldutil:e.$fieldutil,$validError:f}));if(T(a)){t.push(a.catch(function(e){if(!v){m(r,e||r)}}))}else if(oe(a)){f[r]=a||r;se(a,r,n.name);if(n.$validateLazy){c=true}}}return t},[]);var w=function e(n){return r(H(t,H(y,n)))};if(V.length){if(!s){g(true)}h=function e(t){return v=t(w)};V.push(p(d({},l,f)));b=Promise.all(V).then(function(){if(v){return v}e.$shouldCancelPrevAsyncValidate=null;return g(false,w)})}else{if(s){g(false)}b=p(d({},l,f),w)}if(e.$shouldCancelPrevAsyncValidate){e.$shouldCancelPrevAsyncValidate(function(e){y=e;return b})}e.$shouldCancelPrevAsyncValidate=h})}function $(t,r){return e.$setState({$viewValue:t,$dirty:true},r)}function f(t,r){return e.$setState({$value:t},r)}function c(t,r){return e.$setState({$touched:t},r)}function v(t,r){return e.$setState({$dirty:t},r)}function h(t,r){return e.$setState({$focused:t},r)}function p(t,r){return e.$setState({$error:t},r)}function m(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var n=arguments.length>2?arguments[2]:undefined;var a=Object.assign({},e.$state.$error);if(oe(r)){a[t]=r||t;se(r,t,e.props.name)}else{delete a[t]}return p(a,n)}function g(t,r){return e.$setState({$pending:t},r)}function y(){var t=e.$state.$error,r=t===void 0?{}:t;for(var n in r){return r[n]instanceof Error?r[n].message:r[n]}}function b(t){var r=Object.assign({},t);if("$error"in r){if(!r.$error){r.$error={}}r.$valid=Object.keys(r.$error).length===0}var n=e.props,a=n.$parser,i=n.$formatter;if("$viewValue"in r&&!("$value"in r)){var u=function e(t){return r.$viewValue=t};r.$value=a?a(r.$viewValue,u):r.$viewValue}else if("$value"in r&&!("$viewValue"in r)){var o=function e(t){return r.$value=t};r.$viewValue=i?i(r.$value,o):r.$value}if("$valid"in r){r.$invalid=!r.$valid}else if("$invalid"in r){r.$dirty=!r.$invalid}if("$dirty"in r){r.$pristine=!r.$dirty}else if("$pristine"in r){r.$dirty=!r.$pristine}if("$touched"in r){r.$untouched=!r.$touched}else if("$untouched"in r){r.$touched=!r.$untouched}e.$state=d({},e.$state,r);return s()}return r}var de=function(t){v(r,t);function r(){var e;var t;l(this,r);for(var n=arguments.length,a=new Array(n),i=0;i<n;i++){a[i]=arguments[i]}t=b(this,(e=h(r)).call.apply(e,[this].concat(a)));t.$$FIELD_UUID=$e();t.$formContext=void 0;t.$state=void 0;t.$setState=function(e,r){return new Promise(function(n){var a=function e(){return n(H(r,t.$fieldutil))};if(t.isMounting){var i=t.props.name;if(i in(t.$formContext.$$registers||{})){t.$formContext.$$onChange(i,e,a)}else{t.$registered.$$merge(e);t.$registered.$$detectChange(e);t.forceUpdate(a)}}else{t.$registered.$$merge(e);a()}})};return t}f(r,[{key:"componentDidMount",value:function e(){this.isMounting=true;var t=this.props.name,r=this.$formContext;u(!t||r.$formutil,"You should enusre that the <Field /> with the name '".concat(t,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));u(t,"You should assign a name to <Field />, otherwise it will be isolated!");if(r.$$register){r.$$register(t,this.$fieldHandler)}this.$prevValue=this.$state.$value}},{key:"componentWillUnmount",value:function e(){if(this.$formContext.$$unregister){this.$formContext.$$unregister(this.props.name,this.$fieldHandler,this.props.$reserveOnUnmount)}this.isMounting=false}},{key:"componentDidUpdate",value:function e(t){var r=this.props.name;if(r!==t.name){if(this.$formContext.$$register){this.$formContext.$$register(r,this.$fieldHandler,t.name)}}if(this.$state.$value!==this.$prevValue){if(!(r in(this.$formContext.$$registers||{}))){this.$registered.$$triggerChange({$newValue:this.$state.$value,$prevValue:this.$prevValue})}this.$prevValue=this.$state.$value}}},{key:"_render",value:function e(){var t=this.$fieldutil=d({$name:this.props.name},this.$registered.$getState(),this.$registered,{$$formutil:this.$formContext.$formutil});return fe(t,this.props)}},{key:"render",value:function t(){var r=this;var n=!this.$formContext;return e.createElement(E.Consumer,null,function(e){r.$formContext=e;if(!r.$fieldHandler){r.$fieldHandler=ce(r,r)}r.$registered=(e.$$registers||{})[r.$fieldHandler.$name]||r.$fieldHandler;if(n){r.$fieldHandler.$$reset();r.$fieldHandler.$validate()}return r._render()})}}]);return r}(a);de.displayName=le;function ve(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=function(n){v(a,n);function a(){l(this,a);return b(this,h(a).apply(this,arguments))}f(a,[{key:"render",value:function n(){var a=Object.assign({},this.props);var i=this.props,u=i.component,o=g(i,["component"]);["$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$defaultValue","$defaultState","$onFieldChange","$parser","$formatter","name"].concat(Object.keys(d({},r.$validators,r.$asyncValidators,a.$validators,a.$asyncValidators))).forEach(function(e){if(e in a){if(e==="$validators"||e==="$asyncValidators"||e==="$defaultState"){o[e]=d({},r[e],a[e])}delete a[e]}});return e.createElement(de,Object.assign({},r,o,{render:function r(n){return e.createElement(t,Object.assign({},a,{$fieldutil:n}))}}))}}]);return a}(a);n.displayName="React.Formutil.withField."+(t.displayName||t.name||"Anonymous");return o(n,t)}var he=L(ve);var pe=function(t){v(r,t);function r(){l(this,r);return b(this,h(r).apply(this,arguments))}f(r,[{key:"render",value:function t(){var r=this;var n=this.props,a=n.$fieldutil,i=n.value,u=n.onChange,o=n.onFocus,s=n.onBlur,l=n.checked,$=n.unchecked,f=g(n,["$fieldutil","value","onChange","onFocus","onBlur","checked","unchecked"]);var c=this.props.type;var d={value:"compositionValue"in this?this.compositionValue:i,onCompositionEnd:function e(t){r.composition=false;delete r.compositionValue;d.onChange(t)},onCompositionStart:function e(){return r.composition=true},onChange:function e(t){var n=t.target.value;if(r.composition){r.compositionValue=n;r.forceUpdate()}else{u(n,t)}},onFocus:o,onBlur:s};var v="input";switch(c){case"select":v=c;d.onChange=function(e){var t=e.target;var r=t.multiple?[].slice.call(t.options).filter(function(e){return e.selected}).map(function(e){return e.value}):t.value;u(r,e)};delete f.type;break;case"textarea":v=c;delete f.type;break;case"checkbox":case"radio":d={checked:i===l,onChange:function e(t){u(t.target.checked?l:$,t)},onFocus:o,onBlur:s};break;default:break}return e.createElement(v,Object.assign({},f,d))}}]);return r}(a);pe.displayName="React.Formutil.EasyField.Native";pe.defaultProps={value:"",type:"text",checked:true,unchecked:false};var me=i({}),ge=me.Provider,ye=me.Consumer;var be=function(t){v(a,t);function a(){l(this,a);return b(this,h(a).apply(this,arguments))}f(a,[{key:"getGroupContext",value:function e(){return this.props}},{key:"_render",value:function t(){var a=this.props,i=a.className,u=a.groupNode,o=a.children;var s={GroupOption:Ve,Field:we};var l=_(o)?o(s):r.map(o,function(e){return n(e,s)});if(u===null){return l}return e.createElement(u,{className:i},l)}},{key:"render",value:function t(){return e.createElement(ge,{value:this.getGroupContext()},this._render())}}]);return a}(a);be.displayName="React.Formutil.EasyField.Group";be.defaultProps={type:"checkbox",groupNode:"div"};var Ve=function(t){v(r,t);function r(){l(this,r);return b(this,h(r).apply(this,arguments))}f(r,[{key:"componentDidMount",value:function e(){u("$value"in this.props,"You should pass a $value to <GroupOption />.")}},{key:"render",value:function t(){var r=this.props,n=r.$value,a=r.onChange,i=r.onFocus,u=r.onBlur,o=g(r,["$value","onChange","onFocus","onBlur"]);return e.createElement(ye,null,function(t){var r=t.type,s=t.name;var l=r==="radio"?{checked:t.value===n,onChange:function e(r){t.onChange(n,r);a&&a(r)}}:r==="checkbox"?{checked:t.value.indexOf(n)>-1,onChange:function e(r){t.onChange(r.target.checked?t.value.concat(n):t.value.filter(function(e){return e!==n}),r);a&&a(r)}}:{value:t.value,onChange:function e(r){t.onChange(r);a&&a(r)}};return e.createElement("input",Object.assign({name:s},o,l,{type:r,onFocus:function e(r){t.onFocus(r);i&&i(r)},onBlur:function e(r){t.onBlur(r);u&&u(r)}}))})}}]);return r}(a);Ve.displayName="React.Formutil.EasyField.Group.Option";var we=function(t){v(r,t);function r(){l(this,r);return b(this,h(r).apply(this,arguments))}f(r,[{key:"componentDidMount",value:function e(){u(false,'The "Field" property in EasyField\'s children-props has been deprecated. Please use "GroupOption" instead.')}},{key:"render",value:function t(){return e.createElement(Ve,this.props)}}]);return r}(a);we.displayName="React.Formutil.EasyField.Group.Option.Deprecated";var Fe=e.Frament||"div";var ke=function(t){v(r,t);function r(e){var t;l(this,r);t=b(this,h(r).call(this,e));t.id=0;t.latestValue=t.props.value;t.$formutil=void 0;t.FieldValidators={required:function e(t){return t!==null}};t.$onFormChange=function(e){e.$onValidates(function(e){var r=e.$invalid,n=e.$params;if(r){if(t.props.value.length){t.props.onChange(t.latestValue=[])}}else if(!s(t.props.value,n.list)){t.props.onChange(t.latestValue=n.list)}})};t.swap=function(e,r,n){return t.$setState(function(t){var n=t.items;var a=[n[e],n[r]];n[r]=a[0];n[e]=a[1];return n},n)};t.insert=function(){var e,r,n;for(var a=arguments.length,i=new Array(a),u=0;u<a;u++){i[u]=arguments[u]}i.forEach(function(t){if(_(t)){n=t}else if(typeof t==="number"){e=t}else if(typeof t==="object"){r=t}});return t.$setState(function(n){var a=n.items;if(N(e)){a.push(t.getId(r))}else{a.splice(e,0,t.getId(r))}return{items:a}},n)};t.remove=function(){var e,r;for(var n=arguments.length,a=new Array(n),i=0;i<n;i++){a[i]=arguments[i]}a.forEach(function(t){if(_(t)){r=t}else if(typeof t==="number"){e=t}});return t.$setState(function(r){var n=r.items;if(N(e)){n.pop()}else{n.splice(e,1)}if(!n.length){n=[t.getId()]}return{items:n}},r)};t.$setState=function(e,r){return new Promise(function(n){return t.setState(e,function(){return t.$formutil.$onValidates(function(e){return n(H(r,e))})})})};t.state={items:e.value.length?e.value.map(function(){return t.getId()}):[t.getId()],formKey:0};return t}f(r,[{key:"componentDidUpdate",value:function e(t){var r=this;if(this.props.value!==this.latestValue){this.setState({items:this.props.value.length?this.props.value.map(function(){return r.getId()}):[this.getId()],formKey:this.state.formKey+1});this.latestValue=this.props.value}}},{key:"getId",value:function e(t){return{id:this.id++,values:t}}},{key:"render",value:function t(){var r=this;var n=this.props,a=n.children,i=n.onFocus,u=n.onBlur,o=n.value;if(!_(a)){return null}var l={$length:this.state.items.length,$insert:this.insert,$remove:this.remove,$swap:this.swap,$push:function e(t,n){return r.insert(t,n)},$pop:function e(t){return r.remove(t)},$shift:function e(t){return r.remove(0,t)},$unshift:function e(t,n){return r.insert(0,t,n)},onFocus:i,onBlur:u};return e.createElement(re,{key:this.state.formKey,$defaultValues:{list:o},$onFormChange:this.$onFormChange,children:function t(n){r.$formutil=n;return e.createElement(Fe,null,r.state.items.map(function(t,i){var u=t.id,o=t.values;return e.createElement(de,{key:u,required:true,$defaultValue:o||null,$validators:r.FieldValidators,name:"list[".concat(i,"]"),children:function t(u){return e.createElement(re,{$defaultValues:u.$value||{},$onFormChange:function e(t){return t.$onValidates(function(e){var t=e.$invalid,r=e.$params;if(t){if(u.$viewValue!==null){u.$render(null)}}else if(!s(u.$viewValue,r)){u.$render(r)}})},children:function e(t){return a(d({},l,t,{$index:i,$isLast:function e(){return i===r.state.items.length-1},$isFirst:function e(){return i===0}}),n)}})}})}))}})}}]);return r}(a);ke.displayName="React.Formutil.EasyField.List";var Ce="__TYPE__";var Pe=[["required",function(e,t,r){var n=r.__TYPE__,a=r.checked,i=a===void 0?true:a;return n==="checked"?e===i:!A(e)}],["maxLength",function(e,t){return A(e)||e.length<=t}],["minLength",function(e,t){return A(e)||e.length>=t}],["max",function(e,t){return A(e)||e*1<=t}],["min",function(e,t){return A(e)||e*1>=t}],["pattern",function(e,t){return A(e)||t.test(e)}],["enum",function(e,t){return A(e)||t.indexOf(e)>-1}],["checker",function(e,t,r){return t(e,r)}]].reduce(function(e,t){var r=V(t,2),n=r[0],a=r[1];e[n]=function e(t,r,i){var u=i.validMessage,o=u===void 0?{}:u;return a.apply(void 0,arguments)||o[n]||"Error input: ".concat(n)};return e},{});var Se="React.Formutil.EasyField";var Oe={validMessage:{},valuePropName:"value",changePropName:"onChange",focusPropName:"onFocus",blurPropName:"onBlur",$parser:function e(t){return typeof t==="string"?t.trim():t}};function Ee(e,t,r){var n;var a=t.valuePropName,i=t.changePropName,u=t.focusPropName,o=t.blurPropName,s=t.passUtil;var l=function e(t){return t&&t.target?t.target[a]:t};var $=d({},r,(n={},c(n,a,e.$viewValue),c(n,i,function(){for(var r=arguments.length,n=new Array(r),a=0;a<r;a++){n[a]=arguments[a]}var u=n[0];var o=n[n.length-1];if(!o||!o.target){o=n}else{o=[o]}var s=t[i];s&&s.apply(void 0,w(o));var $=l(u);e.$render($)}),c(n,u,function(){var r=t[u];r&&r.apply(void 0,arguments);e.$setFocused(true)}),c(n,o,function(){var r=t[o];r&&r.apply(void 0,arguments);if(e.$untouched){e.$setTouched(true)}e.$setFocused(false)}),n));if(s){$[s===true?"$fieldutil":s]=e}return $}function je(e){var t=e.children,r=e.component,n=e.render,a=g(e,["children","component","render"]);var i=a.name,u=a.type,o=a.defaultValue,s=a.valuePropName,l=a.changePropName,$=a.focusPropName,f=a.blurPropName,c=a.validMessage,v=a.__TYPE__,h=a.passUtil,p=a.$defaultValue,m=a.$defaultState,y=a.$onFieldChange,b=a.$validators,w=a.$asyncValidators,F=a.$validateLazy,k=a.$reserveOnUnmount,C=a.$parser,P=a.$formatter,S=g(a,["name","type","defaultValue","valuePropName","changePropName","focusPropName","blurPropName","validMessage","__TYPE__","passUtil","$defaultValue","$defaultState","$onFieldChange","$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$parser","$formatter"]);var O={children:t,component:r,render:n};var E=!N(u)||N(t)&&N(r)&&N(n);Object.keys(d({},a.$validators=d({},Pe,a.$validators),a.$asyncValidators)).forEach(function(e){if(e in S){if(!E||!B(e)){delete S[e]}}});if(E){var j=(u||"").split("."),x=V(j,2),D=x[0],_=D===void 0?"text":D,A=x[1];O.component=_==="group"?be:_==="list"?ke:pe;if(i){S.name=i}if(u){S.type=_}if(t){S.children=t}switch(_){case"select":case"textarea":if(e.multiple){a[Ce]="array"}break;case"group":if(A==="checkbox"){a[Ce]="array"}S.type=A;break;case"checkbox":case"radio":a[Ce]="checked";break;case"list":a[Ce]="array";break;default:break}}if(!("$defaultValue"in a)&&"defaultValue"in e){a.$defaultValue=o}if(!("$defaultValue"in a)&&Ce in a){var T;switch(a[Ce]){case"checked":var R=a.unchecked,U=R===void 0?false:R;T=U;break;case"array":T=[];break;case"object":T={};break;case"number":T=0;break;case"empty":default:break}a.$defaultValue=T}return{fieldProps:a,childProps:S,renderProps:O}}function xe(e,a){var i=a.component,u=a.render,o=a.children;if(i){return t(i,e)}if(_(u)){return u(e)}if(_(o)){return o(e)}return r.map(o,function(t){return n(t,e)})}var De=function(t){v(r,t);function r(){l(this,r);return b(this,h(r).apply(this,arguments))}f(r,[{key:"render",value:function t(){var r=je(this.props),n=r.fieldProps,a=r.childProps,i=r.renderProps;return e.createElement(de,Object.assign({},n,{children:function e(t){return xe(Ee(t,n,a),i)}}))}}]);return r}(a);De.displayName=Se;De.defaultProps=Oe;function Ne(t){var r=function(r){v(n,r);function n(){l(this,n);return b(this,h(n).apply(this,arguments))}f(n,[{key:"render",value:function r(){var n=this;return e.createElement(E.Consumer,null,function(r){return e.createElement(t,Object.assign({},n.props,{$formutil:r.$formutil}))})}}]);return n}(a);r.displayName="React.Formutil.connect."+(t.displayName||t.name||"Anonymous");return o(r,t)}function _e(){if(!e.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var t=e.useContext;var r=t(E);return r}function Ae(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!e.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var n=e.useState,a=e.useLayoutEffect,i=e.useRef;var o;if(t){if(typeof t==="string"){o=t;r.name=o}else{r=t;o=r.name}}var s=_e();var l=i({}).current;var $=i([]);var f;l.$formContext=s;l.props=r;l.$setState=p;var c=n(function(){l.$$FIELD_UUID=$e();l.$fieldHandler=f=ce(l);var e=l.$fieldHandler.$$reset();l.$fieldHandler.$validate();return e}),v=V(c,2),h=v[1];if(!f){f=(s.$$registers||{})[l.$fieldHandler.$name]||l.$fieldHandler}a(function(){var e=l.$state;if(l.isMounting){if(!(o in(s.$$registers||{}))){var t=l.$prevValue;f.$$triggerChange({$newValue:e.$value,$prevValue:t})}}l.$prevValue=e.$value},[l.$state.$value]);a(function(){l.isMounting=true;u(!o||s.$formutil,"You should enusre that the useField() with the name '".concat(o,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));u(o,"You should pass a name argument to useField(), otherwise it will be isolated!");return function(){if(s.$$unregister){s.$$unregister(o,l.$fieldHandler,r.$reserveOnUnmount)}l.isMounting=false}},[]);a(function(){if(s.$$register){s.$$register(o,l.$fieldHandler,l.$prevName)}l.$prevName=o},[o]);a(function(){if($.current.length>0){var e=w($.current);$.current.length=0;while(e.length){e.pop()(l.$fieldutil)}}});function p(e,t){return new Promise(function(r){var n=function e(){return r(H(t,l.$fieldutil))};if(l.isMounting){if(o in(s.$$registers||{})){s.$$onChange(o,e,n)}else{h(f.$$merge(e));f.$$detectChange(e);$.current.push(n)}}else{f.$$merge(e);n()}})}return l.$fieldutil=d({$name:o},f.$getState(),f,{$$formutil:s.$formutil})}function Te(){var e=_e(),t=e.$formutil;return t}function Re(e){e=d({},Oe,e,{children:null});var t=je(e),r=t.fieldProps,n=t.childProps;var a=Ae(r);return Ee(a,r,n)}export{De as EasyField,de as Field,re as Form,Ne as connect,Ae as useField,Te as useForm,Re as useHandler,he as withField,ae as withForm};
