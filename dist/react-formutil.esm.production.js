import e from"@babel/runtime/helpers/esm/defineProperty";import t from"@babel/runtime/helpers/esm/objectSpread2";import r from"@babel/runtime/helpers/esm/toConsumableArray";import n from"@babel/runtime/helpers/esm/slicedToArray";import a from"@babel/runtime/helpers/esm/classCallCheck";import i from"@babel/runtime/helpers/esm/createClass";import u from"@babel/runtime/helpers/esm/possibleConstructorReturn";import o from"@babel/runtime/helpers/esm/getPrototypeOf";import s from"@babel/runtime/helpers/esm/assertThisInitialized";import l from"@babel/runtime/helpers/esm/inherits";import $,{createContext as f,createElement as c,Children as d,cloneElement as v,Component as p,forwardRef as h}from"react";import m from"prop-types";import{isValidElementType as g}from"react-is";import y from"warning";import b from"@babel/runtime/helpers/esm/objectWithoutProperties";import V from"hoist-non-react-statics";import F from"react-fast-compare";var w=f(function(){return{}});var C=Object.getPrototypeOf({});var k=/\s*(?:\]\s*\.|\]\s*\[|\.|\[|\])\s*/g;var P=S(window)?global:window;function S(e){return typeof e==="undefined"}function E(e){return typeof e==="function"}function O(e){return S(e)||e===null||e+""===""}function j(e){return!!e&&E(e.then)}function _(e){return Object.prototype.toString.call(e)==="[object Object]"}function x(e){if(!_(e))return false;if(null===Object.getPrototypeOf(e))return true;if(!E(e.constructor))return false;return e.constructor.prototype===C}function D(e){return g(e)&&typeof e!=="string"}function N(e,t,r){if(e[t]&&!D(e[t])){return new Error("Invalid prop 'component' supplied to '".concat(r,"': the prop is not a valid React component"))}}function A(e){if(Array.isArray(e)){var t=[];for(var r=0,n=e.length;r<n;r++){t[r]=A(e[r])}return t}else if(x(e)){var a={};for(var i in e){if(e.hasOwnProperty(i))a[i]=A(e[i])}return a}return e}var R=function e(t){for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}if(E(t)){t.apply(void 0,n)}return n[0]};function T(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(D(r[0])){return e.apply(void 0,r)}return function(t){return e(t,r[0])}}}var U=["minlength","maxlength","max","min","required","pattern","step"];function I(e){return U.indexOf(e.toLowerCase())>-1}var H=function e(t){try{var r=new Function("origin","global","return typeof ".concat(t," === 'number' || (typeof ").concat(t," !== 'undefined' && !(origin in global)) ? ").concat(t," : origin"));return r(t,P)}catch(e){return t}};function L(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}var n=t[0],a=t[1],i=t[2];y(typeof a==="string","The second parameter(".concat(JSON.stringify(a),") of parsePath() must be a string."));var u=(a.match(k)||[]).map(function(e){return e.replace(/\s/g,"")});var o=a.split(k).map(function(e){return e.trim()}).filter(function(e){return e!==""});var s=n;try{if(t.length<3){for(var l=0,$=o.length;l<$;l++){var f=H(o[l]);if(l+1===$){return s[f]}if(S(s[f])){break}s=s[f]}}else{for(var c=0,d=o.length;c<d;c++){var v=H(o[c]);var p=o[c+1];var h=u[c];if(S(p)){s[v]=i;break}switch(h){case"].":case".":s=S(s[v])?s[v]={}:s[v];break;case"][":case"[":var m=H(p);s=S(s[v])?s[v]=typeof m==="number"&&m>=0?[]:{}:s[v];break;default:s[v]=i;break}}}}catch(e){y(false,"The name '%s' of Field seems is not a legal expression.",a)}if(t.length>2){return n}}function M(e,t){var r=t.split(k).map(function(e){return e.trim()}).filter(function(e){return e!==""});for(var n=0,a=r.length;n<a;n++){var i=H(r[n]);if(!(i in e)){break}if(n+1===a){return{data:e[i]}}e=e[i]}}function B(e,t){if(e){if(E(e)){e(t)}else if("current"in e){e.current=t}}}var Y=function e(t,r){for(var n=0,a=t.length;n<a;n++){if(r(t[n])===true){return t[n]}}};var z=function e(t,r){return Object.keys(t).reduce(function(e,n){e[n]=r(t[n],n,t);return e},{})};var Q=function e(t,r){return Object.keys(t).forEach(function(e){return r(t[e],e,t)})};var G=function e(t,r){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return t.reduce(function(){r.apply(void 0,arguments);return arguments.length<=0?undefined:arguments[0]},n)};var q=undefined;function K(e,t,r){Q(e,function(t,r){if(t===q){delete e[r]}else if(x(t)||Array.isArray(t)){K(t,r,e)}});if(r&&Object.keys(e).every(function(t){return e[t]===q})){r[t]=q;K(r)}}var W=function e(t,r){if(!S(L(t,r))){L(t,r,q);K(t)}};var J="FORM_VALIDATE_RESULT";var X,Z;if(typeof requestAnimationFrame==="function"){X=requestAnimationFrame;Z=cancelAnimationFrame}else{X=setTimeout;Z=clearTimeout}var ee={render:m.func,component:N,children:function e(t){var r=m.oneOfType([m.func,m.node]);if(!t.render&&!t.component){r=r.isRequired}for(var n=arguments.length,a=new Array(n>1?n-1:0),i=1;i<n;i++){a[i-1]=arguments[i]}return r.apply(void 0,[t].concat(a))},$defaultValues:m.oneOfType([m.object,m.func]),$defaultStates:m.oneOfType([m.object,m.func]),$onFormChange:m.func,$validator:m.func,$processer:m.func,$ref:m.oneOfType([m.func,m.shape({current:m.any})])};var te=function(f){l(p,f);function p(i){var l;a(this,p);l=u(this,o(p).call(this,i));l.$$formPending=void 0;l.$$formValidatePromise=void 0;l.$$registers={};l.$$deepRegisters={};l.getFormContext=function(){return{$$registers:l.$$registers,$$register:l.$$register,$$unregister:l.$$unregister,$$onChange:l.$$onChange,$$getDefault:l.$$getDefault,$formutil:l.$formutil}};l.$$regDuplications={};l.$$duplicateTimer=void 0;l.$$checkDuplication=function(){var e=s(l),t=e.$$regDuplications;var r;Q(t,function(e,a){var i=n(e,2),u=i[0],o=i[1];y(u.$$reserved,"The Field with a name '".concat(a,"' has been registered!"));o.$$reset(u.$getState());r=delete t[a]});if(r){l.$render()}};l.$$register=function(e,t,r){l.$$unregister(r,t);if(e){var n=l.$$getRegister(e);if(n){Z(l.$$duplicateTimer);l.$$regDuplications[e]=[n,t];l.$$duplicateTimer=X(l.$$checkDuplication)}else{l.$$fieldChangedQueue.push({name:e,$newValue:t.$getState().$value});W(l.$$defaultValues,e)}l.$$registers[t.$name=e]=t;l.createDeepRegisters();l.$render()}};l.$$unregister=function(e,t,r){if(e){if(e in l.$$regDuplications){var a=n(l.$$regDuplications[e],2),i=a[0],u=a[1];l.$$fieldChangedQueue.push({name:e,$newValue:u.$getState().$value,$prevValue:i.$getState().$value});delete l.$$regDuplications[e]}else if(l.$$registers[e]===t){if(r){t.$$reserved=true}else{delete l.$$registers[e];l.$$fieldChangedQueue.push({name:e,$prevValue:t.$getState().$value});W(l.$$defaultValues,e)}}l.createDeepRegisters();l.$render()}};l.$$defaultInitialize=function(){var e=l.props,t=e.$defaultValues,r=e.$defaultStates;l.$$defaultValues=l.$$deepParseObject(A(E(t)?t(l.props)||{}:t));l.$$defaultStates=l.$$deepParseObject(A(E(r)?r(l.props)||{}:r))};l.$$getDefault=function(){return{$$defaultStates:l.$$defaultStates,$$defaultValues:l.$$defaultValues}};l.$$triggerChangeTimer=void 0;l.$$fieldChangedQueue=[];l.$$triggerFormChange=function(){if(l.$$fieldChangedQueue.length){var e=r(l.$$fieldChangedQueue);l.$$fieldChangedQueue.length=0;var t={};var n={};var a=l.$$registers;var i=false;e.forEach(function(e){if(!(e.name in a)){delete e.$newValue}if(e.$newValue!==e.$prevValue){if("$newValue"in e&&"$prevValue"in e){var r=l.$$getRegister(e.name);if(r){r.$$triggerChange(e)}}"$newValue"in e&&L(t,e.name,e.$newValue);"$prevValue"in e&&L(n,e.name,e.$prevValue);i=true}});if(i){if(E(l.props.$validator)){l.$$formValidate()}if(E(l.props.$onFormChange)){l.props.$onFormChange(l.$formutil,t,n)}}}};l.createDeepRegisters=function(){return l.$$deepRegisters=l.$$deepParseObject(l.$$registers)};l.$$getRegister=function(e){if(e){var t=l.$$registers[e]||L(l.$$deepRegisters,e);if(t){return t}}};l.$$formValidate=function(e){return l.$$formValidatePromise=new Promise(function(t){var r=l.props.$validator;var n;var a;var i;var u;var o=r(l.$formutil.$params,l.formtutil);var s=function r(n){return t(R(e,R(i,n)))};if(j(o)){if(!l.$$formPending){l.$$formPending=true;l.$render()}a=function e(t){return n=t(s)};u=o.then(function(){return void 0},function(e){return e}).then(function(e){if(n){return n}l.$shouldCancelPrevAsyncValidate=null;l.$$formPending=false;return l.$$setFormErrors(e,s)})}else{if(l.$$formPending){l.$$formPending=false}u=l.$$setFormErrors(o,s)}if(l.$shouldCancelPrevAsyncValidate){l.$shouldCancelPrevAsyncValidate(function(e){i=e;return u})}l.$shouldCancelPrevAsyncValidate=a})};l.$$setFormErrors=function(r,n){if(r&&(r instanceof Error||typeof r!=="object")){y(false,"The result of $validator in <Form /> should always return None(null,undefined) or an object contains error message of Field.");return l.$render(n)}return l.$$setStates(r||{},function(r,n){var a=n.$getState(),i=a.$error,u=i===void 0?{}:i;if(r){return{$error:t({},u,e({},J,r))}}if(u[J]){delete u[J];return{$error:u}}return},n,true)};l.$getField=function(e){var t=l.$$getRegister(e);y(!e||t,"$getField('".concat(e,"') fail to find the matched Field. Maybe it has been unmounted."));y(e,"You should pass a name of the mounted Field to $getField().");if(t){return t.$new()}};l.$$onChange=function(t,r,n){return l.$setStates(e({},t,r),n)};l.$$setStates=function(){var e=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var t=arguments.length>1?arguments[1]:undefined;var r=arguments.length>2?arguments[2]:undefined;var n=arguments.length>3?arguments[3]:undefined;var a=l.$$deepParseObject(e);Q(l.$$registers,function(e,r){var i;if(n||(i=M(a,r))){var u=t(i&&i.data,e);if(u){var o=l.$formutil.$weakParams[r];var s=e.$$merge(u),$=s.$value;e.$$detectChange(u);if("$value"in u||"$viewValue"in u){var f=Y(l.$$fieldChangedQueue,function(e){return e.name===r});if(f){if(!("$prevValue"in f)){f.$prevValue=f.$newValue}f.$newValue=$}else{l.$$fieldChangedQueue.push({name:r,$newValue:$,$prevValue:o})}}}}});return l.$render(r)};l.$render=function(e){return new Promise(function(t){return l.forceUpdate(function(){return t(R(e,l.$formutil))})})};l.$validates=function(){var e;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}if(E(r[r.length-1])){e=r.pop()}if(r.length){var a=function e(t){t.forEach(function(t){if(Array.isArray(t)){e(t)}else{var r=l.$getField(t);if(r){r.$validate()}}})};a(r)}else{Q(l.$$registers,function(e){return e.$validate()});if(E(l.props.$validator)){l.$$formValidate()}}return l.$onValidates(e)};l.$onValidates=function(e){var t=Object.keys(l.$$registers).map(function(e){return l.$$registers[e].$onValidate()});t.push(l.$$formValidatePromise);return Promise.all(t).then(function(){return R(e,l.$formutil)})};l.$validate=function(e,t){var r=l.$getField(e);if(r){return r.$validate(t)}return R(t)};l.$reset=function(e,t){l.$$defaultInitialize();if(E(e)){t=e;e={}}return l.$$setStates(e,function(e,t){return t.$$reset(e)},t,true)};l.$setStates=function(e,t){return l.$$setStates(e,function(e){return e},t)};l.$setValues=function(e,t){l.$$deepParseObject(A(e),l.$$defaultValues);K(l.$$defaultValues);return l.$$setStates(e,function(e){return{$value:e}},t)};l.$setFocuses=function(e,t){return l.$$setStates(e,function(e){return{$focused:e}},t)};l.$setDirts=function(e,t){return l.$$setStates(e,function(e){return{$dirty:e}},t)};l.$setTouches=function(e,t){return l.$$setStates(e,function(e){return{$touched:e}},t)};l.$setPendings=function(e,t){return l.$$setStates(e,function(e){return{$pending:e}},t)};l.$setErrors=function(e,t){return l.$$setStates(e,function(e){return{$error:e}},t)};l.$batchState=function(e,t){return l.$setStates(z(l.$$registers,function(){return e}),t)};l.$batchDirty=function(e,t){return l.$batchState({$dirty:e},t)};l.$batchTouched=function(e,t){return l.$batchState({$touched:e},t)};l.$batchFocused=function(e,t){return l.$batchState({$focused:e},t)};l.$batchPending=function(e,t){return l.$batchState({$pending:e},t)};l.$batchError=function(e,t){return l.$batchState({$error:e},t)};l.$$defaultInitialize();return l}i(p,[{key:"$$deepParseObject",value:function e(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};Q(t,function(e,t){return L(r,t,e)});return r}},{key:"componentDidMount",value:function e(){B(this.props.$ref,this.$formutil)}},{key:"componentDidUpdate",value:function e(t){var r=this;B(this.props.$ref,this.$formutil);Z(this.$$triggerChangeTimer);this.$$triggerChangeTimer=X(function(){r.$$triggerFormChange()})}},{key:"componentWillUnmount",value:function e(){B(this.props.$ref,null)}},{key:"_render",value:function e(){var t=this.$formutil;var r=this.props,n=r.children,a=r.render,i=r.component;if(i){return c(i,{$formutil:t})}if(E(a)){return a(t)}if(E(n)){return n(t)}return d.map(n,function(e){return e&&D(e.type)?v(e,{$formutil:t}):e})}},{key:"render",value:function e(){var r=this;var n=this.props.$processer;var a=Object.keys(this.$$registers).map(function(e){return{path:e,$state:r.$$registers[e].$getState()}});var i=G(a,function(e,t){var r=t.path,a=t.$state;if(n){n(a,r)}if("$value"in a&&(a.$dirty||!S(a.$value))){e[r]=a.$value}});var u=G(a,function(e,t){var r=t.path,n=t.$state;return r in i&&L(e,r,i[r])});var o=a.some(function(e){var t=e.$state;return t.$invalid});var s=a.some(function(e){var t=e.$state;return t.$dirty});var l=a.some(function(e){var t=e.$state;return t.$touched});var f=a.some(function(e){var t=e.$state;return t.$focused});var c=this.$$formPending||a.some(function(e){var t=e.$state;return t.$pending});var d=this.$formutil={$$registers:t({},this.$$registers),$$deepRegisters:this.$$deepRegisters,$states:G(a,function(e,t){var r=t.path,n=t.$state;return L(e,r,n)}),$params:t({},this.$$defaultValues,{},u),$errors:G(a,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){L(e,r,n.$error)}}),$dirts:G(a,function(e,t){var r=t.path,n=t.$state;return L(e,r,n.$dirty)}),$touches:G(a,function(e,t){var r=t.path,n=t.$state;return L(e,r,n.$touched)}),$focuses:G(a,function(e,t){var r=t.path,n=t.$state;return L(e,r,n.$focused)}),$pendings:G(a,function(e,t){var r=t.path,n=t.$state;return L(e,r,n.$pending)}),$weakStates:G(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n}),$weakParams:i,$weakErrors:G(a,function(e,t){var r=t.path,n=t.$state;if(n.$invalid){e[r]=n.$error}}),$weakDirts:G(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$dirty}),$weakTouches:G(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$touched}),$weakFocuses:G(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$focused}),$weakPendings:G(a,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$pending}),$getFirstError:function e(t){if(t){var r=d.$getField(t);return r&&r.$getFirstError()}for(var n in d.$weakErrors){if(d.$weakErrors.hasOwnProperty(n)){var a=d.$weakErrors[n];for(var i in a){if(a.hasOwnProperty(i)){return a[i]instanceof Error?a[i].message:a[i]}}}}},$render:this.$render,$getField:this.$getField,$onValidates:this.$onValidates,$new:function e(){return r.$formutil},$setStates:this.$setStates,$setValues:this.$setValues,$setErrors:this.$setErrors,$setTouches:this.$setTouches,$setDirts:this.$setDirts,$setFocuses:this.$setFocuses,$batchState:this.$batchState,$batchTouched:this.$batchTouched,$batchDirty:this.$batchDirty,$batchFocused:this.$batchFocused,$reset:this.$reset,$validates:this.$validates,$validate:this.$validate,$valid:!o,$invalid:o,$dirty:s,$pristine:!s,$touched:l,$untouched:!l,$focused:f,$pending:c};return $.createElement(w.Provider,{value:this.getFormContext},this._render())}}]);return p}(p);te.displayName="React.Formutil.Form";te.defaultProps={$defaultValues:{},$defaultStates:{}};var re=Object.keys(ee);function ne(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=function(n){l(s,n);function s(){var t;var r;a(this,s);for(var n=arguments.length,i=new Array(n),l=0;l<n;l++){i[l]=arguments[l]}r=u(this,(t=o(s)).call.apply(t,[this].concat(i)));r.renderChildren=function(t){return $.createElement(e,Object.assign({},r.othersProps,{$formutil:t,ref:r.props.__forwardRef__}))};return r}i(s,[{key:"render",value:function e(){var n=Object.assign({},this.props);var a=this.props,i=a.component,u=b(a,["component"]);re.forEach(function(e){if(e in n){if(e==="$defaultStates"||e==="$defaultValues"){u[e]=t({},r[e],{},n[e])}delete n[e]}});this.othersProps=n;return $.createElement(te,Object.assign({},r,u,{render:this.renderChildren}))}}]);return s}(p);n.displayName="React.Formutil.withForm."+(e.displayName||e.name||"Anonymous");var s=h(function(e,t){return $.createElement(n,Object.assign({__forwardRef__:t},e))});s.displayName="React.Formutil.withForm.ForwardRef."+(e.displayName||e.name||"Anonymous");return V(s,e)}var ae=T(ne);var ie=0;var ue={$valid:true,$invalid:false,$dirty:false,$pristine:true,$touched:false,$untouched:true,$focused:false,$pending:false,$error:{}};function oe(e){return e!==true}function se(e,t,r){y(!S(e),"You should return a string or Error when the validation('".concat(r&&r+": ").concat(t,"') failed, otherwise return true."))}var le=undefined;var $e="React.Formutil.Field";function fe(){return ie++}function ce(e,t){var r=t.children,n=t.render,a=t.component;if(a){return c(a,{$fieldutil:e})}if(E(n)){return n(e)}if(E(r)){return r(e)}return d.map(r,function(t){return t&&D(t.type)?v(t,{$fieldutil:e}):t})}function de(e,r){var n={$$FIELD_UUID:e.$$FIELD_UUID,$$reset:s,$$merge:b,$$detectChange:i,$$triggerChange:u,$onValidate:o,$new:function t(){return e.$fieldutil},$picker:l,$getState:l,$getComponent:function e(){return r},$reset:function t(r,n){return e.$setState(s(r),n)},$getFirstError:y,$validate:$,$setState:e.$setState,$render:f,$setValue:c,$setTouched:d,$setDirty:v,$setFocused:p,$setValidity:m,$setError:h,$setPending:g};var a;function i(e){if("$value"in e||"$viewValue"in e){$()}}function u(t){var r=t.$newValue,n=t.$prevValue;var a=e.props.$onFieldChange;if(E(a)){a(r,n,e.$formContext.$formutil)}}function o(e){a.then(e);return a}function s(r){var n;var a=e.props,i=e.$formContext;if(i.$$getDefault){var u=a.name;var o=i.$$getDefault(),s=o.$$defaultStates,l=o.$$defaultValues;if(u&&l){var $=L(l,u);n=L(s,u)||{};if(!S($)){n.$value=$}}}var f=a.$defaultValue,c=a.$defaultState;return b(t({},ue,{},E(c)?c(a):c,{$value:E(f)?f(a):"$defaultValue"in a?f:""},n,{},r))}function l(){return t({},e.$state)}function $(r){return a=new Promise(function(n){var a=e.props,i=e.$formContext;var u=t({},a.$validators,{},a.$asyncValidators);var o=e.$state,s=o.$value,l=o.$pending,$=Object.assign({},o.$error);var f=i.$formutil;var c={};var d=false;var v;var p;var y;var b;delete $[J];var V=Object.keys(u).reduce(function(r,n){delete $[n];if(!d&&a[n]!=null){var i=u[n](s,a[n],t({},a,{$formutil:f,$fieldutil:e.$fieldutil,$validError:c}));if(j(i)){r.push(i["catch"](function(e){if(!v){m(n,e||n)}}))}else if(oe(i)){c[n]=i||n;se(i,n,a.name);if(a.$validateLazy){d=true}}}return r},[]);var F=function e(t){return n(R(r,R(y,t)))};if(V.length){if(!l){g(true)}p=function e(t){return v=t(F)};V.push(h(t({},$,{},c)));b=Promise.all(V).then(function(){if(v){return v}e.$shouldCancelPrevAsyncValidate=null;return g(false,F)})}else{if(l){g(false)}b=h(t({},$,{},c),F)}if(e.$shouldCancelPrevAsyncValidate){e.$shouldCancelPrevAsyncValidate(function(e){y=e;return b})}e.$shouldCancelPrevAsyncValidate=p})}function f(t,r){return e.$setState({$viewValue:t,$dirty:true},r)}function c(t,r){return e.$setState({$value:t},r)}function d(t,r){return e.$setState({$touched:t},r)}function v(t,r){return e.$setState({$dirty:t},r)}function p(t,r){return e.$setState({$focused:t},r)}function h(t,r){return e.$setState({$error:t},r)}function m(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var n=arguments.length>2?arguments[2]:undefined;var a=Object.assign({},e.$state.$error);if(oe(r)){a[t]=r||t;se(r,t,e.props.name)}else{delete a[t]}return h(a,n)}function g(t,r){return e.$setState({$pending:t},r)}function y(){var t=e.$state.$error,r=t===void 0?{}:t;for(var n in r){if(r.hasOwnProperty(n)){return r[n]instanceof Error?r[n].message:r[n]}}}function b(r){var n=Object.assign({},r);if("$error"in n){if(!n.$error){n.$error={}}n.$valid=Object.keys(n.$error).length===0}var a=e.props,i=a.$parser,u=a.$formatter;if("$viewValue"in n&&!("$value"in n)){var o=function e(t){return n.$viewValue=t};n.$value=i?i(n.$viewValue,o):n.$viewValue}else if("$value"in n&&!("$viewValue"in n)){var s=function e(t){return n.$value=t};n.$viewValue=u?u(n.$value,s):n.$value}if("$valid"in n){n.$invalid=!n.$valid}else if("$invalid"in n){n.$dirty=!n.$invalid}if("$dirty"in n){n.$pristine=!n.$dirty}else if("$pristine"in n){n.$dirty=!n.$pristine}if("$touched"in n){n.$untouched=!n.$touched}else if("$untouched"in n){n.$touched=!n.$untouched}e.$state=t({},e.$state,{},n);return l()}return n}var ve=function(e){l(r,e);function r(){var e;var t;a(this,r);for(var n=arguments.length,i=new Array(n),s=0;s<n;s++){i[s]=arguments[s]}t=u(this,(e=o(r)).call.apply(e,[this].concat(i)));t.$$FIELD_UUID=fe();t.$formContext=void 0;t.$state=void 0;t.$setState=function(e,r){return new Promise(function(n){var a=function e(){return n(R(r,t.$fieldutil))};if(t.isMounting){var i=t.props.name;if(i in(t.$formContext.$$registers||{})){t.$formContext.$$onChange(i,e,a)}else{t.$registered.$$merge(e);t.$registered.$$detectChange(e);t.forceUpdate(a)}}else{t.$registered.$$merge(e);a()}})};return t}i(r,[{key:"componentDidMount",value:function e(){this.isMounting=true;var t=this.props.name,r=this.$formContext;y(!t||r.$formutil,"You should enusre that the <Field /> with the name '".concat(t,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));y(t,"You should assign a name to <Field />, otherwise it will be isolated!");if(r.$$register){r.$$register(t,this.$fieldHandler)}this.$prevState=this.$state;B(this.props.$ref,this.$fieldutil)}},{key:"componentWillUnmount",value:function e(){if(this.$formContext.$$unregister){this.$formContext.$$unregister(this.props.name,this.$fieldHandler,this.props.$reserveOnUnmount)}this.isMounting=false;B(this.props.$ref,null)}},{key:"componentDidUpdate",value:function e(t){var r=this.props.name;if(r!==t.name){if(this.$formContext.$$register){this.$formContext.$$register(r,this.$fieldHandler,t.name)}}B(this.props.$ref,this.$fieldutil);if(this.$state.$value!==this.$prevState.$value){if(!(r in(this.$formContext.$$registers||{}))){this.$registered.$$triggerChange({$newValue:this.$state.$value,$prevValue:this.$prevState.$value})}}this.$prevState=this.$state}},{key:"shouldComponentUpdate",value:function e(t){if(this.props.$renderLazy){return!F(t,this.props)||!F(this.$registered.$getState(),this.$prevState)}return true}},{key:"_render",value:function e(){var r=this.$fieldutil=t({$name:this.props.name},this.$registered.$getState(),{},this.$registered,{$$formutil:this.$formContext.$formutil});return ce(r,this.props)}},{key:"render",value:function e(){var t=this;return $.createElement(w.Consumer,null,function(e){var r=!t.$formContext;t.$formContext=e();if(!t.$fieldHandler){t.$fieldHandler=de(t,t)}t.$registered=(t.$formContext.$$registers||{})[t.$fieldHandler.$name]||t.$fieldHandler;if(r){t.$fieldHandler.$$reset();t.$fieldHandler.$validate()}return t._render()})}}]);return r}(p);ve.displayName=$e;var pe=Object.keys(le);function he(e){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=function(n){l(s,n);function s(){var t;var r;a(this,s);for(var n=arguments.length,i=new Array(n),l=0;l<n;l++){i[l]=arguments[l]}r=u(this,(t=o(s)).call.apply(t,[this].concat(i)));r.renderChildren=function(t){return $.createElement(e,Object.assign({},r.othersProps,{$fieldutil:t,ref:r.props.__forwardRef__}))};return r}i(s,[{key:"render",value:function e(){var n=Object.assign({},this.props);var a=this.props,i=a.component,u=b(a,["component"]);pe.concat(Object.keys(t({},r.$validators,{},r.$asyncValidators,{},n.$validators,{},n.$asyncValidators))).forEach(function(e){if(e in n){if(e==="$validators"||e==="$asyncValidators"||e==="$defaultState"){u[e]=t({},r[e],{},n[e])}delete n[e]}});this.othersProps=n;return $.createElement(ve,Object.assign({},r,u,{render:this.renderChildren}))}}]);return s}(p);n.displayName="React.Formutil.withField."+(e.displayName||e.name||"Anonymous");var s=h(function(e,t){return $.createElement(n,Object.assign({__forwardRef__:t},e))});s.displayName="React.Formutil.withField.ForwardRef."+(e.displayName||e.name||"Anonymous");return V(s,e)}var me=T(he);var ge=function(e){l(t,e);function t(){a(this,t);return u(this,o(t).apply(this,arguments))}i(t,[{key:"render",value:function e(){var t=this;var r=this.props,n=r.$fieldutil,a=r.value,i=r.onChange,u=r.onFocus,o=r.onBlur,s=r.checked,l=r.unchecked,f=b(r,["$fieldutil","value","onChange","onFocus","onBlur","checked","unchecked"]);var c=this.props.type;var d={value:"compositionValue"in this?this.compositionValue:a,onCompositionEnd:function e(r){t.composition=false;delete t.compositionValue;d.onChange(r)},onCompositionStart:function e(){return t.composition=true},onChange:function e(r){var n=r.target.value;if(t.composition){t.compositionValue=n;t.forceUpdate()}else{i(n,r)}},onFocus:u,onBlur:o};var v="input";switch(c){case"select":v=c;d.onChange=function(e){var t=e.target;var r=t.multiple?[].slice.call(t.options).filter(function(e){return e.selected}).map(function(e){return e.value}):t.value;i(r,e)};delete f.type;break;case"textarea":v=c;delete f.type;break;case"checkbox":case"radio":d={checked:a===s,onChange:function e(t){i(t.target.checked?s:l,t)},onFocus:u,onBlur:o};break}return $.createElement(v,Object.assign({},f,d))}}]);return t}(p);ge.displayName="React.Formutil.EasyField.Native";ge.defaultProps={value:"",type:"text",checked:true,unchecked:false};var ye=f(function(){return{}}),be=ye.Provider,Ve=ye.Consumer;var Fe=function(e){l(t,e);function t(){var e;var r;a(this,t);for(var n=arguments.length,i=new Array(n),s=0;s<n;s++){i[s]=arguments[s]}r=u(this,(e=o(t)).call.apply(e,[this].concat(i)));r.getGroupContext=function(){return r.props};return r}i(t,[{key:"_render",value:function e(){var t=this.props,r=t.className,n=t.groupNode,a=t.children;var i={GroupOption:we,Field:Ce};var u=E(a)?a(i):d.map(a,function(e){return v(e,i)});if(n===null){return u}return $.createElement(n,{className:r},u)}},{key:"render",value:function e(){return $.createElement(be,{value:this.getGroupContext},this._render())}}]);return t}(p);Fe.displayName="React.Formutil.EasyField.Group";Fe.defaultProps={type:"checkbox",groupNode:"div"};var we=function(e){l(t,e);function t(){a(this,t);return u(this,o(t).apply(this,arguments))}i(t,[{key:"componentDidMount",value:function e(){y("$value"in this.props,"You should pass a $value to <GroupOption />.")}},{key:"render",value:function e(){var t=this.props,r=t.$value,n=t.onChange,a=t.onFocus,i=t.onBlur,u=b(t,["$value","onChange","onFocus","onBlur"]);return $.createElement(Ve,null,function(e){var t=e();var o=t.type,s=t.name;var l=o==="radio"?{checked:t.value===r,onChange:function e(a){t.onChange(r,a);n&&n(a)}}:o==="checkbox"?{checked:t.value.indexOf(r)>-1,onChange:function e(a){t.onChange(a.target.checked?t.value.concat(r):t.value.filter(function(e){return e!==r}),a);n&&n(a)}}:{value:t.value,onChange:function e(r){t.onChange(r);n&&n(r)}};return $.createElement("input",Object.assign({name:s},u,l,{type:o,onFocus:function e(r){t.onFocus(r);a&&a(r)},onBlur:function e(r){t.onBlur(r);i&&i(r)}}))})}}]);return t}(p);we.displayName="React.Formutil.EasyField.Group.Option";var Ce=function(e){l(t,e);function t(){a(this,t);return u(this,o(t).apply(this,arguments))}i(t,[{key:"componentDidMount",value:function e(){y(false,'The "Field" property in EasyField\'s children-props has been deprecated. Please use "GroupOption" instead.')}},{key:"render",value:function e(){return $.createElement(we,this.props)}}]);return t}(p);Ce.displayName="React.Formutil.EasyField.Group.Option.Deprecated";var ke=$.Frament||"div";var Pe=function(e){l(r,e);function r(e){var t;a(this,r);t=u(this,o(r).call(this,e));t.id=0;t.latestValue=t.props.value;t.$formutil=void 0;t.FieldValidators={required:function e(t){return t!==null}};t.$onFormChange=function(e){e.$onValidates(function(e){var r=e.$invalid,n=e.$params;if(r){if(t.props.value.length){t.props.onChange(t.latestValue=[])}}else if(!F(t.props.value,n.list)){t.props.onChange(t.latestValue=n.list)}})};t.swap=function(e,r,n){return t.$setState(function(t){var n=t.items;var a=[n[e],n[r]];n[r]=a[0];n[e]=a[1];return n},n)};t.insert=function(){var e,r,n;for(var a=arguments.length,i=new Array(a),u=0;u<a;u++){i[u]=arguments[u]}i.forEach(function(t){if(E(t)){n=t}else if(typeof t==="number"){e=t}else if(typeof t==="object"){r=t}});return t.$setState(function(n){var a=n.items;if(S(e)){a.push(t.getId(r))}else{a.splice(e,0,t.getId(r))}return{items:a}},n)};t.remove=function(){var e,r;for(var n=arguments.length,a=new Array(n),i=0;i<n;i++){a[i]=arguments[i]}a.forEach(function(t){if(E(t)){r=t}else if(typeof t==="number"){e=t}});return t.$setState(function(r){var n=r.items;if(S(e)){n.pop()}else{n.splice(e,1)}if(!n.length){n=[t.getId()]}return{items:n}},r)};t.$setState=function(e,r){return new Promise(function(n){return t.setState(e,function(){return t.$formutil.$onValidates(function(e){return n(R(r,e))})})})};t.state={items:e.value.length?e.value.map(function(){return t.getId()}):[t.getId()],formKey:0};return t}i(r,[{key:"componentDidUpdate",value:function e(t){var r=this;if(this.props.value!==this.latestValue){this.setState({items:this.props.value.length?this.props.value.map(function(){return r.getId()}):[this.getId()],formKey:this.state.formKey+1});this.latestValue=this.props.value}}},{key:"getId",value:function e(t){return{id:this.id++,values:t}}},{key:"render",value:function e(){var r=this;var n=this.props,a=n.children,i=n.onFocus,u=n.onBlur,o=n.value;var s=this;if(!E(a)){return null}var l={$insert:this.insert,$remove:this.remove,$swap:this.swap,$push:function e(t,n){return r.insert(t,n)},$pop:function e(t){return r.remove(t)},$shift:function e(t){return r.remove(0,t)},$unshift:function e(t,n){return r.insert(0,t,n)},onFocus:i,onBlur:u};return $.createElement(te,{key:this.state.formKey,$defaultValues:{list:o},$onFormChange:this.$onFormChange,children:function e(n){r.$formutil=n;return $.createElement(ke,null,r.state.items.map(function(e,i){var u=e.id,o=e.values;return $.createElement(ve,{key:u,required:true,$defaultValue:o||null,$validators:r.FieldValidators,name:"list[".concat(i,"]"),children:function e(u){return $.createElement(te,{$defaultValues:u.$value||{},$onFormChange:function e(t){return t.$onValidates(function(e){var t=e.$invalid,r=e.$params;if(t){if(u.$viewValue!==null){u.$render(null)}}else if(!F(u.$viewValue,r)){u.$render(r)}})},children:function e(u){return a(t({get $length(){return s.state.items.length},$index:i,$isLast:function e(){return i===r.state.items.length-1},$isFirst:function e(){return i===0}},l,{},u),n)}})}})}))}})}}]);return r}(p);Pe.displayName="React.Formutil.EasyField.List";var Se="__TYPE__";var Ee=[["required",function(e,t,r){var n=r.__TYPE__,a=r.checked,i=a===void 0?true:a;return n==="checked"?e===i:!O(e)}],["maxLength",function(e,t){return O(e)||e.length<=t}],["minLength",function(e,t){return O(e)||e.length>=t}],["max",function(e,t){return O(e)||e*1<=t}],["min",function(e,t){return O(e)||e*1>=t}],["pattern",function(e,t){return O(e)||t.test(e)}],["enum",function(e,t){return O(e)||t.indexOf(e)>-1}],["checker",function(e,t,r){return t(e,r)}]].reduce(function(e,t){var r=n(t,2),a=r[0],i=r[1];e[a]=function e(t,r,n){var u=n.validMessage,o=u===void 0?{}:u;return i.apply(void 0,arguments)||o[a]||"Error input: ".concat(a)};return e},{});var Oe="React.Formutil.EasyField";var je={validMessage:{},valuePropName:"value",changePropName:"onChange",focusPropName:"onFocus",blurPropName:"onBlur",$parser:function e(t){return typeof t==="string"?t.trim():t}};function _e(r,n,a){var i;var u=n.valuePropName,o=n.changePropName,s=n.focusPropName,l=n.blurPropName,$=n.getValueFromEvent,f=n.passUtil;var c=function e(t){return t&&t.target?t.target[u]:t};var d=t({},a,(i={},e(i,u,r.$viewValue),e(i,o,function(e){var t;for(var a=arguments.length,i=new Array(a>1?a-1:0),u=1;u<a;u++){i[u-1]=arguments[u]}if(((t=i[0])===null||t===void 0?void 0:t.nativeEvent)instanceof Event){i.push(e)}else{i.unshift(e)}var s=n[o];s&&s.apply(void 0,i);var l=$?$.apply(void 0,i):c(e);r.$render(l)}),e(i,s,function(){var e=n[s];e&&e.apply(void 0,arguments);r.$setFocused(true)}),e(i,l,function(){var e=n[l];e&&e.apply(void 0,arguments);if(r.$untouched){r.$setTouched(true)}r.$setFocused(false)}),i));if(f){d[f===true?"$fieldutil":String(f)]=r}return d}function xe(e){var r=e.children,a=e.component,i=e.render,u=b(e,["children","component","render"]);var o=u.name,s=u.type,l=u.defaultValue,$=u.valuePropName,f=u.changePropName,c=u.focusPropName,d=u.blurPropName,v=u.getValueFromEvent,p=u.validMessage,h=u.checked,m=u.unchecked,g=u.__TYPE__,y=u.passUtil,V=u.$defaultValue,F=u.$defaultState,w=u.$onFieldChange,C=u.$validators,k=u.$asyncValidators,P=u.$validateLazy,E=u.$renderLazy,O=u.$reserveOnUnmount,j=u.$parser,_=u.$formatter,x=u.$ref,D=b(u,["name","type","defaultValue","valuePropName","changePropName","focusPropName","blurPropName","getValueFromEvent","validMessage","checked","unchecked","__TYPE__","passUtil","$defaultValue","$defaultState","$onFieldChange","$validators","$asyncValidators","$validateLazy","$renderLazy","$reserveOnUnmount","$parser","$formatter","$ref"]);var N={children:r,component:a,render:i};var A=!S(s)||S(r)&&S(a)&&S(i);Object.keys(t({},u.$validators=t({},Ee,{},u.$validators),{},u.$asyncValidators)).forEach(function(e){if(e in D){if(!A||!I(e)){delete D[e]}}});if(A){var R=(s||"").split("."),T=n(R,2),U=T[0],H=U===void 0?"text":U,L=T[1];N.component=H==="group"?Fe:H==="list"?Pe:ge;if(o){D.name=o}if(s){D.type=H}if(r){D.children=r}D.checked=h;D.unchecked=m;switch(H){case"select":case"textarea":if(e.multiple){u[Se]="array"}break;case"group":if(L==="checkbox"){u[Se]="array"}D.type=L;break;case"checkbox":case"radio":u[Se]="checked";break;case"list":u[Se]="array";break}}if(!("$defaultValue"in u)&&"defaultValue"in e){u.$defaultValue=l}if(!("$defaultValue"in u)&&Se in u){var M;switch(u[Se]){case"checked":var B=u.unchecked,Y=B===void 0?false:B;M=Y;break;case"array":M=[];break;case"object":M={};break;case"number":M=0;break}u.$defaultValue=M}return{fieldProps:u,childProps:D,renderProps:N}}function De(e,t){var r=t.component,n=t.render,a=t.children;if(r){return c(r,e)}if(E(n)){return n(e)}if(E(a)){return a(e)}return d.map(a,function(t){return v(t,e)})}var Ne=function(e){l(t,e);function t(){var e;var r;a(this,t);for(var n=arguments.length,i=new Array(n),s=0;s<n;s++){i[s]=arguments[s]}r=u(this,(e=o(t)).call.apply(e,[this].concat(i)));r.renderChildren=function(e){var t=r.parsedProps,n=t.fieldProps,a=t.childProps,i=t.renderProps;return De(_e(e,n,a),i)};r.parsedProps={};return r}i(t,[{key:"render",value:function e(){var t=this.parsedProps=xe(this.props),r=t.fieldProps;return $.createElement(ve,Object.assign({},r,{children:this.renderChildren}))}}]);return t}(p);Ne.displayName=Oe;Ne.defaultProps=je;function Ae(e){var t=h(function(t,r){return $.createElement(w.Consumer,null,function(n){return $.createElement(e,Object.assign({},t,{$formutil:n().$formutil,ref:r}))})});t.displayName="React.Formutil.connect."+(e.displayName||e.name||"Anonymous");return V(t,e)}function Re(){if(!$.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var e=$.useContext;var t=e(w);return t()}function Te(e){var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(!$.useState){throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.")}var i=$.useState,u=$.useLayoutEffect,o=$.useRef;var s;if(e){if(typeof e==="string"){s=e;a.name=s}else{a=e;s=a.name}}var l=Re();var f=o({}).current;var c=o([]);var d;f.$formContext=l;f.props=a;f.$setState=m;var v=i(function(){f.$$FIELD_UUID=fe();f.$fieldHandler=d=de(f);var e=f.$fieldHandler.$$reset();f.$fieldHandler.$validate();return e}),p=n(v,2),h=p[1];if(!d){d=(l.$$registers||{})[f.$fieldHandler.$name]||f.$fieldHandler}u(function(){var e=f.$state;if(f.isMounting){if(!(s in(l.$$registers||{}))){d.$$triggerChange({$newValue:e.$value,$prevValue:f.$prevState.$value})}}f.$prevState=e},[f.$state.$value]);u(function(){f.isMounting=true;y(!s||l.$formutil,"You should enusre that the useField() with the name '".concat(s,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated."));y(s,"You should pass a name argument to useField(), otherwise it will be isolated!");return function(){f.isMounting=false;B(a.$ref,null)}},[]);u(function(){if(l.$$register){l.$$register(s,f.$fieldHandler)}return function(){if(l.$$unregister){l.$$unregister(s,f.$fieldHandler,!f.isMounting&&a.$reserveOnUnmount)}}},[s]);u(function(){B(a.$ref,f.$fieldutil)});u(function(){if(c.current.length>0){var e=r(c.current);c.current.length=0;while(e.length){e.pop()(f.$fieldutil)}}});function m(e,t){return new Promise(function(r){var n=function e(){return r(R(t,f.$fieldutil))};if(f.isMounting){if(s in(l.$$registers||{})){l.$$onChange(s,e,n)}else{h(d.$$merge(e));d.$$detectChange(e);c.current.push(n)}}else{d.$$merge(e);n()}})}return f.$fieldutil=t({$name:s},d.$getState(),{},d,{$$formutil:l.$formutil})}function Ue(){var e=Re(),t=e.$formutil;return t}function Ie(e){e=t({},je,{},e,{children:null});var r=xe(e),n=r.fieldProps,a=r.childProps;var i=Te(n);return _e(i,n,a)}export{Ne as EasyField,ve as Field,te as Form,Ae as connect,w as formContext,Te as useField,Ue as useForm,Ie as useHandler,me as withField,ae as withForm};
