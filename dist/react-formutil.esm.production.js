import e,{createElement as t,Children as r,cloneElement as n,Component as i}from"react";import a from"prop-types";import o from"create-react-context";import u from"warning";import s from"hoist-non-react-statics";import $ from"react-fast-compare";function l(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},n=Object.keys(r);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),n.forEach(function(t){l(e,t,r[t])})}return e}function f(e){return function(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function d(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=[],n=!0,i=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done)&&(r.push(o.value),!t||r.length!==t);n=!0);}catch(e){i=!0,a=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw a}}return r}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),e}function m(e){return(m="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function g(e){return(g="function"===typeof Symbol&&"symbol"===m(Symbol.iterator)?function(e){return m(e)}:function(e){return e&&"function"===typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":m(e)})(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e,t){return!t||"object"!==g(t)&&"function"!==typeof t?y(e):t}function V(e){return(V=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function w(e,t){return(w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function F(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&w(e,t)}var C=o({}),P=Object.getPrototypeOf({}),S=/\s*(?:\]\s*\.|\]\s*\[|\.|\[|\])\s*/g,k=O(window)?global:window;function O(e){return"undefined"===typeof e}function E(e){return"function"===typeof e}function j(e){return O(e)||null===e||e+""===""}function x(e){return!!e&&E(e.then)}function D(e){return!!function(e){return"[object Object]"===Object.prototype.toString.call(e)}(e)&&(null===Object.getPrototypeOf(e)||!!E(e.constructor)&&e.constructor.prototype===P)}function N(e){if(e&&"object"===typeof e){if(Array.isArray(e)){for(var t=[],r=0,n=e.length;r<n;r++)t[r]=N(e[r]);return t}if(D(e)){var i={};for(var a in e)i[a]=N(e[a]);return i}}return e}var _=function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return E(e)&&e.apply(void 0,r),r[0]};function A(e){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];return E(r[0])?e.apply(void 0,r):function(t){return e(t,r[0])}}}var T=["minlength","maxlength","max","min","required","pattern","step"];var R,U,I=function(e){try{return new Function("origin","global","return typeof ".concat(e," === 'number' || (typeof ").concat(e," !== 'undefined' && !(origin in global)) ? ").concat(e," : origin"))(e,k)}catch(t){return e}},H=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];var n=t[0],i=t[1],a=t[2];u("string"===typeof i,"The second parameter(".concat(JSON.stringify(i),") of parsePath() must be a string."));var o=(i.match(S)||[]).map(function(e){return e.replace(/\s/g,"")}),s=i.split(S).map(function(e){return e.trim()}).filter(function(e){return""!==e}),$=n;try{if(t.length<3)for(var l=0,c=s.length;l<c;l++){var f=I(s[l]);if(l+1===c)return $[f];if(O($[f]))break;$=$[f]}else for(var d=0,p=s.length;d<p;d++){var h=I(s[d]),v=s[d+1],m=o[d];if(O(v)){$[h]=a;break}switch(m){case"].":case".":$=O($[h])?$[h]={}:$[h];break;case"][":case"[":var g=I(v);$=O($[h])?$[h]="number"===typeof g&&g>=0?[]:{}:$[h];break;default:$[h]=a}}}catch(e){u(!1,"The name '%s' of Field seems is not a legal expression.",i)}if(t.length>2)return n},L=function(e,t){for(var r=0,n=e.length;r<n;r++)if(!0===t(e[r]))return e[r]},M=function(e,t){return Object.keys(e).reduce(function(r,n){return r[n]=t(e[n],n,e),r},{})},B=function(e,t){return Object.keys(e).forEach(function(r){return t(e[r],r,e)})},Y=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.reduce(function(){return t.apply(void 0,arguments),arguments.length<=0?void 0:arguments[0]},r)},Q=function(e,t){O(H(e,t))||(H(e,t,void 0),function e(t,r,n){B(t,function(r,n){void 0===r?delete t[n]:r&&"object"===typeof r&&e(r,n,t)}),n&&Object.keys(t).every(function(e){return void 0===t[e]})&&(n[r]=void 0,e(n))}(e))},G="FORM_VALIDATE_RESULT";"function"===typeof requestAnimationFrame?(R=requestAnimationFrame,U=cancelAnimationFrame):(R=setTimeout,U=clearTimeout);var z=function(a){function o(e){var t;return p(this,o),(t=b(this,V(o).call(this,e))).$$formPending=void 0,t.$$formValidatePromise=void 0,t.$$registers={},t.$$deepRegisters={},t.$$regDuplications={},t.$$duplicateTimer=void 0,t.$$checkDuplication=function(){var e,r=y(t).$$regDuplications;B(r,function(t,n){var i=d(t,2),a=i[0],o=i[1];u(a.$$reserved,"The Field with a name '".concat(n,"' has been registered!")),o.$$reset(a.$getState()),e=delete r[n]}),e&&t.$render()},t.$$register=function(e,r,n){if(t.$$unregister(n,r),e){var i=t.$$getRegister(e);i?(U(t.$$duplicateTimer),t.$$regDuplications[e]=[i,r],t.$$duplicateTimer=R(t.$$checkDuplication)):(t.$$fieldChangedQueue.push({name:e,$newValue:r.$getState().$value}),Q(t.$$defaultValues,e)),t.$$registers[r.$name=e]=r,t.createDeepRegisters(),t.$render()}},t.$$unregister=function(e,r,n){if(e){if(e in t.$$regDuplications){var i=d(t.$$regDuplications[e],2),a=i[0],o=i[1];t.$$fieldChangedQueue.push({name:e,$newValue:o.$getState().$value,$prevValue:a.$getState().$value}),delete t.$$regDuplications[e]}else t.$$registers[e]===r&&(n?r.$$reserved=!0:(delete t.$$registers[e],t.$$fieldChangedQueue.push({name:e,$prevValue:r.$getState().$value}),Q(t.$$defaultValues,e)));t.createDeepRegisters(),t.$render()}},t.$$defaultInitialize=function(){var e=t.props,r=e.$defaultValues,n=e.$defaultStates;t.$$defaultValues=t.$$deepParseObject(N(E(r)?r(t.props)||{}:r)),t.$$defaultStates=t.$$deepParseObject(N(E(n)?n(t.props)||{}:n))},t.$$getDefault=function(){return{$$defaultStates:t.$$defaultStates,$$defaultValues:t.$$defaultValues}},t.$$triggerChangeTimer=void 0,t.$$fieldChangedQueue=[],t.$$triggerFormChange=function(){if(t.$$fieldChangedQueue.length){var e=f(t.$$fieldChangedQueue);t.$$fieldChangedQueue.length=0;var r={},n={},i=t.$$registers,a=!1;e.forEach(function(e){if(e.name in i||delete e.$newValue,e.$newValue!==e.$prevValue){if("$newValue"in e&&"$prevValue"in e){var o=t.$$getRegister(e.name);o&&o.$$triggerChange(e)}"$newValue"in e&&H(r,e.name,e.$newValue),"$prevValue"in e&&H(n,e.name,e.$prevValue),a=!0}}),a&&(E(t.props.$validator)&&t.$$formValidate(),E(t.props.$onFormChange)&&t.props.$onFormChange(t.$formutil,r,n))}},t.createDeepRegisters=function(){return t.$$deepRegisters=t.$$deepParseObject(t.$$registers)},t.$$getRegister=function(e){if(e){var r=t.$$registers[e]||H(t.$$deepRegisters,e);if(r)return r}},t.$$formValidate=function(e){return t.$$formValidatePromise=new Promise(function(r){var n,i,a,o,u=(0,t.props.$validator)(t.$formutil.$params,t.formtutil),s=function(t){return r(_(e,_(a,t)))};x(u)?(t.$$formPending||(t.$$formPending=!0,t.$render()),i=function(e){return n=e(s)},o=u.then(function(){},function(e){return e}).then(function(e){return n||(t.$shouldCancelPrevAsyncValidate=null,t.$$formPending=!1,t.$$setFormErrors(e,s))})):(t.$$formPending&&(t.$$formPending=!1),o=t.$$setFormErrors(u,s)),t.$shouldCancelPrevAsyncValidate&&t.$shouldCancelPrevAsyncValidate(function(e){return a=e,o}),t.$shouldCancelPrevAsyncValidate=i})},t.$$setFormErrors=function(e,r){return e&&(e instanceof Error||"object"!==typeof e)?(u(!1,"The result of $validator in <Form /> should always return None(null,undefined) or an object contains error message of Field."),t.$render(r)):t.$$setStates(e||{},function(e,t){var r=t.$getState().$error,n=void 0===r?{}:r;return e?{$error:c({},n,l({},G,e))}:n[G]?(delete n[G],{$error:n}):void 0},r,!0)},t.$getField=function(e){var r=t.$$getRegister(e);if(u(!e||r,"$getField('".concat(e,"') fail to find the matched Field. Maybe it has been unmounted.")),u(e,"You should pass a name of the mounted Field to $getField()."),r)return r.$new()},t.$$onChange=function(e,r,n){return t.$setStates(l({},e,r),n)},t.$$setStates=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,a=t.$$deepParseObject(e),o=!1;return B(t.$$registers,function(n,u){var s=u in e?e[u]:H(a,u);if(!O(s)||i){var $=r(s,n);if($){var l=t.$formutil.$weakParams[u],c=n.$$merge($).$value;if(n.$$detectChange($),"$value"in $||"$viewValue"in $){var f=L(t.$$fieldChangedQueue,function(e){return e.name===u});f?("$prevValue"in f||(f.$prevValue=f.$newValue),f.$newValue=c):t.$$fieldChangedQueue.push({name:u,$newValue:c,$prevValue:l})}o=!0}}}),o?t.$render(n):Promise.resolve(_(n,t.$formutil))},t.$render=function(e){return new Promise(function(r){return t.forceUpdate(function(){return r(_(e,t.$formutil))})})},t.$validates=function(){for(var e,r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];if(E(n[n.length-1])&&(e=n.pop()),n.length){!function e(r){r.forEach(function(r){if(Array.isArray(r))e(r);else{var n=t.$getField(r);n&&n.$validate()}})}(n)}else B(t.$$registers,function(e){return e.$validate()}),E(t.props.$validator)&&t.$$formValidate();return t.$onValidates(e)},t.$onValidates=function(e){var r=Object.keys(t.$$registers).map(function(e){return t.$$registers[e].$onValidate()});return r.push(t.$$formValidatePromise),Promise.all(r).then(function(){return _(e,t.$formutil)})},t.$validate=function(e,r){var n=t.$getField(e);return n?n.$validate(r):_(r)},t.$reset=function(e,r){return t.$$defaultInitialize(),E(e)&&(r=e,e={}),t.$$setStates(e,function(e,t){return t.$$reset(e)},r,!0)},t.$setStates=function(e,r){return t.$$setStates(e,function(e){return e},r)},t.$setValues=function(e,r){return t.$$deepParseObject(N(e),t.$$defaultValues),t.$$setStates(e,function(e){return{$value:e}},r)},t.$setFocuses=function(e,r){return t.$$setStates(e,function(e){return{$focused:e}},r)},t.$setDirts=function(e,r){return t.$$setStates(e,function(e){return{$dirty:e}},r)},t.$setTouches=function(e,r){return t.$$setStates(e,function(e){return{$touched:e}},r)},t.$setPendings=function(e,r){return t.$$setStates(e,function(e){return{$pending:e}},r)},t.$setErrors=function(e,r){return t.$$setStates(e,function(e){return{$error:e}},r)},t.$batchState=function(e,r){return t.$setStates(M(t.$$registers,function(){return e}),r)},t.$batchDirty=function(e,r){return t.$batchState({$dirty:e},r)},t.$batchTouched=function(e,r){return t.$batchState({$touched:e},r)},t.$batchFocused=function(e,r){return t.$batchState({$focused:e},r)},t.$batchPending=function(e,r){return t.$batchState({$pending:e},r)},t.$batchError=function(e,r){return t.$batchState({$error:e},r)},t.$$defaultInitialize(),t}return F(o,i),v(o,[{key:"getFormContext",value:function(){return{$$registers:this.$$registers,$$register:this.$$register,$$unregister:this.$$unregister,$$onChange:this.$$onChange,$$getDefault:this.$$getDefault,$formutil:this.$formutil}}},{key:"$$deepParseObject",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return B(e,function(e,r){return H(t,r,e)}),t}},{key:"componentDidUpdate",value:function(){var e=this;U(this.$$triggerChangeTimer),this.$$triggerChangeTimer=R(function(){e.$$triggerFormChange()})}},{key:"_render",value:function(){var e=this.$formutil,i=this.props,a=i.children,o=i.render,u=i.component;return u?t(u,{$formutil:e}):E(o)?o(e):E(a)?a(e):r.map(a,function(t){return t&&E(t.type)?n(t,{$formutil:e}):t})}},{key:"render",value:function(){var t=this,r=this.props.$processer,n=Object.keys(this.$$registers).map(function(e){return{path:e,$state:t.$$registers[e].$getState()}}),i=Y(n,function(e,t){var n=t.path,i=t.$state;r&&r(i,n),"$value"in i&&(i.$dirty||!O(i.$value))&&(e[n]=i.$value)}),a=Y(n,function(e,t){var r=t.path;t.$state;return r in i&&H(e,r,i[r])}),o=n.some(function(e){return e.$state.$invalid}),u=n.some(function(e){return e.$state.$dirty}),s=n.some(function(e){return e.$state.$touched}),$=n.some(function(e){return e.$state.$focused}),l=this.$$formPending||n.some(function(e){return e.$state.$pending}),f=this.$formutil={$$registers:c({},this.$$registers),$$deepRegisters:this.$$deepRegisters,$states:Y(n,function(e,t){var r=t.path,n=t.$state;return H(e,r,n)}),$params:c({},this.$$defaultValues,a),$errors:Y(n,function(e,t){var r=t.path,n=t.$state;n.$invalid&&H(e,r,n.$error)}),$dirts:Y(n,function(e,t){var r=t.path,n=t.$state;return H(e,r,n.$dirty)}),$touches:Y(n,function(e,t){var r=t.path,n=t.$state;return H(e,r,n.$touched)}),$focuses:Y(n,function(e,t){var r=t.path,n=t.$state;return H(e,r,n.$focused)}),$pendings:Y(n,function(e,t){var r=t.path,n=t.$state;return H(e,r,n.$pending)}),$weakStates:Y(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n}),$weakParams:i,$weakErrors:Y(n,function(e,t){var r=t.path,n=t.$state;n.$invalid&&(e[r]=n.$error)}),$weakDirts:Y(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$dirty}),$weakTouches:Y(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$touched}),$weakFocuses:Y(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$focused}),$weakPendings:Y(n,function(e,t){var r=t.path,n=t.$state;return e[r]=n.$pending}),$getFirstError:function(e){if(e){var t=f.$getField(e);return t&&t.$getFirstError()}for(var r in f.$weakErrors){var n=f.$weakErrors[r];for(var i in n)return n[i]instanceof Error?n[i].message:n[i]}},$render:this.$render,$getField:this.$getField,$onValidates:this.$onValidates,$new:function(){return t.$formutil},$setStates:this.$setStates,$setValues:this.$setValues,$setErrors:this.$setErrors,$setTouches:this.$setTouches,$setDirts:this.$setDirts,$setFocuses:this.$setFocuses,$batchState:this.$batchState,$batchTouched:this.$batchTouched,$batchDirty:this.$batchDirty,$batchFocused:this.$batchFocused,$reset:this.$reset,$validates:this.$validates,$validate:this.$validate,$valid:!o,$invalid:o,$dirty:u,$pristine:!u,$touched:s,$untouched:!s,$focused:$,$pending:l};return e.createElement(C.Provider,{value:this.getFormContext()},this._render())}}]),o}();function q(e,t){if(null==e)return{};var r,n,i=function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}z.displayName="React.Formutil.Form",z.defaultProps={$defaultValues:{},$defaultStates:{}};var K=A(function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=function(n){function a(){return p(this,a),b(this,V(a).apply(this,arguments))}return F(a,i),v(a,[{key:"render",value:function(){var n=Object.assign({},this.props),i=this.props,a=(i.component,q(i,["component"]));return["$defaultStates","$defaultValues","$onFormChange","$validator","$processer"].forEach(function(e){e in n&&("$defaultStates"!==e&&"$defaultValues"!==e||(a[e]=c({},r[e],n[e])),delete n[e])}),e.createElement(z,Object.assign({},r,a,{render:function(r){return e.createElement(t,Object.assign({},n,{$formutil:r}))}}))}}]),a}();return n.displayName="React.Formutil.withForm."+(t.displayName||t.name||"Anonymous"),s(n,t)}),J=0,W={$valid:!0,$invalid:!1,$dirty:!1,$pristine:!0,$touched:!1,$untouched:!0,$focused:!1,$pending:!1,$error:{}};function X(e){return!0!==e}function Z(e,t,r){u(!O(e),"You should return a string or Error when the validation('".concat(r&&r+": ").concat(t,"') failed, otherwise return true."))}a.string,a.any,a.oneOfType([a.object,a.func]),a.func,a.object,a.object,a.bool,a.bool,a.func,a.func,a.func,a.func;function ee(){return J++}function te(e,t){var r;function n(t){var r,n=e.props,i=e.$formContext;if(i.$$getDefault){var a=n.name,o=i.$$getDefault(),u=o.$$defaultStates,s=o.$$defaultValues;if(a&&s){var l=H(s,a);r=H(u,a)||{},O(l)||(r.$value=l)}}var f=n.$defaultValue,d=n.$defaultState;return $(c({},W,E(d)?d(n):d,{$value:E(f)?f(n):"$defaultValue"in n?f:""},r,t))}function i(){return c({},e.$state)}function a(t){return r=new Promise(function(r){var n,i,a,$,l=e.props,f=e.$formContext,d=c({},l.$validators,l.$asyncValidators),p=e.$state,h=p.$value,v=p.$pending,m=Object.assign({},p.$error),g=f.$formutil,y={},b=!1;delete m[G];var V=Object.keys(d).reduce(function(t,r){if(delete m[r],!b&&null!=l[r]){var i=d[r](h,l[r],c({},l,{$formutil:g,$fieldutil:e.$fieldutil,$validError:y}));x(i)?t.push(i.catch(function(e){n||u(r,e||r)})):X(i)&&(y[r]=i||r,Z(i,r,l.name),l.$validateLazy&&(b=!0))}return t},[]),w=function(e){return r(_(t,_(a,e)))};V.length?(v||s(!0),i=function(e){return n=e(w)},V.push(o(c({},m,y))),$=Promise.all(V).then(function(){return n||(e.$shouldCancelPrevAsyncValidate=null,s(!1,w))})):(v&&s(!1),$=o(c({},m,y),w)),e.$shouldCancelPrevAsyncValidate&&e.$shouldCancelPrevAsyncValidate(function(e){return a=e,$}),e.$shouldCancelPrevAsyncValidate=i})}function o(t,r){return e.$setState({$error:t},r)}function u(t){var r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=arguments.length>2?arguments[2]:void 0,i=Object.assign({},e.$state.$error);return X(r)?(i[t]=r||t,Z(r,t,e.props.name)):delete i[t],o(i,n)}function s(t,r){return e.$setState({$pending:t},r)}function $(t){var r=Object.assign({},t);"$error"in r&&(r.$error||(r.$error={}),r.$valid=0===Object.keys(r.$error).length);var n=e.props,a=n.$parser,o=n.$formatter;if("$viewValue"in r&&!("$value"in r)){r.$value=a?a(r.$viewValue,function(e){return r.$viewValue=e}):r.$viewValue}else if("$value"in r&&!("$viewValue"in r)){r.$viewValue=o?o(r.$value,function(e){return r.$value=e}):r.$value}return"$valid"in r?r.$invalid=!r.$valid:"$invalid"in r&&(r.$dirty=!r.$invalid),"$dirty"in r?r.$pristine=!r.$dirty:"$pristine"in r&&(r.$dirty=!r.$pristine),"$touched"in r?r.$untouched=!r.$touched:"$untouched"in r&&(r.$touched=!r.$untouched),e.$state=c({},e.$state,r),i()}return{$$FIELD_UUID:e.$$FIELD_UUID,$$reset:n,$$merge:$,$$detectChange:function(e){("$value"in e||"$viewValue"in e)&&a()},$$triggerChange:function(t){var r=t.$newValue,n=t.$prevValue,i=e.props.$onFieldChange;E(i)&&i(r,n,e.$formContext.$formutil)},$onValidate:function(e){return r.then(e),r},$new:function(){return e.$fieldutil},$picker:i,$getState:i,$getComponent:function(){return t},$reset:function(t,r){return e.$setState(n(t),r)},$getFirstError:function(){var t=e.$state.$error,r=void 0===t?{}:t;for(var n in r)return r[n]instanceof Error?r[n].message:r[n]},$validate:a,$setState:e.$setState,$render:function(t,r){return e.$setState({$viewValue:t,$dirty:!0},r)},$setValue:function(t,r){return e.$setState({$value:t},r)},$setTouched:function(t,r){return e.$setState({$touched:t},r)},$setDirty:function(t,r){return e.$setState({$dirty:t},r)},$setFocused:function(t,r){return e.$setState({$focused:t},r)},$setValidity:u,$setError:o,$setPending:s}}var re=function(a){function o(){var e,t;p(this,o);for(var r=arguments.length,n=new Array(r),i=0;i<r;i++)n[i]=arguments[i];return(t=b(this,(e=V(o)).call.apply(e,[this].concat(n)))).$$FIELD_UUID=ee(),t.$formContext=void 0,t.$state=void 0,t.$setState=function(e,r){return new Promise(function(n){var i=function(){return n(_(r,t.$fieldutil))};if(t.isMounting){var a=t.props.name;a in(t.$formContext.$$registers||{})?t.$formContext.$$onChange(a,e,i):(t.$registered.$$merge(e),t.$registered.$$detectChange(e),t.forceUpdate(i))}else t.$registered.$$merge(e),i()})},t}return F(o,i),v(o,[{key:"componentDidMount",value:function(){this.isMounting=!0;var e=this.props.name,t=this.$formContext;u(!e||t.$formutil,"You should enusre that the <Field /> with the name '".concat(e,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated.")),u(e,"You should assign a name to <Field />, otherwise it will be isolated!"),t.$$register&&t.$$register(e,this.$fieldHandler),this.$prevValue=this.$state.$value}},{key:"componentWillUnmount",value:function(){this.$formContext.$$unregister&&this.$formContext.$$unregister(this.props.name,this.$fieldHandler,this.props.$reserveOnUnmount),this.isMounting=!1}},{key:"componentDidUpdate",value:function(e){var t=this.props.name;t!==e.name&&this.$formContext.$$register&&this.$formContext.$$register(t,this.$fieldHandler,e.name),this.$state.$value!==this.$prevValue&&(t in(this.$formContext.$$registers||{})||this.$registered.$$triggerChange({$newValue:this.$state.$value,$prevValue:this.$prevValue}),this.$prevValue=this.$state.$value)}},{key:"_render",value:function(){return function(e,i){var a=i.children,o=i.render,u=i.component;return u?t(u,{$fieldutil:e}):E(o)?o(e):E(a)?a(e):r.map(a,function(t){return t&&E(t.type)?n(t,{$fieldutil:e}):t})}(this.$fieldutil=c({$name:this.props.name},this.$registered.$getState(),this.$registered,{$$formutil:this.$formContext.$formutil}),this.props)}},{key:"render",value:function(){var t=this,r=!this.$formContext;return e.createElement(C.Consumer,null,function(e){return t.$formContext=e,t.$fieldHandler||(t.$fieldHandler=te(t,t)),t.$registered=(e.$$registers||{})[t.$fieldHandler.$name]||t.$fieldHandler,r&&(t.$fieldHandler.$$reset(),t.$fieldHandler.$validate()),t._render()})}}]),o}();re.displayName="React.Formutil.Field";var ne=A(function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=function(n){function a(){return p(this,a),b(this,V(a).apply(this,arguments))}return F(a,i),v(a,[{key:"render",value:function(){var n=Object.assign({},this.props),i=this.props,a=(i.component,q(i,["component"]));return["$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$defaultValue","$defaultState","$onFieldChange","$parser","$formatter","name"].concat(Object.keys(c({},r.$validators,r.$asyncValidators,n.$validators,n.$asyncValidators))).forEach(function(e){e in n&&("$validators"!==e&&"$asyncValidators"!==e&&"$defaultState"!==e||(a[e]=c({},r[e],n[e])),delete n[e])}),e.createElement(re,Object.assign({},r,a,{render:function(r){return e.createElement(t,Object.assign({},n,{$fieldutil:r}))}}))}}]),a}();return n.displayName="React.Formutil.withField."+(t.displayName||t.name||"Anonymous"),s(n,t)}),ie=function(t){function r(){return p(this,r),b(this,V(r).apply(this,arguments))}return F(r,i),v(r,[{key:"render",value:function(){var t=this,r=this.props,n=(r.$fieldutil,r.value),i=r.onChange,a=r.onFocus,o=r.onBlur,u=r.checked,s=r.unchecked,$=q(r,["$fieldutil","value","onChange","onFocus","onBlur","checked","unchecked"]),l=this.props.type,c={value:"compositionValue"in this?this.compositionValue:n,onCompositionEnd:function(e){t.composition=!1,delete t.compositionValue,c.onChange(e)},onCompositionStart:function(){return t.composition=!0},onChange:function(e){var r=e.target.value;t.composition?(t.compositionValue=r,t.forceUpdate()):i(r,e)},onFocus:a,onBlur:o},f="input";switch(l){case"select":f=l,c.onChange=function(e){var t=e.target,r=t.multiple?[].slice.call(t.options).filter(function(e){return e.selected}).map(function(e){return e.value}):t.value;i(r,e)},delete $.type;break;case"textarea":f=l,delete $.type;break;case"checkbox":case"radio":c={checked:n===u,onChange:function(e){i(e.target.checked?u:s,e)},onFocus:a,onBlur:o}}return e.createElement(f,Object.assign({},$,c))}}]),r}();ie.displayName="React.Formutil.EasyField.Native",ie.defaultProps={value:"",type:"text",checked:!0,unchecked:!1};var ae=o({}),oe=ae.Provider,ue=ae.Consumer,se=function(t){function a(){return p(this,a),b(this,V(a).apply(this,arguments))}return F(a,i),v(a,[{key:"getGroupContext",value:function(){return this.props}},{key:"_render",value:function(){var t=this.props,i=t.className,a=t.groupNode,o=t.children,u={GroupOption:$e,Field:le},s=E(o)?o(u):r.map(o,function(e){return n(e,u)});return null===a?s:e.createElement(a,{className:i},s)}},{key:"render",value:function(){return e.createElement(oe,{value:this.getGroupContext()},this._render())}}]),a}();se.displayName="React.Formutil.EasyField.Group",se.defaultProps={type:"checkbox",groupNode:"div"};var $e=function(t){function r(){return p(this,r),b(this,V(r).apply(this,arguments))}return F(r,i),v(r,[{key:"componentDidMount",value:function(){u("$value"in this.props,"You should pass a $value to <GroupOption />.")}},{key:"render",value:function(){var t=this.props,r=t.$value,n=t.onChange,i=t.onFocus,a=t.onBlur,o=q(t,["$value","onChange","onFocus","onBlur"]);return e.createElement(ue,null,function(t){var u=t.type,s=t.name,$="radio"===u?{checked:t.value===r,onChange:function(e){t.onChange(r,e),n&&n(e)}}:"checkbox"===u?{checked:t.value.indexOf(r)>-1,onChange:function(e){t.onChange(e.target.checked?t.value.concat(r):t.value.filter(function(e){return e!==r}),e),n&&n(e)}}:{value:t.value,onChange:function(e){t.onChange(e),n&&n(e)}};return e.createElement("input",Object.assign({name:s},o,$,{type:u,onFocus:function(e){t.onFocus(e),i&&i(e)},onBlur:function(e){t.onBlur(e),a&&a(e)}}))})}}]),r}();$e.displayName="React.Formutil.EasyField.Group.Option";var le=function(t){function r(){return p(this,r),b(this,V(r).apply(this,arguments))}return F(r,i),v(r,[{key:"componentDidMount",value:function(){u(!1,'The "Field" property in EasyField\'s children-props has been deprecated. Please use "GroupOption" instead.')}},{key:"render",value:function(){return e.createElement($e,this.props)}}]),r}();le.displayName="React.Formutil.EasyField.Group.Option.Deprecated";var ce=e.Frament||"div",fe=function(t){function r(e){var t;return p(this,r),(t=b(this,V(r).call(this,e))).id=0,t.latestValue=t.props.value,t.$formutil=void 0,t.FieldValidators={required:function(e){return null!==e}},t.$onFormChange=function(e){e.$onValidates(function(e){var r=e.$invalid,n=e.$params;r?t.props.value.length&&t.props.onChange(t.latestValue=[]):$(t.props.value,n.list)||t.props.onChange(t.latestValue=n.list)})},t.swap=function(e,r,n){return t.$setState(function(t){var n=t.items,i=[n[e],n[r]];return n[r]=i[0],n[e]=i[1],n},n)},t.insert=function(){for(var e,r,n,i=arguments.length,a=new Array(i),o=0;o<i;o++)a[o]=arguments[o];return a.forEach(function(t){E(t)?n=t:"number"===typeof t?e=t:"object"===typeof t&&(r=t)}),t.$setState(function(n){var i=n.items;return O(e)?i.push(t.getId(r)):i.splice(e,0,t.getId(r)),{items:i}},n)},t.remove=function(){for(var e,r,n=arguments.length,i=new Array(n),a=0;a<n;a++)i[a]=arguments[a];return i.forEach(function(t){E(t)?r=t:"number"===typeof t&&(e=t)}),t.$setState(function(r){var n=r.items;return O(e)?n.pop():n.splice(e,1),n.length||(n=[t.getId()]),{items:n}},r)},t.$setState=function(e,r){return new Promise(function(n){return t.setState(e,function(){return t.$formutil.$onValidates(function(e){return n(_(r,e))})})})},t.state={items:e.value.length?e.value.map(function(){return t.getId()}):[t.getId()],formKey:0},t}return F(r,i),v(r,[{key:"componentDidUpdate",value:function(e){var t=this;this.props.value!==this.latestValue&&(this.setState({items:this.props.value.length?this.props.value.map(function(){return t.getId()}):[this.getId()],formKey:this.state.formKey+1}),this.latestValue=this.props.value)}},{key:"getId",value:function(e){return{id:this.id++,values:e}}},{key:"render",value:function(){var t=this,r=this.props,n=r.children,i=r.onFocus,a=r.onBlur,o=r.value;if(!E(n))return null;var u={$length:this.state.items.length,$insert:this.insert,$remove:this.remove,$swap:this.swap,$push:function(e,r){return t.insert(e,r)},$pop:function(e){return t.remove(e)},$shift:function(e){return t.remove(0,e)},$unshift:function(e,r){return t.insert(0,e,r)},onFocus:i,onBlur:a};return e.createElement(z,{key:this.state.formKey,$defaultValues:{list:o},$onFormChange:this.$onFormChange,children:function(r){return t.$formutil=r,e.createElement(ce,null,t.state.items.map(function(i,a){var o=i.id,s=i.values;return e.createElement(re,{key:o,required:!0,$defaultValue:s||null,$validators:t.FieldValidators,name:"list[".concat(a,"]"),children:function(i){return e.createElement(z,{$defaultValues:i.$value||{},$onFormChange:function(e){return e.$onValidates(function(e){var t=e.$invalid,r=e.$params;t?null!==i.$viewValue&&i.$render(null):$(i.$viewValue,r)||i.$render(r)})},children:function(e){return n(c({},u,e,{$index:a,$isLast:function(){return a===t.state.items.length-1},$isFirst:function(){return 0===a}}),r)}})}})}))}})}}]),r}();fe.displayName="React.Formutil.EasyField.List";var de="__TYPE__",pe=[["required",function(e,t,r){var n=r.__TYPE__,i=r.checked;return"checked"===n?e===(void 0===i||i):!j(e)}],["maxLength",function(e,t){return j(e)||e.length<=t}],["minLength",function(e,t){return j(e)||e.length>=t}],["max",function(e,t){return j(e)||1*e<=t}],["min",function(e,t){return j(e)||1*e>=t}],["pattern",function(e,t){return j(e)||t.test(e)}],["enum",function(e,t){return j(e)||t.indexOf(e)>-1}],["checker",function(e,t,r){return t(e,r)}]].reduce(function(e,t){var r=d(t,2),n=r[0],i=r[1];return e[n]=function(e,t,r){var a=r.validMessage,o=void 0===a?{}:a;return i.apply(void 0,arguments)||o[n]||"Error input: ".concat(n)},e},{}),he=(a.string,a.oneOfType([a.func,a.node]),a.func,a.func,a.any,a.object,a.string,a.string,a.string,a.string,a.string,{validMessage:{},valuePropName:"value",changePropName:"onChange",focusPropName:"onFocus",blurPropName:"onBlur",$parser:function(e){return"string"===typeof e?e.trim():e}});function ve(e,t,r){var n,i=t.valuePropName,a=t.changePropName,o=t.focusPropName,u=t.blurPropName,s=t.passUtil,$=c({},r,(l(n={},i,e.$viewValue),l(n,a,function(){for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];var u=n[0],s=n[n.length-1];s=s&&s.target?[s]:n;var $=t[a];$&&$.apply(void 0,f(s));var l=function(e){return e&&e.target?e.target[i]:e}(u);e.$render(l)}),l(n,o,function(){var r=t[o];r&&r.apply(void 0,arguments),e.$setFocused(!0)}),l(n,u,function(){var r=t[u];r&&r.apply(void 0,arguments),e.$untouched&&e.$setTouched(!0),e.$setFocused(!1)}),n));return s&&($[!0===s?"$fieldutil":s]=e),$}function me(e){var t=e.children,r=e.component,n=e.render,i=q(e,["children","component","render"]),a=i.name,o=i.type,u=i.defaultValue,s=(i.valuePropName,i.changePropName,i.focusPropName,i.blurPropName,i.validMessage,i.__TYPE__,i.passUtil,i.$defaultValue,i.$defaultState,i.$onFieldChange,i.$validators,i.$asyncValidators,i.$validateLazy,i.$reserveOnUnmount,i.$parser,i.$formatter,q(i,["name","type","defaultValue","valuePropName","changePropName","focusPropName","blurPropName","validMessage","__TYPE__","passUtil","$defaultValue","$defaultState","$onFieldChange","$validators","$asyncValidators","$validateLazy","$reserveOnUnmount","$parser","$formatter"])),$={children:t,component:r,render:n},l=!O(o)||O(t)&&O(r)&&O(n);if(Object.keys(c({},i.$validators=c({},pe,i.$validators),i.$asyncValidators)).forEach(function(e){e in s&&(l&&function(e){return T.indexOf(e.toLowerCase())>-1}(e)||delete s[e])}),l){var f=d((o||"").split("."),2),p=f[0],h=void 0===p?"text":p,v=f[1];switch($.component="group"===h?se:"list"===h?fe:ie,a&&(s.name=a),o&&(s.type=h),t&&(s.children=t),h){case"select":case"textarea":e.multiple&&(i[de]="array");break;case"group":"checkbox"===v&&(i[de]="array"),s.type=v;break;case"checkbox":case"radio":i[de]="checked";break;case"list":i[de]="array"}}if(!("$defaultValue"in i)&&"defaultValue"in e&&(i.$defaultValue=u),!("$defaultValue"in i)&&de in i){var m;switch(i[de]){case"checked":var g=i.unchecked;m=void 0!==g&&g;break;case"array":m=[];break;case"object":m={};break;case"number":m=0}i.$defaultValue=m}return{fieldProps:i,childProps:s,renderProps:$}}var ge=function(a){function o(){return p(this,o),b(this,V(o).apply(this,arguments))}return F(o,i),v(o,[{key:"render",value:function(){var i=me(this.props),a=i.fieldProps,o=i.childProps,u=i.renderProps;return e.createElement(re,Object.assign({},a,{children:function(e){return function(e,i){var a=i.component,o=i.render,u=i.children;return a?t(a,e):E(o)?o(e):E(u)?u(e):r.map(u,function(t){return n(t,e)})}(ve(e,a,o),u)}}))}}]),o}();function ye(t){var r=function(r){function n(){return p(this,n),b(this,V(n).apply(this,arguments))}return F(n,i),v(n,[{key:"render",value:function(){var r=this;return e.createElement(C.Consumer,null,function(n){return e.createElement(t,Object.assign({},r.props,{$formutil:n.$formutil}))})}}]),n}();return r.displayName="React.Formutil.connect."+(t.displayName||t.name||"Anonymous"),s(r,t)}function be(){if(!e.useState)throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.");return(0,e.useContext)(C)}function Ve(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!e.useState)throw new Error("Hooks api need react@>=16.8, Please upgrade your reactjs.");var n,i=e.useState,a=e.useLayoutEffect,o=e.useRef;t&&("string"===typeof t?(n=t,r.name=n):n=(r=t).name);var s,$=be(),l=o({}).current,p=o([]);l.$formContext=$,l.props=r,l.$setState=function(e,t){return new Promise(function(r){var i=function(){return r(_(t,l.$fieldutil))};l.isMounting?n in($.$$registers||{})?$.$$onChange(n,e,i):(h(s.$$merge(e)),s.$$detectChange(e),p.current.push(i)):(s.$$merge(e),i())})};var h=d(i(function(){l.$$FIELD_UUID=ee(),l.$fieldHandler=s=te(l);var e=l.$fieldHandler.$$reset();return l.$fieldHandler.$validate(),e}),2)[1];return s||(s=($.$$registers||{})[l.$fieldHandler.$name]||l.$fieldHandler),a(function(){var e=l.$state;if(l.isMounting&&!(n in($.$$registers||{}))){var t=l.$prevValue;s.$$triggerChange({$newValue:e.$value,$prevValue:t})}l.$prevValue=e.$value},[l.$state.$value]),a(function(){return l.isMounting=!0,u(!n||$.$formutil,"You should enusre that the useField() with the name '".concat(n,"' must be used underneath a <Form /> component or withForm() HOC, otherwise it's isolated.")),u(n,"You should pass a name argument to useField(), otherwise it will be isolated!"),function(){$.$$unregister&&$.$$unregister(n,l.$fieldHandler,r.$reserveOnUnmount),l.isMounting=!1}},[]),a(function(){$.$$register&&$.$$register(n,l.$fieldHandler,l.$prevName),l.$prevName=n},[n]),a(function(){if(p.current.length>0){var e=f(p.current);for(p.current.length=0;e.length;)e.pop()(l.$fieldutil)}}),l.$fieldutil=c({$name:n},s.$getState(),s,{$$formutil:$.$formutil})}function we(){return be().$formutil}function Fe(e){var t=me(e=c({},he,e,{children:null})),r=t.fieldProps,n=t.childProps;return ve(Ve(r),r,n)}ge.displayName="React.Formutil.EasyField",ge.defaultProps=he;export{ge as EasyField,re as Field,z as Form,ye as connect,Ve as useField,we as useForm,Fe as useHandler,ne as withField,K as withForm};
